[{"content":"VS Code allows us to connect to a remote envirnoment. This is very convenient especially for developing and testing code on cloud computing servers.\nHowever, starting with VS Code release 1.99 (March 2025), the prebuilt servers distributed by VS Code are only compatible with Linux distributions that are based on glibc 2.28 or later.\nThis create connection problems for users of Compute Canada. Specifically, connections to Graham and Niagara because of the no longer supported CentOS7 system.\nIn this article, I\u0026rsquo;ll show you all the steps I\u0026rsquo;ve done to establish a Remote Tunnel and connect to the server.\nOfficial Workaround (which is not fully working) Firstly I followed the VS Code official documentation, to prepare a sysroot, a patchelf and set the three environment variables.\nLong story short, it did not solve the problem but we still need these steps.\nI don\u0026rsquo;t want to repeate the steps mentioned in their official documentation, but several pitfalls worth mentioning:\nBuild and run the crosstool-ng command ct-ng build on a docker environment (the Dockerfile is provided on the documentation ), and compress the output x86_64-linux-gnu to send it to the server. Set the 3 environment variables in $HOME/.bash_profile (Here I put the output from ct-ng build (the extracted x86_64-linux-gnu folder) under $HOME/.local/share) 1 2 3 export VSCODE_SERVER_CUSTOM_GLIBC_LINKER=$HOME/.local/share/x86_64-linux-gnu/x86_64-linux-gnu/sysroot/lib64/ld-linux-x86-64.so.2 export VSCODE_SERVER_CUSTOM_GLIBC_PATH=$HOME/.local/share/x86_64-linux-gnu/x86_64-linux-gnu/sysroot/lib64 export VSCODE_SERVER_PATCHELF_PATH=$HOME/.local/bin/patchelf Remote tunnels After failure of the official workarounds from VS Code, I noticed the suggestions from The Alliance wiki:\nuse the \u0026ldquo;Remote Tunnels\u0026rdquo; extension by running \u0026lsquo;code tunnel\u0026rsquo; (google vscode cli and download it). Use github or a microsoft account (OAuth) and connect to a remote vscode server, such as a niagara login node. You can have all the \u0026ldquo;benefits\u0026rdquo; of not using mfa as long as your server is running.\nFirst thing is to download the VS Code CLI\n1 2 3 wget -O vscode-cli.tar.gz \u0026#34;https://code.visualstudio.com/sha/download?build=stable\u0026amp;os=cli-alpine-x64\u0026#34; tar -xzvf vscode-cli.tar.gz -C $HOME/.local/bin/ rm vscode-cli.tar.gz On remote server, run code tunnel to start.\nMake sure environment variables (echo $VSCODE_SERVER_CUSTOM_GLIBC_PATH to check) are set from previous steps. Otherwise you\u0026rsquo;ll get an error like this:\nManually download the vscode server package If you try to connect to the remote now, you will see the remote server keep crashing and on the remote server, vscode keeps downloading and extracting the server package.\nWhat is the reason for this issue?\nThere must be some errors when we are trying to run the vscode server script.\nCan we run it manually?\nHere @cvcore provided a script for manually downloading the vscode-server\nTo run that script, we need to know the commit_id.\nGo to your VS Code Client, on the top menu tabs, go to Help-\u0026gt;About and you can see the commit id.\n1 /bin/bash -c \u0026#34;$(curl -fsSL https://gist.githubusercontent.com/cvcore/8e187163f41a77f5271c26a870e52778/raw/download_vscode_server.sh)\u0026#34; -- \u0026lt;commit_id\u0026gt; Replace \u0026lt;commit_id\u0026gt; with your actual commit id, run this command and it will download the vscode-server into your $HOME/.vscode-server/bin/\u0026lt;commit_id\u0026gt; folder.\nRun vscode-server manually Now with the server downloaded in $HOME/.vscode-server/bin/\u0026lt;commit_id\u0026gt;, we can try to run it manually. But there will be an issue:\nIf you run the server with environment variables set, you can see the patchelf working but we still get an error:\nIf you run the server without environment variables set, you\u0026rsquo;ll also get an error:\nHere is the SOLUTION to this problem. On the alliance wiki, it says:\nIf you install pre-compiled binaries in your home directory they may fail using errors such as /lib64/libc.so.6: version 'GLIBC_2.18' not found. Often such binaries can be patched using our setrpaths.sh script, using the syntax setrpaths.sh --path path [--add_origin] where path refers to the directory where you installed that software.\nThe setrpaths.sh is hosted on their github repo here but you don\u0026rsquo;t need to download it. It\u0026rsquo;s in your PATH under the folder /cvmfs/soft.computecanada.ca/easybuild/bin/\nSo here we simply run the following command (replace \u0026lt;commit_id\u0026gt; with the actual one):\n1 setrpaths.sh --path $HOME/.vscode-server/bin/\u0026lt;commit_id\u0026gt; Modify the startup script From the last step, we start the server from executing ./code-server. This is just a shell script wrapping the node-js server executable:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 #!/usr/bin/env sh # # Copyright (c) Microsoft Corporation. All rights reserved. # case \u0026#34;$1\u0026#34; in --inspect*) INSPECT=\u0026#34;$1\u0026#34;; shift;; esac ROOT=\u0026#34;$(dirname \u0026#34;$(dirname \u0026#34;$(readlink -f \u0026#34;$0\u0026#34;)\u0026#34;)\u0026#34;)\u0026#34; # Set rpath before changing the interpreter path # Refs https://github.com/NixOS/patchelf/issues/524 if [ -n \u0026#34;$VSCODE_SERVER_CUSTOM_GLIBC_LINKER\u0026#34; ] \u0026amp;\u0026amp; [ -n \u0026#34;$VSCODE_SERVER_CUSTOM_GLIBC_PATH\u0026#34; ] \u0026amp;\u0026amp; [ -n \u0026#34;$VSCODE_SERVER_PATCHELF_PATH\u0026#34; ]; then echo \u0026#34;Patching glibc from $VSCODE_SERVER_CUSTOM_GLIBC_PATH with $VSCODE_SERVER_PATCHELF_PATH...\u0026#34; \u0026#34;$VSCODE_SERVER_PATCHELF_PATH\u0026#34; --set-rpath \u0026#34;$VSCODE_SERVER_CUSTOM_GLIBC_PATH\u0026#34; \u0026#34;$ROOT/node\u0026#34; echo \u0026#34;Patching linker from $VSCODE_SERVER_CUSTOM_GLIBC_LINKER with $VSCODE_SERVER_PATCHELF_PATH...\u0026#34; \u0026#34;$VSCODE_SERVER_PATCHELF_PATH\u0026#34; --set-interpreter \u0026#34;$VSCODE_SERVER_CUSTOM_GLIBC_LINKER\u0026#34; \u0026#34;$ROOT/node\u0026#34; echo \u0026#34;Patching complete.\u0026#34; fi \u0026#34;$ROOT/node\u0026#34; ${INSPECT:-} \u0026#34;$ROOT/out/server-main.js\u0026#34; \u0026#34;$@\u0026#34; Here you can see from line 14 to 20, it checkes the environment variables to patch glic and linker. We don\u0026rsquo;t need that so comment out or remove those lines. Otherwise, by default, with 3 environment variables set, patching will be done and we will get the FATAL: kernel too old error.\nPrepare everything in the correct path (replace \u0026lt;commit_id\u0026gt; with the actual one)\n1 2 3 4 5 6 7 8 COMMIT_ID=\u0026lt;commit_id\u0026gt; rm -rf $HOME/.vscode mkdir -p $HOME/.vscode/cli/servers/Stable-$COMMIT_ID cat \u0026lt;\u0026lt; EOF \u0026gt; $HOME/.vscode/cli/servers/lru.json [\u0026#34;Stable-$COMMIT_ID\u0026#34;] EOF cp -r $HOME/.vscode-server/bin/$COMMIT_ID $HOME/.vscode/cli/servers/Stable-$COMMIT_ID/server Now you can start a tmux session and run code tunnel to start the server.\nResults ","date":"2025-05-16T00:00:00Z","permalink":"https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/","title":"Workaround: VSCode Remote on Compute Canada CentOS7 Server"},{"content":"A few days ago, I got a MacBook Air (mid 2011) from a friend. The battery was died, but everything else is fine, despite it running extremly slowly.\nI tried to reinstall an older version of OS X system for it.\nThe first thing is to create a bootable USB drive for that. Following the instructions here and here, I\u0026rsquo;ve done this successfully.\nIt\u0026rsquo;s a completely a new (and a little complicated) experience for me. So I felt it\u0026rsquo;s necessary to write up the steps.\nPreparation dmg2img (in AUR) to convert Apple\u0026rsquo;s .dmg image format to .img kpartx (in multipath-tools package) to mount .img xar (in AUR) to extract .pkg InstallMacOSX.dmg or InstallESD.dmg A USB drive (refered to as /dev/sdX in the following contents) Steps Extract InstallESD.dmg from InstallMacOSX.dmg Do the following steps: 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 mkdir -p /mnt/OSX_InstallESD /mnt/OSX_BaseSystem /mnt/usbstick # convert installer disk image to raw format dmg2img \u0026#34;Install OS X \u0026lt;Version\u0026gt;.app/Contents/SharedSupport/InstallESD.dmg\u0026#34; InstallESD.img kpartx -a InstallESD.img mount /dev/mapper/loop0p2 /mnt/OSX_InstallESD # convert base system disk image to raw format dmg2img /mnt/OSX_InstallESD/BaseSystem.dmg BaseSystem.img kpartx -a BaseSystem.img mount /dev/mapper/loop1p1 /mnt/OSX_BaseSystem # partition the USB flash drive, /dev/sdX sgdisk -o /dev/sdX sgdisk -n 1:0:0 -t 1:AF00 -c 1:\u0026#34;disk image\u0026#34; -A 1:set:2 /dev/sdX mkfs.hfsplus -v \u0026#34;OS X Base System\u0026#34; /dev/sdX1 mount /dev/sdX1 /mnt/usbstick # copy installer files rsync -aAEHW /mnt/OSX_BaseSystem/ /mnt/usbstick/ rm -f /mnt/usbstick/System/Installation/Packages rsync -aAEHW /mnt/OSX_InstallESD/Packages /mnt/usbstick/System/Installation/ rsync -aAEHW /mnt/OSX_InstallESD/BaseSystem.chunklist /mnt/usbstick/ rsync -aAEHW /mnt/OSX_InstallESD/BaseSystem.dmg /mnt/usbstick/ sync In the final step, sync is to write all cached writes to persistent storage. It can go extremly slowly. To see the progress, you can look at /proc/meminfo to see Dirty sizes.\n1 watch -d grep -e Dirty: -e Writeback: /proc/meminfo (reference)\n","date":"2023-05-10T14:05:43+08:00","permalink":"https://cld4h.github.io/blog/p/making-a-bootable-macos-x-usb-on-archlinux/","title":"Making a bootable MacOS X USB on Archlinux"},{"content":"This article show you the ultimate way to set up a transparent proxy on Linux using clash and iptables to bypass the GFW in China.\nWe use:\nclash as the proxy software online subconverter and crontab to periodically update config file. ACL4SSR to provide GFW rules. You can go to github gist to download all files mentioned in this article.\nAll files you need:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 . â”œâ”€â”€ clash-base-config.yaml ---ğŸŸ¢base config for clash to work on tproxy and fake-ip mode â”œâ”€â”€ clash.service ---ğŸŸ¢systemd unit file to start up clash â”œâ”€â”€ clean.sh ---ğŸŸ¢script to clean iptables â”œâ”€â”€ config.ini ---ğŸŸ¢config file for subconverter â”œâ”€â”€ iptables.sh ---ğŸŸ¢iptables config file â”œâ”€â”€ update-config.sh ---ğŸŸ¡subscription update script; \u0026#34;XXXXXXXX\u0026#34; need to be replaced â”œâ”€â”€ config.yaml ---â­•clash config file, to be generated from update-config.sh â”œâ”€â”€ README.md â””â”€â”€ README.zh-cn.md ğŸŸ¢: Doesn\u0026#39;t need to change ğŸŸ¡: Needs to change â­•: Needs to be generated Reference clash-tproxy\nTransparent proxy demo code\nPrerequisite a clash installed. (By default in /usr/bin/clash) iptables systemd (It\u0026rsquo;s totally fine to use other init programs, but here I\u0026rsquo;ll only show the configuration of systemd, which is the default of most GNU/Linux distros.) crontab Steps Create a system user called clash 1 useradd -r -M -s /usr/sbin/nologin clash Since we want to proxy all internet traffics, we need to prevent the traffic from looping. Thus, we create a distinct user called clash (the name can be arbitrary) to run the proxy software clash. We\u0026rsquo;ll make an iptables rule in the following steps to distinguish traffic coming from the user clash.\nCreate iptables and routing rules Create a shell script of iptables command called /etc/clash/iptables.sh.\nThe file contains 3 main sections:\niptables rules to hijack the dns query traffic, config for clash chain config for clash_local chain iptables:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ PREROUTING INPUT â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ /â”€â”€â”€\\ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â” â”‚ / \\ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”¤â–ºâ”‚rawâ”œâ”€â–ºâ”‚conntrackâ”œâ”€â–ºâ”‚mangleâ”œâ”€â–ºâ”‚natâ”œâ”€â”¼â”€â”€â”€â”€â”€â”€â–º\u0026lt;routing\u0026gt;â”€â”€â”€â”€â”€â”€â”¤â–ºâ”‚mangleâ”œâ”€â–ºâ”‚filterâ”œâ”€â”¤â–ºâ”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚ \\ / â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ \\â”€â”¬â”€/ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚mangleâ—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ Network â”‚ â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚ â”‚ Local â”‚ â”‚Interfaceâ”‚ â”‚ â”‚ â”‚ FORWARD â”‚ Process â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â” â”‚ /â”€â”€â”€\\ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¤filterâ”‚ â”‚ / \\ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ \u0026lt;routing\u0026gt;â—„â”€â”¤ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ \\ / â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ \\â”€â”¬â”€/ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”€â”€â”€â”€â”€ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â” â”‚ / \\ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚â—„â”€â”¼â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”œâ”€â”€â”€\u0026lt;reroute\u0026gt;â”€â”€â”€â”¼â”€â”¤filterâ”‚â—„â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”€â”¤conntrackâ”‚â—„â”€â”¤rawâ”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ \\check/ â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”€â”€â”€â”€â”€ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ POSTROUTING OUTPUT â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ /etc/clash/iptables.sh\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 104 105 106 107 108 109 110 111 112 113 114 115 116 117 118 119 120 121 122 #!/usr/bin/env bash # set -ex options: # -e Exit immediately if a command exits with a non-zero status # -x Print commands and their arguments as they are executed. set -ex # ENABLE ipv4 forward sysctl -w net.ipv4.ip_forward=1 # ROUTE RULES ip rule add fwmark 666 table 666 ip route add local 0.0.0.0/0 table 666 dev lo ################################## ## hijack the dns query traffic ## ################################## # Redirect all dns query traffic from LAN to port 1053 # Later clash will return a fake ip in 198.18.0.1/16 iptables -t nat -I PREROUTING -p udp --dport 53 -j REDIRECT --to 1053 # same for ipv6 ip6tables -t nat -I PREROUTING -p udp --dport 53 -j REDIRECT --to 1053 # Redirect dns query traffic from all local processes (except owned by user clash) to port 1053 # Later clash will return a fake ip in 198.18.0.1/16 iptables -t nat -N clash_dns iptables -t nat -A OUTPUT -p udp --dport 53 -j clash_dns iptables -t nat -A clash_dns -m owner --uid-owner clash -j RETURN iptables -t nat -A clash_dns -p udp -j REDIRECT --to-ports 1053 # same for ipv6 ip6tables -t nat -N clash_dns ip6tables -t nat -A OUTPUT -p udp --dport 53 -j clash_dns ip6tables -t nat -A clash_dns -m owner --uid-owner clash -j RETURN ip6tables -t nat -A clash_dns -p udp -j REDIRECT --to-ports 1053 ############################## ## config for `clash` chain ## ############################## # `clash` chain for using tproxy to redirect traffic to the clash listening port 7893 iptables -t mangle -N clash # skip traffic to LAN or reserved address # reference: # https://en.wikipedia.org/wiki/List_of_assigned_/8_IPv4_address_blocks # https://en.wikipedia.org/wiki/Private_network#IPv4 # IANA - Local Identification iptables -t mangle -A clash -d 0.0.0.0/8 -j RETURN # IANA - Loopback iptables -t mangle -A clash -d 127.0.0.0/8 -j RETURN # IANA - Private Use iptables -t mangle -A clash -d 10.0.0.0/8 -j RETURN iptables -t mangle -A clash -d 172.16.0.0/12 -j RETURN iptables -t mangle -A clash -d 192.168.0.0/16 -j RETURN # IPv4 Link-Local Addresses iptables -t mangle -A clash -d 169.254.0.0/16 -j RETURN # Multicast iptables -t mangle -A clash -d 224.0.0.0/4 -j RETURN # Future Use iptables -t mangle -A clash -d 240.0.0.0/4 -j RETURN # Forward all the other traffic to port 7893 and set tproxy mark iptables -t mangle -A clash -p tcp -j TPROXY --on-port 7893 --tproxy-mark 666 iptables -t mangle -A clash -p udp -j TPROXY --on-port 7893 --tproxy-mark 666 # Append the `clash` chain to PREROUTING to enable it iptables -t mangle -A PREROUTING -j clash #################################### ## config for `clash_local` chain ## #################################### # `clash_local` chain to manipulate the traffic from local process: set fwmark 666 on traffic to public address # (which will later reroute to dev lo, then redirect to tproxy port 7893 on the `clash` chain of `PREROUTING`) iptables -t mangle -N clash_local # rerouting traffic from nerdctl container #iptables -t mangle -A clash_local -i nerdctl2 -p udp -j MARK --set-mark 666 #iptables -t mangle -A clash_local -i nerdctl2 -p tcp -j MARK --set-mark 666 # Don\u0026#39;t touch traffic to LAN and reserved address iptables -t mangle -A clash_local -d 0.0.0.0/8 -j RETURN iptables -t mangle -A clash_local -d 127.0.0.0/8 -j RETURN iptables -t mangle -A clash_local -d 10.0.0.0/8 -j RETURN iptables -t mangle -A clash_local -d 172.16.0.0/12 -j RETURN iptables -t mangle -A clash_local -d 192.168.0.0/16 -j RETURN iptables -t mangle -A clash_local -d 169.254.0.0/16 -j RETURN iptables -t mangle -A clash_local -d 224.0.0.0/4 -j RETURN iptables -t mangle -A clash_local -d 240.0.0.0/4 -j RETURN # set mark for local traffic # clash_local set mark for the traffic from local process, # the marked traffic will come back to PREROUTING chain. iptables -t mangle -A clash_local -p tcp -j MARK --set-mark 666 iptables -t mangle -A clash_local -p udp -j MARK --set-mark 666 # Don\u0026#39;t touch traffic from a serving port # https web server # iptables -t mangle -I OUTPUT -p tcp --sport 443 -j RETURN # transmission # iptables -t mangle -I OUTPUT -p tcp --sport 51413 -j RETURN # Don\u0026#39;t touch traffic from the user `clash` to prevent looping iptables -t mangle -A OUTPUT -p tcp -m owner --uid-owner clash -j RETURN iptables -t mangle -A OUTPUT -p udp -m owner --uid-owner clash -j RETURN # Append the `clash_local` chain to OUTPUT to enable it iptables -t mangle -A OUTPUT -j clash_local ####################### ## unimportant staff ## ####################### # fix ICMP(ping) # This step does NOT make the ping result validate # (clash doesn\u0026#39;t support forwarding ICMP), it just makes ping have a result. # set --to-destination to a accessable address. #sysctl -w net.ipv4.conf.all.route_localnet=1 #iptables -t nat -A PREROUTING -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1 #iptables -t nat -A OUTPUT -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1 After applying the script above, the system iptables should be like this:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ PREROUTING rule1* INPUT â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ /â”€â”€â”€\\ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”´â”€â” â”‚ / \\ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”œâ”€â”€â”¤â–ºâ”‚rawâ”œâ”€â–ºâ”‚conntrackâ”œâ”€â–ºâ”‚mangleâ”œâ”€â–ºâ”‚natâ”œâ”€â”¼â”€â”€â”€â”€â”€â”€â–º\u0026lt;routing\u0026gt;â”€â”€â”€â”€â”€â”€â”¤â–ºâ”‚mangleâ”œâ”€â–ºâ”‚filterâ”œâ”€â”¤â–ºâ”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚ \\ / â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ \\â”€â”¬â”€/ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”´â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚clashâ”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚mangleâ—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ Network â”‚ â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Local â”‚ â”‚Interfaceâ”‚ â”‚ â”‚ â”‚ FORWARD â”‚clash_localâ”‚ â”‚ Process â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â” â”‚ â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ /â”€â”€â”€\\ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¤filterâ”‚ â”‚ â”‚ / \\ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”œâ”€â”€â”€rule3* \u0026lt;routing\u0026gt;â—„â”€â”¤ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ \\ / â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”œâ”€â”€â”€rule2* \\â”€â”¬â”€/ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”€â”€â”€â”€â”€ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â” â”‚ / \\ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”´â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â” â”‚ â”‚ â”‚ â”‚ â”‚â—„â”€â”¼â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”œâ”€â”€â”€\u0026lt;reroute\u0026gt;â”€â”€â”€â”¼â”€â”¤filterâ”‚â—„â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”€â”¤conntrackâ”‚â—„â”€â”¤rawâ”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ \\check/ â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”¬â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”€â”€â”€â”€â”€ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚ â”‚ POSTROUTING â”‚ OUTPUT â”‚ â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â” â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚clash_dnsâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ *rule1: iptables -t nat -I PREROUTING -p udp --dport 53 -j REDIRECT --to 1053 *rule2: iptables -t mangle -A OUTPUT -p tcp -m owner --uid-owner clash -j RETURN *rule3: iptables -t mangle -A OUTPUT -p udp -m owner --uid-owner clash -j RETURN It\u0026rsquo;s also worth to take a look at the route rules in iptables.sh:\n1 2 ip rule add fwmark 666 table 666 ip route add local 0.0.0.0/0 table 666 dev lo ip rule manipulates rules in the routing policy database control the route selection algorithm.\nSo here the ip rule command make the kernel to lookup table 666 for packets with fwmark 666\nip rule reference is here.\nThe ip route command add a default route to device lo on routing table 666.\nWe can use ip route show table 666 to see the route added by ip route add local 0.0.0.0/0 table 666 dev lo See the route table value and name mapping: cat /etc/iproute2/rt_tables\nCreate a cleaning script Create a shell script to clean the iptables.\n-D or --delete:\nDelete one or more rules from the selected chain. There are two versions of this command: the rule can be specified as a number in the chain (starting at 1 for the first rule) or a rule to match.\n-F or --flush:\nFlush the selected chain (all the chains in the table if none is given). This is equivalent to deleting all the rules one by one.\n-X or --delete-chain:\nDelete the optional user-defined chain specified. There must be no references to the chain. If there are, you must delete or replace the referring rules before the chain can be deleted. The chain must be empty, i.e. not contain any rules. If no argument is given, it will attempt to delete every non-builtin chain in the table.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 #!/usr/bin/env bash set -ex ip rule del fwmark 666 table 666 || true ip route del local 0.0.0.0/0 table 666 dev lo || true iptables -t nat -D PREROUTING -p udp --dport 53 -j REDIRECT --to 1053 || true ip6tables -t nat -D PREROUTING -p udp --dport 53 -j REDIRECT --to 1053 || true iptables -t nat -D OUTPUT -p udp --dport 53 -j clash_dns || true ip6tables -t nat -D OUTPUT -p udp --dport 53 -j clash_dns || true iptables -t nat -F clash_dns || true iptables -t nat -X clash_dns || true ip6tables -t nat -F clash_dns || true ip6tables -t nat -X clash_dns || true #iptables -t nat -D PREROUTING -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1 #iptables -t nat -D OUTPUT -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1 iptables -t mangle -D PREROUTING -j clash || true iptables -t mangle -F clash || true iptables -t mangle -X clash || true iptables -t mangle -D OUTPUT -p tcp -m owner --uid-owner clash -j RETURN || true iptables -t mangle -D OUTPUT -p udp -m owner --uid-owner clash -j RETURN || true iptables -t mangle -D OUTPUT -j clash_local || true iptables -t mangle -F clash_local || true iptables -t mangle -X clash_local || true Fixing ping One major drawback of the fake-ip mode is that you can\u0026rsquo;t ping a fake ip.\nThe solution above to redirect all ping request to the localhost is \u0026ldquo;æ©è€³ç›—é“ƒ\u0026rdquo;, it doesn\u0026rsquo;t provide any useful information.\nSadly, all devices from LAN can\u0026rsquo;t use ping, but fortunately you can alias ping to sudo -u clash ping for this gateway to use ping.\n1 alias ping=\u0026#34;sudo -u clash ping\u0026#34; Provide a systemd unit file to start clash at a single command This step is optional, but I felt it\u0026rsquo;s extremely convenient to start clash by running a single command.\nYou can also make clash start at boot time.\nThe systemd config file is in the appended files with the name clash.service\nput it under /usr/lib/systemd/system, and run sudo systemctl start clash to start running clash.\nTo start it at boot time, run sudo systemctl enable clash.\nConfiguring clash Now let\u0026rsquo;s set clash up to work.\nClash use -d option to set configuration directory and -f option to specify configuration file.\nThe default configuration file name is config.yaml when -f is omitted.\nWe want to use crontab to periodically update the clash config from a subscription url.\nConstruct the subscription URL TL;DR. Just replace XXXXXXXX with your encoded subscription URL .\n1 https://sub.xeton.dev/sub?target=clash\u0026amp;new_name=true\u0026amp;filename=config.yaml\u0026amp;url=XXXXXXXX\u0026amp;config=https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini We use subconverter to generate config file for clash.\nYou need to change a few parameters in the subscription URL to generate a proper config file for clash to work in fake-ip mode.\nTo be specific:\nthe url parameter should be the correct subscription URL and encoded. Multiple subscription URL should be seperated by |, or %7C after URL Encoding. the config parameter should point to a correct configuration file. âš ï¸ âš ï¸ NOTICE: the configuration file for subconverter is extremely important!\nACL4SSR project provide a default configuration file for subconverter, it\u0026rsquo;s fine but NOT ENOUGH for clash to work on fake-ip mode.\nTo make it work, you need specify clash_rule_base by inserting this line to the configuration file for subconverter\n1 clash_rule_base=https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/clash-base-config.yaml What this line does is that it tells the subconverter to use the file in the url above instead of the default clash base configuration.\nOr you can just use the config.ini here\nSample url:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 https://sub.xeton.dev/sub? --- backend address target=clash --- client type \u0026amp;new_name=true --- create a new filename \u0026amp;filename=config.yaml --- filename \u0026amp;url= --- Node info ss%3A%2F%2FYmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg%23example-server %7C --- the delimiter | to seperate multiple urls ss%3A%2F%2FYmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg%23example-server-2 \u0026amp;config= --- config file for subconverter; .ini format https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini --- options below is unnecessary and can be omitted \u0026amp;list=false --- ç”¨äºè¾“å‡º Surge Node List æˆ–è€… Clash Proxy Provider æˆ–è€… Quantumult (X) çš„èŠ‚ç‚¹è®¢é˜… æˆ–è€… è§£ç åçš„ SIP002 \u0026amp;tfo=false --- ç”¨äºå¼€å¯è¯¥è®¢é˜…é“¾æ¥çš„ TCP Fast Openï¼Œé»˜è®¤ä¸º false \u0026amp;scv=false --- ç”¨äºå…³é—­ TLS èŠ‚ç‚¹çš„è¯ä¹¦æ£€æŸ¥ï¼Œé»˜è®¤ä¸º false \u0026amp;fdn=false --- ç”¨äºè¿‡æ»¤ç›®æ ‡ç±»å‹ä¸æ”¯æŒçš„èŠ‚ç‚¹ï¼Œé»˜è®¤ä¸º true \u0026amp;sort=false --- ç”¨äºå¯¹è¾“å‡ºçš„èŠ‚ç‚¹æˆ–ç­–ç•¥ç»„æŒ‰èŠ‚ç‚¹åè¿›è¡Œå†æ¬¡æ’åºï¼Œé»˜è®¤ä¸º false Set up a cronjob Create a shell script /etc/clash/update-config.sh with the following content:\n1 2 3 #!/usr/bin/env bash set -ex /usr/bin/curl \u0026#34;https://sub.xeton.dev/sub?target=clash\u0026amp;new_name=true\u0026amp;filename=config.yaml\u0026amp;url=XXXXXXXX\u0026amp;config=https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini\u0026#34; -o /etc/clash/config.yaml âš ï¸ The URL should be replace.\nManually executing it to make sure the config file is generated successfully.\nMake sure you have the following contents in your config.yaml file for clash:\n1 2 3 4 5 6 7 tproxy-port: 7893 dns: enable: true listen: 0.0.0.0:1053 enhanced-mode: fake-ip fake-ip-range: 198.18.0.1/16 Add a cronjob by executing sudo crontab -e and add this line to executing the script at 10:00 AM every day.\n1 0 10 * * * /usr/bin/bash /etc/clash/update-config.sh ","date":"2022-05-04T16:19:40+08:00","image":"https://cld4h.github.io/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables_hu_dd0f83ae4988a70a.webp","permalink":"https://cld4h.github.io/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/","title":"The Ultimate Way to Bypass GFW on Linux"},{"content":"æˆ‘å›æ¥å•¦ï¼\nå°†hugoæ¢äº†ä¸€ä¸ªä¸»é¢˜ï¼Œä»åŸæ¥æ–‡æ¡£ç±»çš„ä¸»é¢˜learn æ¢æˆäº†stackã€‚\næ¯•ç«Ÿåœ¨å½“ä¸‹è¿™ç§é£å£°é¹¤å”³çš„è¨€è®ºç¯å¢ƒä¸­ï¼Œä¹Ÿå°±èƒ½å†™ç‚¹æŠ€æœ¯ç±»çš„ä¸œè¥¿ã€‚ æœ¬æ¥å¹³æ—¶çœ‹æ–‡æ¡£å°±è¦çœ‹åäº†ï¼Œä¸ªäººåšå®¢ä½•è‹¦è¿˜è¦æä¸ªå¤§æ–‡æ¡£å‡ºæ¥å‘¢ï¼Ÿ\næ–‡ç« è¿˜æ˜¯è¦å¤šå†™çš„ï¼Œä»¥é˜²ä¸§å¤±è¯­è¨€èƒ½åŠ›ã€‚\næˆ‘è®¡åˆ’ä»¥åæ¯å¤©ï¼ˆè‡³å°‘æ¯å‘¨ï¼‰éƒ½è¦å†™ç‚¹ä¸œè¥¿ã€‚\nè‡³å°‘æŠŠè‡ªå·±æƒ³äº†ç‚¹å•¥ã€å¹²äº†ç‚¹å•¥è®°ä¸‹æ¥ï¼Œæ™šä¸Šå°±èƒ½ç¡ä¸ªå¥½è§‰äº†ã€‚\n","date":"2022-02-11T11:43:02+08:00","permalink":"https://cld4h.github.io/blog/p/im-back/","title":"I'm Back"},{"content":" Name http rss Luke Smith https://lukesmith.xyz https://lukesmith.xyz/rss.xml Luke Smith (peertube) https://videos.lukesmith.xyz https://lukesmith.xyz/videos Not Related! https://notrelated.xyz/ https://notrelated.xyz/rss å®˜å¤§ç‚º - Wiwi Kuan https://wiwikuan.com https://wiwikuan.com/index.xml Wiwi.Video å¥½å’Œå¼¦è¯æ’­ç¶² https://wiwi.video https://wiwi.video/feeds/videos.atom?sort=-publishedAt å¥½æª¸æª¬ NiceLemon https://nicelemon.libsyn.com/ http://nicelemon.libsyn.com/rss ","date":"2021-04-28T22:21:40+08:00","permalink":"https://cld4h.github.io/blog/p/links-i-consoom/","title":"Links I \"consoom\""},{"content":"Reference1\nReference2-escaping shortcode in hugo\nåˆ›å»º layouts/shortcodes/rawhtml.html æ–‡ä»¶å¦‚ä¸‹\n1 2 \u0026lt;!-- raw html --\u0026gt; {{.Inner}} å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼ä½¿ç”¨\n1 2 3 4 5 {{\u0026lt; rawhtml \u0026gt;}} \u0026lt;p class=\u0026#34;speshal-fancy-custom\u0026#34;\u0026gt; This is \u0026lt;strong\u0026gt;raw HTML\u0026lt;/strong\u0026gt;, inside Markdown. \u0026lt;/p\u0026gt; {{\u0026lt; /rawhtml \u0026gt;}} ","date":"2021-04-21T20:30:32+08:00","permalink":"https://cld4h.github.io/blog/p/raw-html-in-hugo/","title":"Raw HTML in Hugo"},{"content":"Update: Somehow I found it\u0026rsquo;s no longer needed in the stack theme.\nOfficial docs Reference\nI copied the default RSS template that ships with Hugo and changed line 28.\n1 2 3 4 28c28 \u0026lt; {{ range $pages }} --- \u0026gt; {{ range .Site.Pages }} I added the following line to my layouts/partials/menu-footer.html\n1 \u0026lt;p\u0026gt;\u0026lt;a href=\u0026#34;{{.Site.BaseURL}}/index.xml\u0026#34;\u0026gt;\u0026lt;i class=\u0026#34;fas fa-rss\u0026#34;\u0026gt;\u0026lt;/i\u0026gt; RSS\u0026lt;/a\u0026gt;\u0026lt;/p\u0026gt; ","date":"2021-04-20T10:33:50+08:00","permalink":"https://cld4h.github.io/blog/p/rss-in-hugo/","title":"RSS in hugo"},{"content":"First install hugo on your system\nChoose a folder to run this command\n1 hugo new site blog cd into your site folder, init a git repo, and add a theme.\nIn my case I forked the learn theme in case I want to modify it.\nI then added the original branch as \u0026ldquo;learn\u0026rdquo; to track new updates.\n1 2 3 4 5 6 cd blog git init git submodule add git@github.com:cld4h/hugo-theme-learn.git themes/learn cd themes/learn git remote add -f learn https://github.com/matcornic/hugo-theme-learn.git git diff learn/master origin/master change the config.toml file\n1 2 3 4 5 6 # Change the default theme to be use when building the site with Hugo theme = \u0026#34;learn\u0026#34; # For search functionality [outputs] home = [ \u0026#34;HTML\u0026#34;, \u0026#34;RSS\u0026#34;, \u0026#34;JSON\u0026#34;] How this Chapter and this page is added\n1 2 hugo new --kind chapter hugo/_index.md hugo new hugo/start.md Start locally\n1 hugo serve -D Learn theme docs\n","date":"2021-03-24T12:18:03+08:00","permalink":"https://cld4h.github.io/blog/p/start-hugo/","title":"Start Hugo"},{"content":"Beamer åœ¨Beamerä¸­æ’å…¥å›¾ç‰‡ (å¯å‚è§Beameræ–‡æ¡£12.6èŠ‚)\nfigure ç¯å¢ƒç¤ºä¾‹ï¼š\n1 2 3 4 5 6 \\begin{figure} \\centering \\includegraphics[width=\\textwidth]{pic/F1.png} \\caption{å›¾ä¸­æ¯ä¸ªæ–¹å—ä»£è¡¨äº¤æ˜“ï¼Œå³ä¸‹è§’çš„æ•°å­—è¡¨ç¤ºäº¤æ˜“æœ¬èº«çš„æƒé‡ï¼Œç²—ä½“å­—è¡¨ç¤ºç´¯ç§¯æƒé‡ã€‚} \\label{fig:bef} \\end{figure} ä¸ºäº†ä½¿å›¾ç‰‡çš„captionæœ‰æ•°å­—æ ‡å·ï¼Œåœ¨å¯¼è¨€åŒºåŠ å…¥ä¸‹è¿°å†…å®¹ï¼š\n1 \\setbeamertemplate{caption}[numbered] ä»markdownç¼–è¯‘Beamer presentation 1 pandoc talk.md -t beamer -o talk.pdf --pdf-engine=xelatex -V mainfont=æ€æºå®‹ä½“ ","date":"2019-10-21T00:00:00Z","permalink":"https://cld4h.github.io/blog/p/latex-tips/","title":"LaTeX tips"},{"content":"é¢˜ç›®æ¥æº\n2019 å­—èŠ‚è·³åŠ¨ bytectf crypto lrlr\nå‚è€ƒ\nTeam: W\u0026amp;M\nJarvis oj crypto\nå…ˆå…¨æ–‡æ‘˜æŠ„å¤§ä½¬çš„ Write Up é€šè¿‡oldçš„1000ç»„å¯ä»¥é¢„æµ‹pythonéšæœºæ•°ï¼Œ https://github.com/tna0y/Python-random-module-cracker\nä¸€å…±2è½®aesåŠ å¯†ï¼Œæ—¢ç„¶å¯†é’¥å¯ä»¥é¢„æµ‹å‡ºæ¥ï¼Œè‡ªç„¶å°±èƒ½è§£å¯†å¾—åˆ°clistã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 from Crypto.Util.number import getPrime, bytes_to_long, long_to_bytes from Crypto.Cipher import AES import random from randcrack import RandCrack rc = RandCrack() with open(\u0026#39;old\u0026#39;) as file: old = [int(i) for i in file.read().strip().split(\u0026#39;\\n\u0026#39;)] index = 0 for i in range(index,624): rc.submit(old[index]) index+=1 for i in range(1000-624): assert(old[index]==rc.predict_getrandbits(32)) index+=1 with open(\u0026#39;cl\u0026#39;) as file: nlist = [eval(i) for i in file.read().strip().split(\u0026#39;\\n\u0026#39;)] with open(\u0026#39;new\u0026#39;) as file: clist=[i.decode(\u0026#39;hex\u0026#39;) for i in file.read().strip().split(\u0026#39;\\n\u0026#39;)] key1=[] key2=[] key3=[] for i in range(24): key1.append(rc.predict_getrandbits(128)) for i in range(24): key2.append(rc.predict_getrandbits(128)) for i in range(24): key3.append(rc.predict_getrandbits(128)) tmp1=[] for i in range(24): handle = AES.new(long_to_bytes(key3[i]), AES.MODE_CBC, \u0026#34;\\x00\u0026#34;*16) tmpstate=handle.decrypt(clist[i]) tmp1.append(tmpstate) tmp2=[] for i in range(24): handle = AES.new(long_to_bytes(key2[i]), AES.MODE_CBC, \u0026#34;\\x00\u0026#34;*16) tmpstate=handle.decrypt(tmp1[i]) tmp2.append(tmpstate) # tmp3=[] # for i in range(24): # handle = AES.new(long_to_bytes(key1[i]), AES.MODE_CBC, \u0026#34;\\x00\u0026#34;*16) # tmpstate=handle.decrypt(tmp2[i]) # tmp3.append(tmpstate) c=[] for i in tmp2: c.append(bytes_to_long(i)) for i in range(17): print \u0026#39;n = %d\u0026#39;%nlist[i] print \u0026#39;e = 17\u0026#39; print \u0026#39;c = %d\u0026#39;%c[i] print \u0026#39;\\n\u0026#39; ç„¶åæœ‰äº†24ç»„n,cï¼›e=17ã€‚éšä¾¿é€‰æ‹©17ç»„å»å¹¿æ’­æ”»å‡»\næœ€åä¸€æ­¥ç±»ä¼¼jarvis ojä¸Šçš„bbencodeåŸé¢˜ï¼Œå¾ªç¯ç¼–ç ï¼Œåˆ¤æ–­flagå¼€å¤´çš„å­—ç¬¦ä¸²\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 def bbencode(n): a = 0 for i in bin(n)[2:]: a = a \u0026lt;\u0026lt; 1 if (int(i)): a = a ^ n if a \u0026gt;\u0026gt; 256: a = a ^ 0x10000000000000000000000000000000000000000000000000000000000000223L return a result = 61406796444626535559771097418338494728649815464609781204026855332620301752444 for i in range(10000): result = bbencode(result) if(\u0026#34;666c6167\u0026#34; == str(hex(result))[2:10]): print i print hex(result)[2:-1].decode(\u0026#39;hex\u0026#39;) ä¸‹é¢å†™ä¸‹ç»†èŠ‚ é€šè¿‡ oldtest() ä¸­ random.getrandbits() å‡½æ•°ç”Ÿæˆçš„éšæœºæ•°å¯ä»¥ç”¨ randcrack åº“æ¨æ–­åˆ°ä¹‹å lrandout() ä¸­è°ƒç”¨ stateconvert() å’Œ gen_new_states() æ—¶ç”Ÿæˆçš„128ä½éšæœºæ•°ã€‚\næ­¤éšæœºæ•°ç›´æ¥ä½œä¸ºAES-128åŠ å¯†çš„å¯†é’¥å¯¹ clist[] è¿›è¡ŒåŠ å¯†ï¼ŒIVå€¼ä¸º128ä½0 ã€‚\nåŠ å¯†åçš„ç»“æœAppendåˆ° states[] åï¼Œç”¨çš„æ—¶å€™å†é€šè¿‡ stateconvert è¿›è¡Œç¬¬äºŒæ¬¡AESåŠ å¯†(åˆå§‹æ—¶(ä¹Ÿå°±æ˜¯ newtest ä¸­ç¬¬ä¸€ä¸ªå¾ªç¯) states[] æ•°ç»„ä¸­ä¸ºé•¿åº¦ä¸º24çš„ clist[] ä¸” stateselse == 24 æ‰€ä»¥ç›´æ¥è°ƒç”¨ stateconvert ä¸€æ¬¡åŠ å¯†å¾—åˆ°è¾“å‡º)\næˆ‘ä»¬ç°åœ¨å·²çŸ¥äºŒæ¬¡AESåŠ å¯†åçš„ç»“æœï¼›å·²çŸ¥ nlist[]ï¼›éœ€è¦å…ˆç”±éšæœºæ•°ç”Ÿæˆè§„å¾‹æ¨æ–­å‡ºä½œä¸ºå¯†é’¥çš„éšæœºæ•°ï¼Œé€šè¿‡AESè§£å¯†å¾—åˆ° clist[]ï¼›ç„¶åçœ‹ gen_states å‡½æ•°å‘ç° clist[] ä¸­çš„å…ƒç´ æ˜¯åŒä¸€ä¸ªæ¶ˆæ¯(init_state) ä»¥ $e=17$ ä¸ºæŒ‡æ•°æ¨¡ä¸åŒçš„ $n$ å€¼æ‰€å¾—ã€‚æ­¤å¤„å¯ä»¥è¿›è¡Œä½æŒ‡æ•°å¹¿æ’­æ”»å‡»ã€‚\nä½æŒ‡æ•°å¹¿æ’­æ”»å‡» å‚è€ƒ ä¸€å¶é£˜é›¶ çš„ Crypto-RSA-å…¬é’¥æ”»å‡»å°ç»“ å‚è€ƒ ashutosh1206 çš„ Hastad\u0026rsquo;s Broadcast Attack æ‰€è°“â€œä½æŒ‡æ•°â€ï¼ŒæŒ‡çš„æ˜¯æŒ‡æ•° $e \u0026lt;= \\text{å¹¿æ’­æˆå‘˜æ•°é‡(åŠ å¯†çš„æ¶ˆæ¯æ•°é‡)}$\nä¸­å›½å‰©ä½™å®šç† å¯¹äºä¸‹é¢çš„ä¸€å…ƒçº¿æ€§åŒä½™æ–¹ç¨‹ç»„ï¼š\n$$ \\begin{equation*} \\left\\lbrace \\begin{aligned} x \\equiv \u0026 a_1 \\bmod m_{1}\\\\ x \\equiv \u0026 a_2 \\bmod m_{2}\\\\ \u0026 \\vdots\\\\ x \\equiv \u0026 a_n \\bmod m_{n}\\\\ \\end{aligned} \\right. \\end{equation*} $$ å‡è®¾$m_1,m_2,\\ldots,m_n$ä¸­ä»»æ„ä¸¤æ•°äº’è´¨ï¼Œåˆ™å¯¹ä»»æ„æ•´æ•°$a_1,a_2,\\ldots,a_n$ï¼Œä¸Šè¿°æ–¹ç¨‹ç»„æœ‰è§£ï¼Œé€šè§£çš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š\nè®¾$M = m_1\\times m_2\\times \\cdots \\times m_{n} = \\prod\\limits_{i=1}^{n} m_{i} $ æ˜¯æ•´æ•°$m_1,m_2,\\ldots,m_{n}$ çš„ä¹˜ç§¯ è®¾$M_{i} = M / m_{i}, \\forall i \\in {1,2,\\ldots,n}$ è®¾$t_{i} = M_{i}^{-1}$ ä¸º$M_{i}$ æ¨¡$m_{i}$ çš„æ•°è®ºå€’æ•° æ–¹ç¨‹ç»„çš„é€šè§£å½¢å¼ä¸ºï¼š $$ x = a_1t_1M_1+a_2t_2M_2+\\cdots+a_{n}t_{n}M_{n} = kM+\\sum_{i=1}^{n} a_{i}t_{i}M_{i},\\qquad \\forall k \\in \\mathbb{Z}. $$ åœ¨æ¨¡$M$ çš„æ„ä¹‰ä¸‹æ–¹ç¨‹ç»„åªæœ‰ä¸€ä¸ªè§£ï¼š $$ x=\\sum_{i=1}^{n} a_{i}t_{i}M_{i} $$ å› æ­¤ï¼Œå¯¹äºæœ¬é¢˜\n$$ \\begin{equation*} \\left\\lbrace \\begin{aligned} m^{17} \\equiv \u0026 c_1 \\bmod n_1\\\\ m^{17} \\equiv \u0026 c_2 \\bmod n_2\\\\ \u0026 \\vdots\\\\ m^{17} \\equiv \u0026 c_{17} \\bmod n_{17}\\\\ \\end{aligned} \\right. \\end{equation*} $$ (è¦æ±‚$n_1,n_2,\\ldots,n_{17}$ä¸¤ä¸¤äº’ç´ ï¼Œè‹¥ä¸æ»¡è¶³ä¸¤ä¸¤äº’ç´ ï¼Œå¯è¿›è¡Œå…±æ¨¡æ”»å‡»)æœ‰\n$$ m^{17} = \\sum_{i=1}^{17} c_{i}N_{i}N_{i}^{-1} mod N $$\nå…¶ä¸­ï¼Œ\n$ N = n_1\\times n_2\\times \\cdots \\times n_{17} = \\prod\\limits_{i=1}^{17} n_{i} $ï¼›\n$ N_{i} = N / n_{i} $ï¼›\n$ N_{i}^{-1} \\cdot N_{i} \\equiv 1 \\bmod n_{i} $\nå› ä¸º$m \u0026lt; n_{i} \\quad \\forall i \\in {1,2,\\ldots,17}$ï¼Œæ‰€ä»¥$ m^{17} \u0026lt; N = \\prod\\limits_{i=1}^{17} n_{i}$ ç›´æ¥å¼€æ–¹å³å¯ã€‚\nhastad_unpadded.py å‚è€ƒ åªéœ€å…³æ³¨ crt å‡½æ•°å’Œ hastad_unpadded å‡½æ•°å³å¯\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 #!/usr/bin/env python2.7 from Crypto.Util.number import GCD, bytes_to_long, long_to_bytes import gmpy2 def crt(list_a, list_m): \u0026#34;\u0026#34;\u0026#34; Reference: https://crypto.stanford.edu/pbc/notes/numbertheory/crt.html Returns the output after computing Chinese Remainder Theorem on x = a_1 mod m_1 x = a_2 mod m_2 ... x = a_n mod m_n input parameter list_a = [a_1, a_2, ..., a_n] input parameter list_m = [m_1, m_2, ..., m_n] Returns -1 if the operation is unsuccessful due to some exceptions \u0026#34;\u0026#34;\u0026#34; try: assert len(list_a) == len(list_m) except: print \u0026#34;[+] Length of list_a should be equal to length of list_m\u0026#34; return -1 for i in range(len(list_m)): for j in range(len(list_m)): if GCD(list_m[i], list_m[j])!= 1 and i!=j: print \u0026#34;[+] Moduli should be pairwise co-prime\u0026#34; return -1 M = 1 for i in list_m: M *= i list_b = [M/i for i in list_m] assert len(list_b) == len(list_m) try: list_b_inv = [int(gmpy2.invert(list_b[i], list_m[i])) for i in range(len(list_m))] except: print \u0026#34;[+] Encountered an unusual error while calculating inverse using gmpy2.invert()\u0026#34; return -1 x = 0 for i in range(len(list_m)): x += list_a[i]*list_b[i]*list_b_inv[i] return x % M def test_crt(): \u0026#34;\u0026#34;\u0026#34; Checking the validity and consistency of CRT function \u0026#34;\u0026#34;\u0026#34; list_a = [[2, 3], [1, 2, 3, 4], [6, 4]] list_m = [[5, 7], [5, 7, 9, 11], [7, 8]] soln_list = [17, 1731, 20] try: for i in range(len(list_a)): assert crt(list_a[i], list_m[i]) == soln_list[i] except: print \u0026#34;[+] CRT function broken. Check the function again!\u0026#34; def hastad_unpadded(ct_list, mod_list, e): \u0026#34;\u0026#34;\u0026#34; Implementing Hastad\u0026#39;s Broadcast Attack \u0026#34;\u0026#34;\u0026#34; m_expo = crt(ct_list, mod_list) if m_expo != -1: eth_root = gmpy2.iroot(m_expo, e) if eth_root[1] == False: print \u0026#34;[+] Cannot calculate e\u0026#39;th root!\u0026#34; return -1 elif eth_root[1] == True: # æ³¨æ„ï¼Œeth_root ä¸ºå…ƒç»„(mpzå¯¹è±¡,å¸ƒå°”å€¼)ï¼Œéœ€ç”¨eth_root[0]æå–mpzå¯¹è±¡ # ä¹Ÿå¯ç”¨gmpy2.digits(eth_root[0]) # ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›æ­£ç¡®çš„ç»“æœ # https://gmpy2.readthedocs.io/en/latest/mpz.html#mpz-functions return long_to_bytes(eth_root[0]) else: print \u0026#34;[+] Cannot calculate CRT\u0026#34; return -1 test_crt() å¯¹äºæ­¤é¢˜ï¼Œæˆ‘ä»¬ä¼ å…¥ hastad_unpadded(ct_list, mod_list, e) å‡½æ•°çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º\nct_list = clist mod_list = nlist e = 17 (clist å’Œ nlist é€šè¿‡å‰é¢å¤§ä½¬ç»™çš„WPä¸­çš„ä»£ç å³å¯å¾—åˆ°ï¼Œç”¨åˆ°äº† randcrack åº“)\né€šè¿‡ä¸Šè¿°ä»£ç æˆ‘ä»¬æˆåŠŸå¾—åˆ°äº† init_state çš„å€¼\nä¸å‰é¢å¤§ä½¬ç»™çš„ä¸€è‡´.\nbbencode è·å¾— init_state åå°±ä¸ Jarvis OJ ä¸Šçš„é¢˜ç›®å®Œå…¨ä¸€è‡´äº† ä¸»è¦å‚è€ƒ Jarvis oj crypto\nå¤§è‡´çš„æ„æ€æ˜¯å°† bbencode çš„è¾“å‡ºå†ä¼ ç»™ bbencode ï¼Œåå¤ä½œç”¨ï¼Œæ¯ä¸€æ¬¡éƒ½æŸ¥çœ‹ä¸€ä¸‹ç»“æœä¸­å‰å››ä¸ªå­—èŠ‚æ˜¯ä¸æ˜¯â€œflagâ€ ï¼Œå¦‚ä¸‹ï¼š\n1 if(\u0026#34;666c6167\u0026#34; == str(hex(result))[2:10]): \u0026ldquo;666c6167\u0026rdquo; æ­£å¥½æ˜¯ flag çš„asciiç \nç”±äºforå¾ªç¯æ‰§è¡Œ10000æ¬¡ï¼Œæ¯2695æ¬¡è¿­ä»£ä¼šå¾—åˆ°ä¸€æ¬¡flagï¼Œæ‰€ä»¥ä¼šè¾“å‡ºä¸‰æ¬¡flag\n","date":"2019-09-17T19:11:45+08:00","permalink":"https://cld4h.github.io/blog/p/lrlr/","title":"lrlr"}]