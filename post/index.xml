<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Posts on cld4h's blog</title><link>https://cld4h.github.io/blog/post/</link><description>Recent content in Posts on cld4h's blog</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Fri, 16 May 2025 00:00:00 +0000</lastBuildDate><atom:link href="https://cld4h.github.io/blog/post/index.xml" rel="self" type="application/rss+xml"/><item><title>Workaround: VSCode Remote on Compute Canada CentOS7 Server</title><link>https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/</link><pubDate>Fri, 16 May 2025 00:00:00 +0000</pubDate><guid>https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/</guid><description>&lt;p>VS Code allows us to connect to a remote envirnoment. This is very convenient especially for developing and testing code on cloud computing servers.&lt;/p>
&lt;p>However, &lt;a class="link" href="https://code.visualstudio.com/docs/remote/faq#_can-i-run-vs-code-server-on-older-linux-distributions" target="_blank" rel="noopener"
>starting with VS Code release &lt;mark>1.99 (March 2025)&lt;/mark>, the prebuilt servers distributed by VS Code are only compatible with Linux distributions that are based on glibc 2.28 or later.&lt;/a>&lt;/p>
&lt;p>This create &lt;a class="link" href="https://docs.alliancecan.ca/wiki/Visual_Studio_Code#The_remote_session_does_not_work_anymore" target="_blank" rel="noopener"
>connection problems&lt;/a> for users of &lt;a class="link" href="https://alliancecan.ca/" target="_blank" rel="noopener"
>Compute Canada&lt;/a>. Specifically, connections to Graham and Niagara because of the no longer supported CentOS7 system.&lt;/p>
&lt;p>In this article, I&amp;rsquo;ll show you all the steps I&amp;rsquo;ve done to establish a &lt;a class="link" href="https://code.visualstudio.com/docs/remote/tunnels" target="_blank" rel="noopener"
>Remote Tunnel&lt;/a> and connect to the server.&lt;/p>
&lt;h2 id="official-workaround-which-is-not-fully-working">Official Workaround (which is not fully working)
&lt;/h2>&lt;p>Firstly I followed the &lt;a class="link" href="https://code.visualstudio.com/docs/remote/faq#_can-i-run-vs-code-server-on-older-linux-distributions" target="_blank" rel="noopener"
>VS Code official documentation&lt;/a>, to prepare a &lt;code>sysroot&lt;/code>, a &lt;code>patchelf&lt;/code> and set the three environment variables.&lt;/p>
&lt;p>Long story short, it did not solve the problem but we still need these steps.&lt;/p>
&lt;p>I don&amp;rsquo;t want to repeate the steps mentioned in their official documentation, but several pitfalls worth mentioning:&lt;/p>
&lt;ol>
&lt;li>Build and run the crosstool-ng command &lt;code>ct-ng build&lt;/code> on a docker environment (the Dockerfile is provided on the &lt;a class="link" href="https://code.visualstudio.com/docs/remote/faq#_can-i-run-vs-code-server-on-older-linux-distributions" target="_blank" rel="noopener"
>documentation&lt;/a> ), and compress the output &lt;code>x86_64-linux-gnu&lt;/code> to send it to the server.&lt;/li>
&lt;li>Set the 3 environment variables in &lt;code>$HOME/.bash_profile&lt;/code> (Here I put the output from &lt;code>ct-ng build&lt;/code> (the extracted &lt;code>x86_64-linux-gnu&lt;/code> folder) under &lt;code>$HOME/.local/share&lt;/code>)&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">VSCODE_SERVER_CUSTOM_GLIBC_LINKER&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$HOME&lt;/span>/.local/share/x86_64-linux-gnu/x86_64-linux-gnu/sysroot/lib64/ld-linux-x86-64.so.2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">VSCODE_SERVER_CUSTOM_GLIBC_PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$HOME&lt;/span>/.local/share/x86_64-linux-gnu/x86_64-linux-gnu/sysroot/lib64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">export&lt;/span> &lt;span class="nv">VSCODE_SERVER_PATCHELF_PATH&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$HOME&lt;/span>/.local/bin/patchelf
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="remote-tunnels">Remote tunnels
&lt;/h2>&lt;p>After failure of the official workarounds from VS Code, I noticed the suggestions from &lt;a class="link" href="https://docs.alliancecan.ca/wiki/Visual_Studio_Code#The_remote_session_does_not_work_anymore" target="_blank" rel="noopener"
>The Alliance wiki&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>use the &amp;ldquo;&lt;mark>Remote Tunnels&lt;/mark>&amp;rdquo; extension by running &amp;lsquo;code tunnel&amp;rsquo; (google &lt;mark>vscode cli&lt;/mark> and download it). Use github or a microsoft account (OAuth) and connect to a remote vscode server, such as a niagara login node. You can have all the &amp;ldquo;benefits&amp;rdquo; of not using mfa as long as your server is running.&lt;/p>&lt;/blockquote>
&lt;p>First thing is to download the &lt;a class="link" href="https://code.visualstudio.com/Download" target="_blank" rel="noopener"
>VS Code CLI&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">wget -O vscode-cli.tar.gz &lt;span class="s2">&amp;#34;https://code.visualstudio.com/sha/download?build=stable&amp;amp;os=cli-alpine-x64&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar -xzvf vscode-cli.tar.gz -C &lt;span class="nv">$HOME&lt;/span>/.local/bin/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm vscode-cli.tar.gz
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>On remote server, run &lt;code>code tunnel&lt;/code> to start.&lt;/p>
&lt;p>&lt;mark>Make sure environment variables (&lt;code>echo $VSCODE_SERVER_CUSTOM_GLIBC_PATH&lt;/code> to check) are set&lt;/mark> from previous steps. Otherwise you&amp;rsquo;ll get an error like this:&lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/code_tunnel_error.png"
width="1085"
height="582"
srcset="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/code_tunnel_error_hu_15abef57bc9208a7.png 480w, https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/code_tunnel_error_hu_b825244fdcffad19.png 1024w"
loading="lazy"
alt="code tunnel error"
class="gallery-image"
data-flex-grow="186"
data-flex-basis="447px"
>&lt;/p>
&lt;h2 id="manually-download-the-vscode-server-package">Manually download the vscode server package
&lt;/h2>&lt;p>If you try to connect to the remote now, you will see the remote server keep crashing and on the remote server, vscode keeps downloading and extracting the server package.&lt;/p>
&lt;p>What is the reason for this issue?&lt;/p>
&lt;p>There must be some errors when we are trying to run the vscode server script.&lt;/p>
&lt;p>Can we run it manually?&lt;/p>
&lt;p>Here &lt;a class="link" href="https://github.com/cvcore" target="_blank" rel="noopener"
>@cvcore&lt;/a> provided &lt;a class="link" href="https://gist.github.com/cvcore/8e187163f41a77f5271c26a870e52778" target="_blank" rel="noopener"
>a script for manually downloading the vscode-server&lt;/a>&lt;/p>
&lt;p>To run that script, we need to know the &lt;code>commit_id&lt;/code>.&lt;/p>
&lt;p>Go to your VS Code &lt;mark>Client&lt;/mark>, on the top menu tabs, go to &lt;code>Help&lt;/code>-&amp;gt;&lt;code>About&lt;/code> and you can see the commit id.&lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/commit.png"
width="474"
height="370"
srcset="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/commit_hu_d7db959512870239.png 480w, https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/commit_hu_12c0b29005ac93d7.png 1024w"
loading="lazy"
alt="commit id"
class="gallery-image"
data-flex-grow="128"
data-flex-basis="307px"
>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">/bin/bash -c &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>curl -fsSL https://gist.githubusercontent.com/cvcore/8e187163f41a77f5271c26a870e52778/raw/download_vscode_server.sh&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -- &amp;lt;commit_id&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Replace &lt;code>&amp;lt;commit_id&amp;gt;&lt;/code> with your actual commit id, run this command and it will download the vscode-server into your &lt;code>$HOME/.vscode-server/bin/&amp;lt;commit_id&amp;gt;&lt;/code> folder.&lt;/p>
&lt;h2 id="run-vscode-server-manually">Run vscode-server manually
&lt;/h2>&lt;p>Now with the server downloaded in &lt;code>$HOME/.vscode-server/bin/&amp;lt;commit_id&amp;gt;&lt;/code>, we can try to run it manually. But there will be an issue:&lt;/p>
&lt;p>If you run the server &lt;mark>with environment variables set&lt;/mark>, you can see the &lt;code>patchelf&lt;/code> working but we still get an error:&lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/run_server_1.png"
width="1098"
height="444"
srcset="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/run_server_1_hu_aaa0e6b9c00d9c5c.png 480w, https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/run_server_1_hu_a204d2cf2b51f0ae.png 1024w"
loading="lazy"
alt="run server manually with env set"
class="gallery-image"
data-flex-grow="247"
data-flex-basis="593px"
>&lt;/p>
&lt;p>If you run the server &lt;mark>without environment variables set&lt;/mark>, you&amp;rsquo;ll also get an error:&lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/run_server_2.png"
width="1099"
height="715"
srcset="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/run_server_2_hu_cad1460ba84a3179.png 480w, https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/run_server_2_hu_3cd96375b2b2a016.png 1024w"
loading="lazy"
alt="run server manually without env set"
class="gallery-image"
data-flex-grow="153"
data-flex-basis="368px"
>&lt;/p>
&lt;p>&lt;a class="link" href="https://docs.alliancecan.ca/wiki/Installing_software_in_your_home_directory#Installing_binary_packages" target="_blank" rel="noopener"
>Here is the SOLUTION to this problem. On the alliance wiki, it says&lt;/a>:&lt;/p>
&lt;blockquote>
&lt;p>If you install pre-compiled binaries in your home directory they may fail using errors such as &lt;code>/lib64/libc.so.6: version 'GLIBC_2.18' not found&lt;/code>. Often such binaries can be patched using our &lt;code>setrpaths.sh&lt;/code> script, using the syntax &lt;code>setrpaths.sh --path path [--add_origin]&lt;/code> where path refers to the directory where you installed that software.&lt;/p>&lt;/blockquote>
&lt;p>The &lt;code>setrpaths.sh&lt;/code> is hosted on &lt;a class="link" href="https://github.com/ComputeCanada/easybuild-computecanada-config/blob/main/setrpaths.sh" target="_blank" rel="noopener"
>their github repo here&lt;/a> but you don&amp;rsquo;t need to download it. It&amp;rsquo;s in your &lt;code>PATH&lt;/code>
under the folder &lt;code>/cvmfs/soft.computecanada.ca/easybuild/bin/&lt;/code>&lt;/p>
&lt;p>So here we simply run the following command (replace &lt;code>&amp;lt;commit_id&amp;gt;&lt;/code> with the actual one):&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">setrpaths.sh --path $HOME/.vscode-server/bin/&amp;lt;commit_id&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;img src="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/run_server_3.png"
width="1090"
height="463"
srcset="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/run_server_3_hu_2b748a878816f678.png 480w, https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/run_server_3_hu_6ca08e4c8489ae30.png 1024w"
loading="lazy"
alt="And now we can start the server manually with no errors. (Ctrl-C to kill it, we donâ€™t need it now)"
class="gallery-image"
data-flex-grow="235"
data-flex-basis="565px"
>&lt;/p>
&lt;h2 id="modify-the-startup-script">Modify the startup script
&lt;/h2>&lt;p>From the last step, we start the server from executing &lt;code>./code-server&lt;/code>. This is just a shell script wrapping the node-js server executable:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/bin/env sh
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Copyright (c) Microsoft Corporation. All rights reserved.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">case&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> in
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --inspect*&lt;span class="o">)&lt;/span> &lt;span class="nv">INSPECT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$1&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span> shift&lt;span class="p">;;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">esac&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">ROOT&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>dirname &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>dirname &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">$(&lt;/span>readlink -f &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$0&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="k">)&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Set rpath before changing the interpreter path&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Refs https://github.com/NixOS/patchelf/issues/524&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$VSCODE_SERVER_CUSTOM_GLIBC_LINKER&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">[&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$VSCODE_SERVER_CUSTOM_GLIBC_PATH&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span> &lt;span class="o">&amp;amp;&amp;amp;&lt;/span> &lt;span class="o">[&lt;/span> -n &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$VSCODE_SERVER_PATCHELF_PATH&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Patching glibc from &lt;/span>&lt;span class="nv">$VSCODE_SERVER_CUSTOM_GLIBC_PATH&lt;/span>&lt;span class="s2"> with &lt;/span>&lt;span class="nv">$VSCODE_SERVER_PATCHELF_PATH&lt;/span>&lt;span class="s2">...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$VSCODE_SERVER_PATCHELF_PATH&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> --set-rpath &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$VSCODE_SERVER_CUSTOM_GLIBC_PATH&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$ROOT&lt;/span>&lt;span class="s2">/node&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Patching linker from &lt;/span>&lt;span class="nv">$VSCODE_SERVER_CUSTOM_GLIBC_LINKER&lt;/span>&lt;span class="s2"> with &lt;/span>&lt;span class="nv">$VSCODE_SERVER_PATCHELF_PATH&lt;/span>&lt;span class="s2">...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$VSCODE_SERVER_PATCHELF_PATH&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> --set-interpreter &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$VSCODE_SERVER_CUSTOM_GLIBC_LINKER&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$ROOT&lt;/span>&lt;span class="s2">/node&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Patching complete.&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">fi&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$ROOT&lt;/span>&lt;span class="s2">/node&amp;#34;&lt;/span> &lt;span class="si">${&lt;/span>&lt;span class="nv">INSPECT&lt;/span>&lt;span class="k">:-&lt;/span>&lt;span class="si">}&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$ROOT&lt;/span>&lt;span class="s2">/out/server-main.js&amp;#34;&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="nv">$@&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Here you can see from line 14 to 20, it checkes the environment variables to patch glic and linker. We don&amp;rsquo;t need that so &lt;mark>comment out or remove&lt;/mark> those lines. Otherwise, by default, with 3 environment variables set, patching will be done and we will get the &lt;code>FATAL: kernel too old&lt;/code> error.&lt;/p>
&lt;h2 id="prepare-everything-in-the-correct-path">Prepare everything in the correct path
&lt;/h2>&lt;p>(replace &lt;code>&amp;lt;commit_id&amp;gt;&lt;/code> with the actual one)&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nv">COMMIT_ID&lt;/span>&lt;span class="o">=&lt;/span>&amp;lt;commit_id&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -rf &lt;span class="nv">$HOME&lt;/span>/.vscode
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkdir -p &lt;span class="nv">$HOME&lt;/span>/.vscode/cli/servers/Stable-&lt;span class="nv">$COMMIT_ID&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cat &lt;span class="s">&amp;lt;&amp;lt; EOF &amp;gt; $HOME/.vscode/cli/servers/lru.json
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">[&amp;#34;Stable-$COMMIT_ID&amp;#34;]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s">EOF&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp -r &lt;span class="nv">$HOME&lt;/span>/.vscode-server/bin/&lt;span class="nv">$COMMIT_ID&lt;/span> &lt;span class="nv">$HOME&lt;/span>/.vscode/cli/servers/Stable-&lt;span class="nv">$COMMIT_ID&lt;/span>/server
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Now you can start a &lt;code>tmux&lt;/code> session and run &lt;code>code tunnel&lt;/code> to start the server.&lt;/p>
&lt;h2 id="results">Results
&lt;/h2>&lt;p>&lt;img src="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Server1.png"
width="1086"
height="618"
srcset="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Server1_hu_5d9f8576a19f9754.png 480w, https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Server1_hu_176770666c7e3078.png 1024w"
loading="lazy"
alt="Start the server"
class="gallery-image"
data-flex-grow="175"
data-flex-basis="421px"
>&lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Auth.png"
width="766"
height="820"
srcset="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Auth_hu_d1d20aa8821889ad.png 480w, https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Auth_hu_7bfcb8778026f493.png 1024w"
loading="lazy"
alt="Authentication"
class="gallery-image"
data-flex-grow="93"
data-flex-basis="224px"
>&lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Server2.png"
width="1045"
height="153"
srcset="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Server2_hu_2312fea3cc32348f.png 480w, https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Server2_hu_4ee7b0f0a3bf7030.png 1024w"
loading="lazy"
alt="Give the server a nickname"
class="gallery-image"
data-flex-grow="683"
data-flex-basis="1639px"
>&lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Connect1.png"
width="1083"
height="578"
srcset="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Connect1_hu_49b11c512fb51090.png 480w, https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Connect1_hu_db81bad2ddbd3d15.png 1024w"
loading="lazy"
alt="Client connection: Open you local VS Code, press F1 key or click â€œConnect toâ€¦â€"
class="gallery-image"
data-flex-grow="187"
data-flex-basis="449px"
>&lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Server3.png"
width="1088"
height="585"
srcset="https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Server3_hu_944b4b93b6130b87.png 480w, https://cld4h.github.io/blog/p/workaround-vscode-remote-on-compute-canada-centos7-server/Server3_hu_6131e4e02c1377cf.png 1024w"
loading="lazy"
alt="Server is running and we can see the connection from the client"
class="gallery-image"
data-flex-grow="185"
data-flex-basis="446px"
>&lt;/p></description></item><item><title>Making a bootable MacOS X USB on Archlinux</title><link>https://cld4h.github.io/blog/p/making-a-bootable-macos-x-usb-on-archlinux/</link><pubDate>Wed, 10 May 2023 14:05:43 +0800</pubDate><guid>https://cld4h.github.io/blog/p/making-a-bootable-macos-x-usb-on-archlinux/</guid><description>&lt;p>A few days ago, I got a MacBook Air (mid 2011) from a friend.
The battery was died, but everything else is fine, despite it running extremly slowly.&lt;/p>
&lt;p>I tried to reinstall an older version of OS X system for it.&lt;/p>
&lt;p>The first thing is to create a bootable USB drive for that. Following the instructions &lt;a class="link" href="https://bramblecentral.wordpress.com/2020/05/19/making-a-bootable-macos-x-usb-on-linux/" target="_blank" rel="noopener"
>here&lt;/a> and &lt;a class="link" href="https://github.com/eprigorodov/mkosxinstallusb" target="_blank" rel="noopener"
>here&lt;/a>, I&amp;rsquo;ve done this successfully.&lt;/p>
&lt;p>It&amp;rsquo;s a completely a new (and a little complicated) experience for me. So I felt it&amp;rsquo;s necessary to write up the steps.&lt;/p>
&lt;h2 id="preparation">Preparation
&lt;/h2>&lt;ul>
&lt;li>&lt;code>dmg2img&lt;/code> (in AUR) to convert Apple&amp;rsquo;s &lt;code>.dmg&lt;/code> image format to &lt;code>.img&lt;/code>&lt;/li>
&lt;li>&lt;code>kpartx&lt;/code> (in &lt;code>multipath-tools&lt;/code> package) to mount &lt;code>.img&lt;/code>&lt;/li>
&lt;li>&lt;code>xar&lt;/code> (in AUR) to extract &lt;code>.pkg&lt;/code>&lt;/li>
&lt;li>&lt;code>InstallMacOSX.dmg&lt;/code> or &lt;code>InstallESD.dmg&lt;/code>&lt;/li>
&lt;li>A USB drive (refered to as &lt;code>/dev/sdX&lt;/code> in the following contents)&lt;/li>
&lt;/ul>
&lt;h2 id="steps">Steps
&lt;/h2>&lt;ol>
&lt;li>Extract &lt;code>InstallESD.dmg&lt;/code> from &lt;code>InstallMacOSX.dmg&lt;/code>&lt;/li>
&lt;li>Do the following steps:&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">mkdir -p /mnt/OSX_InstallESD /mnt/OSX_BaseSystem /mnt/usbstick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># convert installer disk image to raw format&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dmg2img &lt;span class="s2">&amp;#34;Install OS X &amp;lt;Version&amp;gt;.app/Contents/SharedSupport/InstallESD.dmg&amp;#34;&lt;/span> InstallESD.img
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kpartx -a InstallESD.img
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/mapper/loop0p2 /mnt/OSX_InstallESD
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># convert base system disk image to raw format&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">dmg2img /mnt/OSX_InstallESD/BaseSystem.dmg BaseSystem.img
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">kpartx -a BaseSystem.img
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/mapper/loop1p1 /mnt/OSX_BaseSystem
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># partition the USB flash drive, /dev/sdX&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sgdisk -o /dev/sdX
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sgdisk -n 1:0:0 -t 1:AF00 -c 1:&lt;span class="s2">&amp;#34;disk image&amp;#34;&lt;/span> -A 1:set:2 /dev/sdX
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mkfs.hfsplus -v &lt;span class="s2">&amp;#34;OS X Base System&amp;#34;&lt;/span> /dev/sdX1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">mount /dev/sdX1 /mnt/usbstick
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># copy installer files&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rsync -aAEHW /mnt/OSX_BaseSystem/ /mnt/usbstick/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rm -f /mnt/usbstick/System/Installation/Packages
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rsync -aAEHW /mnt/OSX_InstallESD/Packages /mnt/usbstick/System/Installation/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rsync -aAEHW /mnt/OSX_InstallESD/BaseSystem.chunklist /mnt/usbstick/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">rsync -aAEHW /mnt/OSX_InstallESD/BaseSystem.dmg /mnt/usbstick/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sync
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>In the final step, &lt;code>sync&lt;/code> is to write all cached writes to persistent storage. It can go extremly slowly. To see the progress, you can look at &lt;code>/proc/meminfo&lt;/code> to see &lt;code>Dirty&lt;/code> sizes.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">watch -d grep -e Dirty: -e Writeback: /proc/meminfo
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;a class="link" href="https://unix.stackexchange.com/questions/48235/can-i-watch-the-progress-of-a-sync-operation" target="_blank" rel="noopener"
>(reference)&lt;/a>&lt;/p></description></item><item><title>The Ultimate Way to Bypass GFW on Linux</title><link>https://cld4h.github.io/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/</link><pubDate>Wed, 04 May 2022 16:19:40 +0800</pubDate><guid>https://cld4h.github.io/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/</guid><description>&lt;img src="https://cld4h.github.io/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables.webp" alt="Featured image of post The Ultimate Way to Bypass GFW on Linux" />&lt;p>This article show you the ultimate way to set up a transparent proxy on Linux using clash and iptables to bypass the GFW in China.&lt;/p>
&lt;p>We use:&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://github.com/Dreamacro/clash" target="_blank" rel="noopener"
>clash&lt;/a> as the proxy software&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/tindy2013/subconverter" target="_blank" rel="noopener"
>online subconverter&lt;/a> and crontab to periodically update config file.&lt;/li>
&lt;li>&lt;a class="link" href="https://github.com/ACL4SSR/ACL4SSR/tree/master" target="_blank" rel="noopener"
>ACL4SSR&lt;/a> to provide GFW rules.&lt;/li>
&lt;/ul>
&lt;p>You can go to &lt;a class="link" href="https://gist.github.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4" target="_blank" rel="noopener"
>github gist&lt;/a> to download all files mentioned in this article.&lt;/p>
&lt;p>All files you need:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="cl">.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ clash-base-config.yaml ---ðŸŸ¢base config for clash to work on tproxy and fake-ip mode
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ clash.service ---ðŸŸ¢systemd unit file to start up clash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ clean.sh ---ðŸŸ¢script to clean iptables
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ config.ini ---ðŸŸ¢config file for subconverter
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ iptables.sh ---ðŸŸ¢iptables config file
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ update-config.sh ---ðŸŸ¡subscription update script; &amp;#34;XXXXXXXX&amp;#34; need to be replaced
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ config.yaml ---â­•clash config file, to be generated from update-config.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”œâ”€â”€ README.md
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€ README.zh-cn.md
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ðŸŸ¢: Doesn&amp;#39;t need to change
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ðŸŸ¡: Needs to change
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â­•: Needs to be generated
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="reference">Reference
&lt;/h2>&lt;p>&lt;a class="link" href="https://www.sobyte.net/post/2022-02/clash-tproxy/" target="_blank" rel="noopener"
>clash-tproxy&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://git.breakpoint.cc/cgit/fw/tcprdr.git" target="_blank" rel="noopener"
>Transparent proxy demo code&lt;/a>&lt;/p>
&lt;h2 id="prerequisite">Prerequisite
&lt;/h2>&lt;ul>
&lt;li>a &lt;code>clash&lt;/code> installed. (By default in &lt;code>/usr/bin/clash&lt;/code>)&lt;/li>
&lt;li>iptables&lt;/li>
&lt;li>systemd (It&amp;rsquo;s totally fine to use other init programs, but here I&amp;rsquo;ll only show the configuration of systemd, which is the default of most GNU/Linux distros.)&lt;/li>
&lt;li>crontab&lt;/li>
&lt;/ul>
&lt;h2 id="steps">Steps
&lt;/h2>&lt;h3 id="create-a-system-user-called-clash">Create a system user called clash
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">useradd -r -M -s /usr/sbin/nologin clash
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Since we want to proxy all internet traffics, we need to prevent the traffic from looping.
Thus, we create a distinct user called &lt;code>clash&lt;/code> (the name can be arbitrary) to run the proxy software &lt;code>clash&lt;/code>.
We&amp;rsquo;ll make an iptables rule in the following steps to distinguish traffic coming from the user &lt;code>clash&lt;/code>.&lt;/p>
&lt;h3 id="create-iptables-and-routing-rules">Create iptables and routing rules
&lt;/h3>&lt;p>Create a shell script of iptables command called &lt;code>/etc/clash/iptables.sh&lt;/code>.&lt;/p>
&lt;p>The file contains 3 main sections:&lt;/p>
&lt;ol>
&lt;li>iptables rules to hijack the dns query traffic,&lt;/li>
&lt;li>config for &lt;code>clash&lt;/code> chain&lt;/li>
&lt;li>config for &lt;code>clash_local&lt;/code> chain&lt;/li>
&lt;/ol>
&lt;p>iptables:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="cl">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ PREROUTING INPUT â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ /â”€â”€â”€\ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â” â”‚ / \ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”œâ”€â”€â”¤â–ºâ”‚rawâ”œâ”€â–ºâ”‚conntrackâ”œâ”€â–ºâ”‚mangleâ”œâ”€â–ºâ”‚natâ”œâ”€â”¼â”€â”€â”€â”€â”€â”€â–º&amp;lt;routing&amp;gt;â”€â”€â”€â”€â”€â”€â”¤â–ºâ”‚mangleâ”œâ”€â–ºâ”‚filterâ”œâ”€â”¤â–ºâ”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚ \ / â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ \â”€â”¬â”€/ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚mangleâ—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ Network â”‚ â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚ â”‚ Local â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Interfaceâ”‚ â”‚ â”‚ â”‚ FORWARD â”‚ Process â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â” â”‚ /â”€â”€â”€\ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¤filterâ”‚ â”‚ / \ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ &amp;lt;routing&amp;gt;â—„â”€â”¤ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚ \ / â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ \â”€â”¬â”€/ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â” â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚ â”€â”€â”€â”€â”€ â”‚ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â” â”‚ / \ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â” â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚â—„â”€â”¼â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”œâ”€â”€â”€&amp;lt;reroute&amp;gt;â”€â”€â”€â”¼â”€â”¤filterâ”‚â—„â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”€â”¤conntrackâ”‚â—„â”€â”¤rawâ”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ \check/ â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”€â”€â”€â”€â”€ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ POSTROUTING OUTPUT â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>/etc/clash/iptables.sh&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;span class="lnt">115
&lt;/span>&lt;span class="lnt">116
&lt;/span>&lt;span class="lnt">117
&lt;/span>&lt;span class="lnt">118
&lt;/span>&lt;span class="lnt">119
&lt;/span>&lt;span class="lnt">120
&lt;/span>&lt;span class="lnt">121
&lt;/span>&lt;span class="lnt">122
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/bin/env bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># set -ex options:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># -e Exit immediately if a command exits with a non-zero status&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># -x Print commands and their arguments as they are executed.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> -ex
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ENABLE ipv4 forward&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sysctl -w net.ipv4.ip_forward&lt;span class="o">=&lt;/span>&lt;span class="m">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ROUTE RULES&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip rule add fwmark &lt;span class="m">666&lt;/span> table &lt;span class="m">666&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route add &lt;span class="nb">local&lt;/span> 0.0.0.0/0 table &lt;span class="m">666&lt;/span> dev lo
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##################################&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## hijack the dns query traffic ##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##################################&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Redirect all dns query traffic from LAN to port 1053&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Later clash will return a fake ip in 198.18.0.1/16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -I PREROUTING -p udp --dport &lt;span class="m">53&lt;/span> -j REDIRECT --to &lt;span class="m">1053&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># same for ipv6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip6tables -t nat -I PREROUTING -p udp --dport &lt;span class="m">53&lt;/span> -j REDIRECT --to &lt;span class="m">1053&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Redirect dns query traffic from all local processes (except owned by user clash) to port 1053&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Later clash will return a fake ip in 198.18.0.1/16&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -N clash_dns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A OUTPUT -p udp --dport &lt;span class="m">53&lt;/span> -j clash_dns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A clash_dns -m owner --uid-owner clash -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -A clash_dns -p udp -j REDIRECT --to-ports &lt;span class="m">1053&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># same for ipv6&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip6tables -t nat -N clash_dns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip6tables -t nat -A OUTPUT -p udp --dport &lt;span class="m">53&lt;/span> -j clash_dns
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip6tables -t nat -A clash_dns -m owner --uid-owner clash -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip6tables -t nat -A clash_dns -p udp -j REDIRECT --to-ports &lt;span class="m">1053&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##############################&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## config for `clash` chain ##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">##############################&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># `clash` chain for using tproxy to redirect traffic to the clash listening port 7893&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -N clash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># skip traffic to LAN or reserved address&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># reference:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https://en.wikipedia.org/wiki/List_of_assigned_/8_IPv4_address_blocks&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https://en.wikipedia.org/wiki/Private_network#IPv4&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># IANA - Local Identification&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash -d 0.0.0.0/8 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># IANA - Loopback&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash -d 127.0.0.0/8 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># IANA - Private Use&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash -d 10.0.0.0/8 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash -d 172.16.0.0/12 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash -d 192.168.0.0/16 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># IPv4 Link-Local Addresses&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash -d 169.254.0.0/16 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Multicast&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash -d 224.0.0.0/4 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Future Use&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash -d 240.0.0.0/4 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Forward all the other traffic to port 7893 and set tproxy mark&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash -p tcp -j TPROXY --on-port &lt;span class="m">7893&lt;/span> --tproxy-mark &lt;span class="m">666&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash -p udp -j TPROXY --on-port &lt;span class="m">7893&lt;/span> --tproxy-mark &lt;span class="m">666&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Append the `clash` chain to PREROUTING to enable it&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A PREROUTING -j clash
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">####################################&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## config for `clash_local` chain ##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">####################################&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># `clash_local` chain to manipulate the traffic from local process: set fwmark 666 on traffic to public address&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># (which will later reroute to dev lo, then redirect to tproxy port 7893 on the `clash` chain of `PREROUTING`)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -N clash_local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># rerouting traffic from nerdctl container&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#iptables -t mangle -A clash_local -i nerdctl2 -p udp -j MARK --set-mark 666&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#iptables -t mangle -A clash_local -i nerdctl2 -p tcp -j MARK --set-mark 666&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Don&amp;#39;t touch traffic to LAN and reserved address&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash_local -d 0.0.0.0/8 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash_local -d 127.0.0.0/8 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash_local -d 10.0.0.0/8 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash_local -d 172.16.0.0/12 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash_local -d 192.168.0.0/16 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash_local -d 169.254.0.0/16 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash_local -d 224.0.0.0/4 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash_local -d 240.0.0.0/4 -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># set mark for local traffic&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># clash_local set mark for the traffic from local process,&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># the marked traffic will come back to PREROUTING chain.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash_local -p tcp -j MARK --set-mark &lt;span class="m">666&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A clash_local -p udp -j MARK --set-mark &lt;span class="m">666&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Don&amp;#39;t touch traffic from a serving port&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># https web server&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># iptables -t mangle -I OUTPUT -p tcp --sport 443 -j RETURN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># transmission&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># iptables -t mangle -I OUTPUT -p tcp --sport 51413 -j RETURN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Don&amp;#39;t touch traffic from the user `clash` to prevent looping&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A OUTPUT -p tcp -m owner --uid-owner clash -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A OUTPUT -p udp -m owner --uid-owner clash -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># Append the `clash_local` chain to OUTPUT to enable it&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -A OUTPUT -j clash_local
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#######################&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">## unimportant staff ##&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#######################&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># fix ICMP(ping)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># This step does NOT make the ping result validate&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># (clash doesn&amp;#39;t support forwarding ICMP), it just makes ping have a result.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># set --to-destination to a accessable address.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#sysctl -w net.ipv4.conf.all.route_localnet=1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#iptables -t nat -A PREROUTING -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#iptables -t nat -A OUTPUT -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>After applying the script above, the system iptables should be like this:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="cl">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ PREROUTING rule1* INPUT â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚ /â”€â”€â”€\ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”´â”€â” â”‚ / \ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”œâ”€â”€â”¤â–ºâ”‚rawâ”œâ”€â–ºâ”‚conntrackâ”œâ”€â–ºâ”‚mangleâ”œâ”€â–ºâ”‚natâ”œâ”€â”¼â”€â”€â”€â”€â”€â”€â–º&amp;lt;routing&amp;gt;â”€â”€â”€â”€â”€â”€â”¤â–ºâ”‚mangleâ”œâ”€â–ºâ”‚filterâ”œâ”€â”¤â–ºâ”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚ \ / â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚ \â”€â”¬â”€/ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”Œâ”€â”€â”´â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚clashâ”‚ â”‚ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â””â”€â”€â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚mangleâ—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ Network â”‚ â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ Local â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚Interfaceâ”‚ â”‚ â”‚ â”‚ FORWARD â”‚clash_localâ”‚ â”‚ Process â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â” â”‚ â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ /â”€â”€â”€\ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¤filterâ”‚ â”‚ â”‚ / \ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”œâ”€â”€â”€rule3* &amp;lt;routing&amp;gt;â—„â”€â”¤ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ \ / â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”œâ”€â”€â”€rule2* \â”€â”¬â”€/ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â” â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”‚ â”€â”€â”€â”€â”€ â”‚ â”‚ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â” â”‚ / \ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â” â”Œâ”€â”€â”€â”´â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ–¼â”€â”€â” â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚â—„â”€â”¼â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”œâ”€â”€â”€&amp;lt;reroute&amp;gt;â”€â”€â”€â”¼â”€â”¤filterâ”‚â—„â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”€â”¤conntrackâ”‚â—„â”€â”¤rawâ”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â””â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ \check/ â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”¬â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”˜ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”‚ â”‚ â”€â”€â”€â”€â”€ â”‚ â”‚ â”‚ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ POSTROUTING â”‚ OUTPUT â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â” â”‚ â”‚
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚clash_dnsâ”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> *rule1: iptables -t nat -I PREROUTING -p udp --dport 53 -j REDIRECT --to 1053
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> *rule2: iptables -t mangle -A OUTPUT -p tcp -m owner --uid-owner clash -j RETURN
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> *rule3: iptables -t mangle -A OUTPUT -p udp -m owner --uid-owner clash -j RETURN
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>It&amp;rsquo;s also worth to take a look at the route rules in &lt;code>iptables.sh&lt;/code>:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">ip rule add fwmark &lt;span class="m">666&lt;/span> table &lt;span class="m">666&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route add &lt;span class="nb">local&lt;/span> 0.0.0.0/0 table &lt;span class="m">666&lt;/span> dev lo
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>ip rule&lt;/code> manipulates rules in the routing policy database control the route selection algorithm.&lt;/p>
&lt;p>So here the &lt;code>ip rule&lt;/code> command make the kernel to lookup table 666 for packets with fwmark 666&lt;/p>
&lt;p>&lt;a class="link" href="http://linux-ip.net/html/tools-ip-rule.html" target="_blank" rel="noopener"
>ip rule reference is here.&lt;/a>&lt;/p>
&lt;p>The &lt;code>ip route&lt;/code> command add a default route to device lo on routing table 666.&lt;/p>
&lt;p>We can use &lt;code>ip route show table 666&lt;/code> to see the route added by &lt;code>ip route add local 0.0.0.0/0 table 666 dev lo &lt;/code>&lt;/p>
&lt;p>See the route table value and name mapping:
&lt;code>cat /etc/iproute2/rt_tables&lt;/code>&lt;/p>
&lt;h3 id="create-a-cleaning-script">Create a cleaning script
&lt;/h3>&lt;p>Create a shell script to clean the iptables.&lt;/p>
&lt;p>&lt;code>-D&lt;/code> or &lt;code>--delete&lt;/code>:&lt;/p>
&lt;p>Delete one or more rules from the selected chain.
There are two versions of this command:
the rule can be specified as a number in the chain (starting at 1 for the first rule) or a rule to match.&lt;/p>
&lt;p>&lt;code>-F&lt;/code> or &lt;code>--flush&lt;/code>:&lt;/p>
&lt;p>Flush the selected chain (all the chains in the table if none is given).
This is equivalent to deleting all the rules one by one.&lt;/p>
&lt;p>&lt;code>-X&lt;/code> or &lt;code>--delete-chain&lt;/code>:&lt;/p>
&lt;p>Delete the optional user-defined chain specified.
There must be no references to the chain.
If there are, you must delete or replace the referring rules before the chain can be deleted.
The chain must be empty, i.e. not contain any rules.
If no argument is given, it will attempt to delete every non-builtin chain in the table.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/bin/env bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">set&lt;/span> -ex
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip rule del fwmark &lt;span class="m">666&lt;/span> table &lt;span class="m">666&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip route del &lt;span class="nb">local&lt;/span> 0.0.0.0/0 table &lt;span class="m">666&lt;/span> dev lo &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -D PREROUTING -p udp --dport &lt;span class="m">53&lt;/span> -j REDIRECT --to &lt;span class="m">1053&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip6tables -t nat -D PREROUTING -p udp --dport &lt;span class="m">53&lt;/span> -j REDIRECT --to &lt;span class="m">1053&lt;/span> &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -D OUTPUT -p udp --dport &lt;span class="m">53&lt;/span> -j clash_dns &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip6tables -t nat -D OUTPUT -p udp --dport &lt;span class="m">53&lt;/span> -j clash_dns &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -F clash_dns &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t nat -X clash_dns &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip6tables -t nat -F clash_dns &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ip6tables -t nat -X clash_dns &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#iptables -t nat -D PREROUTING -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#iptables -t nat -D OUTPUT -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -D PREROUTING -j clash &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -F clash &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -X clash &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -D OUTPUT -p tcp -m owner --uid-owner clash -j RETURN &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -D OUTPUT -p udp -m owner --uid-owner clash -j RETURN &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -D OUTPUT -j clash_local &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -F clash_local &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">iptables -t mangle -X clash_local &lt;span class="o">||&lt;/span> &lt;span class="nb">true&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="fixing-ping">Fixing ping
&lt;/h3>&lt;p>One major drawback of the fake-ip mode is that you can&amp;rsquo;t ping a fake ip.&lt;/p>
&lt;p>The solution above to redirect all ping request to the localhost is &amp;ldquo;æŽ©è€³ç›—é“ƒ&amp;rdquo;, it doesn&amp;rsquo;t provide any useful information.&lt;/p>
&lt;p>Sadly, all devices from LAN can&amp;rsquo;t use ping, but fortunately you can alias ping to &lt;code>sudo -u clash ping&lt;/code> for this gateway to use ping.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">alias&lt;/span> &lt;span class="nv">ping&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;sudo -u clash ping&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="provide-a-systemd-unit-file-to-start-clash-at-a-single-command">Provide a systemd unit file to start clash at a single command
&lt;/h3>&lt;p>This step is optional, but I felt it&amp;rsquo;s extremely convenient to start clash by running a single command.&lt;/p>
&lt;p>You can also make clash start at boot time.&lt;/p>
&lt;p>The systemd config file is in the appended files with the name &lt;code>clash.service&lt;/code>&lt;/p>
&lt;p>put it under &lt;code>/usr/lib/systemd/system&lt;/code>, and run &lt;code>sudo systemctl start clash&lt;/code> to start running clash.&lt;/p>
&lt;p>To start it at boot time, run &lt;code>sudo systemctl enable clash&lt;/code>.&lt;/p>
&lt;h3 id="configuring-clash">Configuring clash
&lt;/h3>&lt;p>Now let&amp;rsquo;s set clash up to work.&lt;/p>
&lt;p>Clash use &lt;code>-d&lt;/code> option to set configuration directory and &lt;code>-f&lt;/code> option to specify configuration file.&lt;/p>
&lt;p>The default configuration file name is &lt;code>config.yaml&lt;/code> when &lt;code>-f&lt;/code> is omitted.&lt;/p>
&lt;p>We want to use &lt;code>crontab&lt;/code> to periodically update the clash config from a subscription url.&lt;/p>
&lt;h4 id="construct-the-subscription-url">Construct the subscription URL
&lt;/h4>&lt;p>TL;DR. Just replace &lt;code>XXXXXXXX&lt;/code> with your &lt;a class="link" href="https://www.urlencoder.io/" target="_blank" rel="noopener"
>encoded&lt;/a> subscription URL .&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">https://sub.xeton.dev/sub?target=clash&amp;amp;new_name=true&amp;amp;filename=config.yaml&amp;amp;url=XXXXXXXX&amp;amp;config=https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>We use &lt;a class="link" href="https://github.com/tindy2013/subconverter" target="_blank" rel="noopener"
>subconverter&lt;/a> to generate config file for clash.&lt;/p>
&lt;p>You need to change a few parameters in the subscription URL
to generate a proper config file for clash to work in fake-ip mode.&lt;/p>
&lt;p>To be specific:&lt;/p>
&lt;ol>
&lt;li>the &lt;code>url&lt;/code> parameter should be the correct subscription URL and &lt;a class="link" href="https://www.urlencoder.io/" target="_blank" rel="noopener"
>encoded&lt;/a>.&lt;/li>
&lt;li>Multiple subscription URL should be seperated by &lt;code>|&lt;/code>, or &lt;code>%7C&lt;/code> after &lt;a class="link" href="https://www.urlencoder.io/" target="_blank" rel="noopener"
>URL Encoding&lt;/a>.&lt;/li>
&lt;li>the &lt;code>config&lt;/code> parameter should point to &lt;a class="link" href="https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/config.ini" target="_blank" rel="noopener"
>a correct configuration file&lt;/a>. âš ï¸&lt;/li>
&lt;/ol>
&lt;p>âš ï¸ NOTICE: the configuration file for subconverter is extremely important!&lt;/p>
&lt;p>&lt;a class="link" href="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini" target="_blank" rel="noopener"
>ACL4SSR project provide a default configuration file for subconverter&lt;/a>, it&amp;rsquo;s fine but NOT ENOUGH for clash to work on fake-ip mode.&lt;/p>
&lt;p>To make it work, you need specify &lt;code>clash_rule_base&lt;/code> by inserting this line to &lt;a class="link" href="https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini" target="_blank" rel="noopener"
>the configuration file for &lt;strong>subconverter&lt;/strong>&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">clash_rule_base=https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/clash-base-config.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>What this line does is that it tells the subconverter to use &lt;a class="link" href="https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/clash-base-config.yaml" target="_blank" rel="noopener"
>the file in the url above&lt;/a> instead of the default clash base configuration.&lt;/p>
&lt;p>Or you can just use &lt;a class="link" href="https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/config.ini" target="_blank" rel="noopener"
>the config.ini here&lt;/a>&lt;/p>
&lt;p>Sample url:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-txt" data-lang="txt">&lt;span class="line">&lt;span class="cl">https://sub.xeton.dev/sub? --- backend address
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">target=clash --- client type
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;amp;new_name=true --- create a new filename
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;amp;filename=config.yaml --- filename
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;amp;url= --- Node info
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ss%3A%2F%2FYmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg%23example-server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">%7C --- the delimiter | to seperate multiple urls
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">ss%3A%2F%2FYmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg%23example-server-2
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;amp;config= --- config file for subconverter; .ini format
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --- options below is unnecessary and can be omitted
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;amp;list=false --- ç”¨äºŽè¾“å‡º Surge Node List æˆ–è€… Clash Proxy Provider æˆ–è€… Quantumult (X) çš„èŠ‚ç‚¹è®¢é˜… æˆ–è€… è§£ç åŽçš„ SIP002
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;amp;tfo=false --- ç”¨äºŽå¼€å¯è¯¥è®¢é˜…é“¾æŽ¥çš„ TCP Fast Openï¼Œé»˜è®¤ä¸º false
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;amp;scv=false --- ç”¨äºŽå…³é—­ TLS èŠ‚ç‚¹çš„è¯ä¹¦æ£€æŸ¥ï¼Œé»˜è®¤ä¸º false
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;amp;fdn=false --- ç”¨äºŽè¿‡æ»¤ç›®æ ‡ç±»åž‹ä¸æ”¯æŒçš„èŠ‚ç‚¹ï¼Œé»˜è®¤ä¸º true
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;amp;sort=false --- ç”¨äºŽå¯¹è¾“å‡ºçš„èŠ‚ç‚¹æˆ–ç­–ç•¥ç»„æŒ‰èŠ‚ç‚¹åè¿›è¡Œå†æ¬¡æŽ’åºï¼Œé»˜è®¤ä¸º false
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="set-up-a-cronjob">Set up a cronjob
&lt;/h4>&lt;p>Create a shell script &lt;code>/etc/clash/update-config.sh&lt;/code> with the following content:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/usr/bin/env bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="nb">set&lt;/span> -ex
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/bin/curl &lt;span class="s2">&amp;#34;https://sub.xeton.dev/sub?target=clash&amp;amp;new_name=true&amp;amp;filename=config.yaml&amp;amp;url=XXXXXXXX&amp;amp;config=https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini&amp;#34;&lt;/span> -o /etc/clash/config.yaml
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>âš ï¸ The URL should be replace.&lt;/p>
&lt;p>Manually executing it to make sure the config file is generated successfully.&lt;/p>
&lt;p>Make sure you have the following contents in your &lt;code>config.yaml&lt;/code> file for clash:&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">tproxy-port&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">7893&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">dns&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">enable&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">listen&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0.0.0.0&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="m">1053&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">enhanced-mode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">fake-ip&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="nt">fake-ip-range&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">198.18.0.1&lt;/span>&lt;span class="l">/16&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Add a &lt;a class="link" href="https://crontab.guru" target="_blank" rel="noopener"
>cronjob&lt;/a> by executing &lt;code>sudo crontab -e&lt;/code> and add this line to executing the script at 10:00 AM every day.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="m">0&lt;/span> &lt;span class="m">10&lt;/span> * * * /usr/bin/bash /etc/clash/update-config.sh
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>I'm Back</title><link>https://cld4h.github.io/blog/p/im-back/</link><pubDate>Fri, 11 Feb 2022 11:43:02 +0800</pubDate><guid>https://cld4h.github.io/blog/p/im-back/</guid><description>&lt;p>æˆ‘å›žæ¥å•¦ï¼&lt;/p>
&lt;p>å°†hugoæ¢äº†ä¸€ä¸ªä¸»é¢˜ï¼Œä»ŽåŽŸæ¥æ–‡æ¡£ç±»çš„ä¸»é¢˜&lt;a class="link" href="https://learn.netlify.app/en/" target="_blank" rel="noopener"
>learn&lt;/a> æ¢æˆäº†&lt;a class="link" href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener"
>stack&lt;/a>ã€‚&lt;/p>
&lt;p>æ¯•ç«Ÿåœ¨å½“ä¸‹è¿™ç§é£Žå£°é¹¤å”³çš„è¨€è®ºçŽ¯å¢ƒä¸­ï¼Œä¹Ÿå°±èƒ½å†™ç‚¹æŠ€æœ¯ç±»çš„ä¸œè¥¿ã€‚
æœ¬æ¥å¹³æ—¶çœ‹æ–‡æ¡£å°±è¦çœ‹åäº†ï¼Œä¸ªäººåšå®¢ä½•è‹¦è¿˜è¦æžä¸ªå¤§æ–‡æ¡£å‡ºæ¥å‘¢ï¼Ÿ&lt;/p>
&lt;p>æ–‡ç« è¿˜æ˜¯è¦å¤šå†™çš„ï¼Œä»¥é˜²ä¸§å¤±è¯­è¨€èƒ½åŠ›ã€‚&lt;/p>
&lt;p>æˆ‘è®¡åˆ’ä»¥åŽæ¯å¤©ï¼ˆè‡³å°‘æ¯å‘¨ï¼‰éƒ½è¦å†™ç‚¹ä¸œè¥¿ã€‚&lt;/p>
&lt;p>è‡³å°‘æŠŠè‡ªå·±æƒ³äº†ç‚¹å•¥ã€å¹²äº†ç‚¹å•¥è®°ä¸‹æ¥ï¼Œæ™šä¸Šå°±èƒ½ç¡ä¸ªå¥½è§‰äº†ã€‚&lt;/p></description></item><item><title>Links I "consoom"</title><link>https://cld4h.github.io/blog/p/links-i-consoom/</link><pubDate>Wed, 28 Apr 2021 22:21:40 +0800</pubDate><guid>https://cld4h.github.io/blog/p/links-i-consoom/</guid><description>&lt;table>
&lt;thead>
&lt;tr>
&lt;th>Name&lt;/th>
&lt;th>http&lt;/th>
&lt;th>rss&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>Luke Smith&lt;/td>
&lt;td>&lt;a class="link" href="https://lukesmith.xyz" target="_blank" rel="noopener"
>https://lukesmith.xyz&lt;/a>&lt;/td>
&lt;td>&lt;a class="link" href="https://lukesmith.xyz/rss.xml" target="_blank" rel="noopener"
>https://lukesmith.xyz/rss.xml&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Luke Smith (peertube)&lt;/td>
&lt;td>&lt;a class="link" href="https://videos.lukesmith.xyz" target="_blank" rel="noopener"
>https://videos.lukesmith.xyz&lt;/a>&lt;/td>
&lt;td>&lt;a class="link" href="https://lukesmith.xyz/videos" target="_blank" rel="noopener"
>https://lukesmith.xyz/videos&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Not Related!&lt;/td>
&lt;td>&lt;a class="link" href="https://notrelated.xyz/" target="_blank" rel="noopener"
>https://notrelated.xyz/&lt;/a>&lt;/td>
&lt;td>&lt;a class="link" href="https://notrelated.xyz/rss" target="_blank" rel="noopener"
>https://notrelated.xyz/rss&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å®˜å¤§ç‚º - Wiwi Kuan&lt;/td>
&lt;td>&lt;a class="link" href="https://wiwikuan.com" target="_blank" rel="noopener"
>https://wiwikuan.com&lt;/a>&lt;/td>
&lt;td>&lt;a class="link" href="https://wiwikuan.com/index.xml" target="_blank" rel="noopener"
>https://wiwikuan.com/index.xml&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>Wiwi.Video å¥½å’Œå¼¦è¯æ’­ç¶²&lt;/td>
&lt;td>&lt;a class="link" href="https://wiwi.video" target="_blank" rel="noopener"
>https://wiwi.video&lt;/a>&lt;/td>
&lt;td>&lt;a class="link" href="https://wiwi.video/feeds/videos.atom?sort=-publishedAt" target="_blank" rel="noopener"
>https://wiwi.video/feeds/videos.atom?sort=-publishedAt&lt;/a>&lt;/td>
&lt;/tr>
&lt;tr>
&lt;td>å¥½æª¸æª¬ NiceLemon&lt;/td>
&lt;td>&lt;a class="link" href="https://nicelemon.libsyn.com/" target="_blank" rel="noopener"
>https://nicelemon.libsyn.com/&lt;/a>&lt;/td>
&lt;td>&lt;a class="link" href="http://nicelemon.libsyn.com/rss" target="_blank" rel="noopener"
>http://nicelemon.libsyn.com/rss&lt;/a>&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table></description></item><item><title>Raw HTML in Hugo</title><link>https://cld4h.github.io/blog/p/raw-html-in-hugo/</link><pubDate>Wed, 21 Apr 2021 20:30:32 +0800</pubDate><guid>https://cld4h.github.io/blog/p/raw-html-in-hugo/</guid><description>&lt;p>&lt;a class="link" href="https://anaulin.org/blog/hugo-raw-html-shortcode/" target="_blank" rel="noopener"
>Reference1&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://dyiwu.github.io/2019/04/escape-hugo-shortcode/" target="_blank" rel="noopener"
>Reference2-escaping shortcode in hugo&lt;/a>&lt;/p>
&lt;p>åˆ›å»º &lt;code>layouts/shortcodes/rawhtml.html&lt;/code> æ–‡ä»¶å¦‚ä¸‹&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="line">&lt;span class="cl">&lt;span class="c">&amp;lt;!-- raw html --&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{{.Inner}}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯ä»¥é€šè¿‡å¦‚ä¸‹æ–¹å¼ä½¿ç”¨&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">{{&amp;lt; rawhtml &amp;gt;}}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;p class=&amp;#34;speshal-fancy-custom&amp;#34;&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> This is &amp;lt;strong&amp;gt;raw HTML&amp;lt;/strong&amp;gt;, inside Markdown.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">{{&amp;lt; /rawhtml &amp;gt;}}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>RSS in hugo</title><link>https://cld4h.github.io/blog/p/rss-in-hugo/</link><pubDate>Tue, 20 Apr 2021 10:33:50 +0800</pubDate><guid>https://cld4h.github.io/blog/p/rss-in-hugo/</guid><description>&lt;p>Update: Somehow I found it&amp;rsquo;s no longer needed in the &lt;a class="link" href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener"
>stack&lt;/a> theme.&lt;/p>
&lt;p>&lt;a class="link" href="https://gohugo.io/templates/rss/" target="_blank" rel="noopener"
>Official docs Reference&lt;/a>&lt;/p>
&lt;p>I copied the &lt;a class="link" href="https://github.com/gohugoio/hugo/blob/master/tpl/tplimpl/embedded/templates/_default/rss.xml" target="_blank" rel="noopener"
>default RSS template that ships with Hugo&lt;/a> and changed line 28.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">28c28
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;lt; {{ range $pages }}
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">---
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&amp;gt; {{ range .Site.Pages }}
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>I added the following line to my &lt;code>layouts/partials/menu-footer.html&lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">&amp;lt;p&amp;gt;&amp;lt;a href=&amp;#34;{{.Site.BaseURL}}/index.xml&amp;#34;&amp;gt;&amp;lt;i class=&amp;#34;fas fa-rss&amp;#34;&amp;gt;&amp;lt;/i&amp;gt; RSS&amp;lt;/a&amp;gt;&amp;lt;/p&amp;gt;
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>Start Hugo</title><link>https://cld4h.github.io/blog/p/start-hugo/</link><pubDate>Wed, 24 Mar 2021 12:18:03 +0800</pubDate><guid>https://cld4h.github.io/blog/p/start-hugo/</guid><description>&lt;p>First install hugo on your system&lt;/p>
&lt;p>Choose a folder to run this command&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">hugo new site blog
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;code>cd&lt;/code> into your site folder,
init a &lt;code>git&lt;/code> repo,
and add a theme.&lt;/p>
&lt;p>In my case I forked the &lt;a class="link" href="https://github.com/matcornic/hugo-theme-learn" target="_blank" rel="noopener"
>learn&lt;/a> theme in case I want to modify it.&lt;/p>
&lt;p>I then added the original branch as &amp;ldquo;learn&amp;rdquo; to track new updates.&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> blog
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git init
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git submodule add git@github.com:cld4h/hugo-theme-learn.git themes/learn
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> themes/learn
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git remote add -f learn https://github.com/matcornic/hugo-theme-learn.git
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">git diff learn/master origin/master
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>change the &lt;code>config.toml&lt;/code> file&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-toml" data-lang="toml">&lt;span class="line">&lt;span class="cl">&lt;span class="c"># Change the default theme to be use when building the site with Hugo&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">theme&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;learn&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c"># For search functionality&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="p">[&lt;/span>&lt;span class="nx">outputs&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nx">home&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="p">[&lt;/span> &lt;span class="s2">&amp;#34;HTML&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;RSS&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;JSON&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>How this Chapter and this page is added&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">hugo new --kind chapter hugo/_index.md
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">hugo new hugo/start.md
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>Start locally&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">hugo serve -D
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&lt;a class="link" href="https://learn.netlify.app/en/" target="_blank" rel="noopener"
>Learn theme docs&lt;/a>&lt;/p></description></item><item><title>LaTeX tips</title><link>https://cld4h.github.io/blog/p/latex-tips/</link><pubDate>Mon, 21 Oct 2019 00:00:00 +0000</pubDate><guid>https://cld4h.github.io/blog/p/latex-tips/</guid><description>&lt;h2 id="beamer">Beamer
&lt;/h2>&lt;h3 id="åœ¨beamerä¸­æ’å…¥å›¾ç‰‡">åœ¨Beamerä¸­æ’å…¥å›¾ç‰‡
&lt;/h3>&lt;p>(å¯å‚è§Beameræ–‡æ¡£12.6èŠ‚)&lt;/p>
&lt;p>figure çŽ¯å¢ƒç¤ºä¾‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-tex" data-lang="tex">&lt;span class="line">&lt;span class="cl">&lt;span class="k">\begin&lt;/span>&lt;span class="nb">{&lt;/span>figure&lt;span class="nb">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">\centering&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">\includegraphics&lt;/span>&lt;span class="na">[width=\textwidth]&lt;/span>&lt;span class="nb">{&lt;/span>pic/F1.png&lt;span class="nb">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">\caption&lt;/span>&lt;span class="nb">{&lt;/span>å›¾ä¸­æ¯ä¸ªæ–¹å—ä»£è¡¨äº¤æ˜“ï¼Œå³ä¸‹è§’çš„æ•°å­—è¡¨ç¤ºäº¤æ˜“æœ¬èº«çš„æƒé‡ï¼Œç²—ä½“å­—è¡¨ç¤ºç´¯ç§¯æƒé‡ã€‚&lt;span class="nb">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">\label&lt;/span>&lt;span class="nb">{&lt;/span>fig:bef&lt;span class="nb">}&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">\end&lt;/span>&lt;span class="nb">{&lt;/span>figure&lt;span class="nb">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ä¸ºäº†ä½¿å›¾ç‰‡çš„captionæœ‰æ•°å­—æ ‡å·ï¼Œåœ¨å¯¼è¨€åŒºåŠ å…¥ä¸‹è¿°å†…å®¹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-tex" data-lang="tex">&lt;span class="line">&lt;span class="cl">&lt;span class="k">\setbeamertemplate&lt;/span>&lt;span class="nb">{&lt;/span>caption&lt;span class="nb">}&lt;/span>[numbered]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="ä»Žmarkdownç¼–è¯‘beamer-presentation">ä»Žmarkdownç¼–è¯‘Beamer presentation
&lt;/h3>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl">pandoc talk.md -t beamer -o talk.pdf --pdf-engine=xelatex -V mainfont=æ€æºå®‹ä½“
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div></description></item><item><title>lrlr</title><link>https://cld4h.github.io/blog/p/lrlr/</link><pubDate>Tue, 17 Sep 2019 19:11:45 +0800</pubDate><guid>https://cld4h.github.io/blog/p/lrlr/</guid><description>&lt;p>é¢˜ç›®æ¥æº&lt;/p>
&lt;p>&lt;a class="link" href="https://adworld.xctf.org.cn/media/uploads/task/207689abfdd54b5382ef06739ec1e318.zip" target="_blank" rel="noopener"
>2019 å­—èŠ‚è·³åŠ¨ bytectf crypto lrlr&lt;/a>&lt;/p>
&lt;p>å‚è€ƒ&lt;/p>
&lt;p>&lt;a class="link" href="https://xz.aliyun.com/t/6324#toc-25" target="_blank" rel="noopener"
>Team: W&amp;amp;M&lt;/a>&lt;/p>
&lt;p>&lt;a class="link" href="https://196011564.github.io/2018/12/11/CTF-JarvisOJ-Crypto-[61dctf]bbencode/index.html" target="_blank" rel="noopener"
>Jarvis oj crypto&lt;/a>&lt;/p>
&lt;h2 id="å…ˆå…¨æ–‡æ‘˜æŠ„å¤§ä½¬çš„-write-up">å…ˆå…¨æ–‡æ‘˜æŠ„å¤§ä½¬çš„ Write Up
&lt;/h2>&lt;p>é€šè¿‡oldçš„1000ç»„å¯ä»¥é¢„æµ‹pythonéšæœºæ•°ï¼Œ
&lt;a class="link" href="https://github.com/tna0y/Python-random-module-cracker" target="_blank" rel="noopener"
>https://github.com/tna0y/Python-random-module-cracker&lt;/a>&lt;/p>
&lt;p>ä¸€å…±2è½®aesåŠ å¯†ï¼Œæ—¢ç„¶å¯†é’¥å¯ä»¥é¢„æµ‹å‡ºæ¥ï¼Œè‡ªç„¶å°±èƒ½è§£å¯†å¾—åˆ°clistã€‚&lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/lrlr/lrlr.png"
width="1078"
height="1350"
srcset="https://cld4h.github.io/blog/p/lrlr/lrlr_hu_eb000d64b62d1d35.png 480w, https://cld4h.github.io/blog/p/lrlr/lrlr_hu_b2efec2eedc82ef2.png 1024w"
loading="lazy"
alt="lrlr.png"
class="gallery-image"
data-flex-grow="79"
data-flex-basis="191px"
>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-py" data-lang="py">&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">Crypto.Util.number&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">getPrime&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bytes_to_long&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">long_to_bytes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">Crypto.Cipher&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">AES&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">random&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">randcrack&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">RandCrack&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">rc&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">RandCrack&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;old&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">old&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">index&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="mi">624&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">rc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">submit&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">old&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">index&lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">1000&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">624&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">assert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">old&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">index&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">==&lt;/span>&lt;span class="n">rc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">predict_getrandbits&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">index&lt;/span>&lt;span class="o">+=&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;cl&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">nlist&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nb">eval&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">with&lt;/span> &lt;span class="nb">open&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;new&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">as&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">clist&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;hex&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">file&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">read&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">strip&lt;/span>&lt;span class="p">()&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">split&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="p">)]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">key1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">key2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">key3&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">key1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">predict_getrandbits&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">key2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">predict_getrandbits&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">key3&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">rc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">predict_getrandbits&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">128&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">tmp1&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">AES&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">long_to_bytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key3&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]),&lt;/span> &lt;span class="n">AES&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MODE_CBC&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\x00&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tmpstate&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">handle&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decrypt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">clist&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tmp1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tmpstate&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">tmp2&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">24&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">handle&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">AES&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">new&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">long_to_bytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">key2&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]),&lt;/span> &lt;span class="n">AES&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">MODE_CBC&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="se">\x00&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="mi">16&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tmpstate&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">handle&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decrypt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tmp1&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">tmp2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">tmpstate&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># tmp3=[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># for i in range(24):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># handle = AES.new(long_to_bytes(key1[i]), AES.MODE_CBC, &amp;#34;\x00&amp;#34;*16)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># tmpstate=handle.decrypt(tmp2[i])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># tmp3.append(tmpstate)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">c&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="p">[]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">tmp2&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">c&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">append&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">bytes_to_long&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">))&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">17&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;n = &lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="n">nlist&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;e = 17&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;c = &lt;/span>&lt;span class="si">%d&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="n">c&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s1">&amp;#39;&lt;/span>&lt;span class="se">\n&lt;/span>&lt;span class="s1">&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>ç„¶åŽæœ‰äº†24ç»„n,cï¼›e=17ã€‚éšä¾¿é€‰æ‹©17ç»„åŽ»å¹¿æ’­æ”»å‡»&lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/lrlr/rsa_solve.png"
width="1098"
height="206"
srcset="https://cld4h.github.io/blog/p/lrlr/rsa_solve_hu_1c8b6d3fc8092a61.png 480w, https://cld4h.github.io/blog/p/lrlr/rsa_solve_hu_d32c274470ed4880.png 1024w"
loading="lazy"
alt="rsa_solve"
class="gallery-image"
data-flex-grow="533"
data-flex-basis="1279px"
>&lt;/p>
&lt;p>æœ€åŽä¸€æ­¥ç±»ä¼¼jarvis ojä¸Šçš„bbencodeåŽŸé¢˜ï¼Œå¾ªçŽ¯ç¼–ç ï¼Œåˆ¤æ–­flagå¼€å¤´çš„å­—ç¬¦ä¸²&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-py" data-lang="py">&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">bbencode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">bin&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">n&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:]:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">&amp;lt;&amp;lt;&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">^&lt;/span> &lt;span class="n">n&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">&amp;gt;&amp;gt;&lt;/span> &lt;span class="mi">256&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">a&lt;/span> &lt;span class="o">^&lt;/span> &lt;span class="mh">0x10000000000000000000000000000000000000000000000000000000000000223&lt;/span>&lt;span class="n">L&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">a&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">61406796444626535559771097418338494728649815464609781204026855332620301752444&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">10000&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">result&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">bbencode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;666c6167&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">))[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">]):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="n">i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="nb">hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">)[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">decode&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s1">&amp;#39;hex&amp;#39;&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="ä¸‹é¢å†™ä¸‹ç»†èŠ‚">ä¸‹é¢å†™ä¸‹ç»†èŠ‚
&lt;/h2>&lt;p>é€šè¿‡ &lt;code>oldtest()&lt;/code> ä¸­ &lt;code>random.getrandbits()&lt;/code> å‡½æ•°ç”Ÿæˆçš„éšæœºæ•°å¯ä»¥ç”¨ &lt;code>randcrack&lt;/code> åº“æŽ¨æ–­åˆ°ä¹‹åŽ &lt;code>lrandout()&lt;/code> ä¸­è°ƒç”¨ &lt;code>stateconvert()&lt;/code> å’Œ &lt;code>gen_new_states()&lt;/code> æ—¶ç”Ÿæˆçš„128ä½éšæœºæ•°ã€‚&lt;/p>
&lt;p>æ­¤éšæœºæ•°ç›´æŽ¥ä½œä¸ºAES-128åŠ å¯†çš„å¯†é’¥å¯¹ &lt;code>clist[]&lt;/code> è¿›è¡ŒåŠ å¯†ï¼ŒIVå€¼ä¸º128ä½0 ã€‚&lt;/p>
&lt;p>åŠ å¯†åŽçš„ç»“æžœAppendåˆ° &lt;code>states[]&lt;/code> åŽï¼Œç”¨çš„æ—¶å€™å†é€šè¿‡ &lt;code>stateconvert&lt;/code> è¿›è¡Œç¬¬äºŒæ¬¡AESåŠ å¯†(åˆå§‹æ—¶(ä¹Ÿå°±æ˜¯ &lt;code>newtest&lt;/code> ä¸­ç¬¬ä¸€ä¸ªå¾ªçŽ¯) &lt;code>states[]&lt;/code> æ•°ç»„ä¸­ä¸ºé•¿åº¦ä¸º24çš„ &lt;code>clist[]&lt;/code> ä¸” &lt;code>stateselse == 24&lt;/code> æ‰€ä»¥ç›´æŽ¥è°ƒç”¨ &lt;code>stateconvert&lt;/code> ä¸€æ¬¡åŠ å¯†å¾—åˆ°è¾“å‡º)&lt;/p>
&lt;p>æˆ‘ä»¬çŽ°åœ¨å·²çŸ¥äºŒæ¬¡AESåŠ å¯†åŽçš„ç»“æžœï¼›å·²çŸ¥ &lt;code>nlist[]&lt;/code>ï¼›éœ€è¦å…ˆç”±éšæœºæ•°ç”Ÿæˆè§„å¾‹æŽ¨æ–­å‡ºä½œä¸ºå¯†é’¥çš„éšæœºæ•°ï¼Œé€šè¿‡AESè§£å¯†å¾—åˆ° &lt;code>clist[]&lt;/code>ï¼›ç„¶åŽçœ‹ &lt;code>gen_states&lt;/code> å‡½æ•°å‘çŽ° &lt;code>clist[]&lt;/code> ä¸­çš„å…ƒç´ æ˜¯åŒä¸€ä¸ªæ¶ˆæ¯(&lt;code>init_state&lt;/code>) ä»¥ $e=17$ ä¸ºæŒ‡æ•°æ¨¡ä¸åŒçš„ $n$ å€¼æ‰€å¾—ã€‚æ­¤å¤„å¯ä»¥è¿›è¡Œä½ŽæŒ‡æ•°å¹¿æ’­æ”»å‡»ã€‚&lt;/p>
&lt;h3 id="ä½ŽæŒ‡æ•°å¹¿æ’­æ”»å‡»">ä½ŽæŒ‡æ•°å¹¿æ’­æ”»å‡»
&lt;/h3>&lt;p>&lt;a class="link" href="https://xz.aliyun.com/t/2731#toc-10" target="_blank" rel="noopener"
>å‚è€ƒ ä¸€å¶é£˜é›¶ çš„ Crypto-RSA-å…¬é’¥æ”»å‡»å°ç»“&lt;/a>
&lt;a class="link" href="https://github.com/ashutosh1206/Crypton/tree/master/RSA-encryption/Attack-Hastad-Broadcast" target="_blank" rel="noopener"
>å‚è€ƒ ashutosh1206 çš„ Hastad&amp;rsquo;s Broadcast Attack&lt;/a>
æ‰€è°“â€œä½ŽæŒ‡æ•°â€ï¼ŒæŒ‡çš„æ˜¯æŒ‡æ•° $e &amp;lt;= \text{å¹¿æ’­æˆå‘˜æ•°é‡(åŠ å¯†çš„æ¶ˆæ¯æ•°é‡)}$&lt;/p>
&lt;!--å‡è®¾ Alice æƒ³è¦ç»™ 3 ä¸ªä¸åŒçš„äººå‘é€ç›¸åŒçš„æ¶ˆæ¯ $M$, å¯¹æ¯ä¸ªäººä½¿ç”¨åŒæ ·çš„å…¬é’¥æŒ‡æ•° $e$ å’Œä¸åŒçš„ $n$-->
&lt;h4 id="ä¸­å›½å‰©ä½™å®šç†">ä¸­å›½å‰©ä½™å®šç†
&lt;/h4>&lt;p>å¯¹äºŽä¸‹é¢çš„ä¸€å…ƒçº¿æ€§åŒä½™æ–¹ç¨‹ç»„ï¼š&lt;/p>
$$
\begin{equation*}
\left\lbrace
\begin{aligned}
x \equiv &amp; a_1 \bmod m_{1}\\
x \equiv &amp; a_2 \bmod m_{2}\\
&amp; \vdots\\
x \equiv &amp; a_n \bmod m_{n}\\
\end{aligned}
\right.
\end{equation*}
$$
&lt;p>å‡è®¾$m_1,m_2,\ldots,m_n$ä¸­ä»»æ„ä¸¤æ•°äº’è´¨ï¼Œåˆ™å¯¹ä»»æ„æ•´æ•°$a_1,a_2,\ldots,a_n$ï¼Œä¸Šè¿°æ–¹ç¨‹ç»„æœ‰è§£ï¼Œé€šè§£çš„æž„é€ æ–¹æ³•å¦‚ä¸‹ï¼š&lt;/p>
&lt;ol>
&lt;li>è®¾$M = m_1\times m_2\times \cdots \times m_{n} = \prod\limits_{i=1}^{n} m_{i} $ æ˜¯æ•´æ•°$m_1,m_2,\ldots,m_{n}$ çš„ä¹˜ç§¯&lt;/li>
&lt;li>è®¾$M_{i} = M / m_{i}, \forall i \in {1,2,\ldots,n}$&lt;/li>
&lt;li>è®¾$t_{i} = M_{i}^{-1}$ ä¸º$M_{i}$ æ¨¡$m_{i}$ çš„æ•°è®ºå€’æ•°&lt;/li>
&lt;li>æ–¹ç¨‹ç»„çš„é€šè§£å½¢å¼ä¸ºï¼š
$$
x = a_1t_1M_1+a_2t_2M_2+\cdots+a_{n}t_{n}M_{n} = kM+\sum_{i=1}^{n} a_{i}t_{i}M_{i},\qquad \forall k \in \mathbb{Z}.
$$
åœ¨æ¨¡$M$ çš„æ„ä¹‰ä¸‹æ–¹ç¨‹ç»„åªæœ‰ä¸€ä¸ªè§£ï¼š
$$
x=\sum_{i=1}^{n} a_{i}t_{i}M_{i}
$$&lt;/li>
&lt;/ol>
&lt;p>å› æ­¤ï¼Œå¯¹äºŽæœ¬é¢˜&lt;/p>
$$
\begin{equation*}
\left\lbrace
\begin{aligned}
m^{17} \equiv &amp; c_1 \bmod n_1\\
m^{17} \equiv &amp; c_2 \bmod n_2\\
&amp; \vdots\\
m^{17} \equiv &amp; c_{17} \bmod n_{17}\\
\end{aligned}
\right.
\end{equation*}
$$
&lt;p>(è¦æ±‚$n_1,n_2,\ldots,n_{17}$ä¸¤ä¸¤äº’ç´ ï¼Œè‹¥ä¸æ»¡è¶³ä¸¤ä¸¤äº’ç´ ï¼Œå¯è¿›è¡Œ&lt;a class="link" href="https://github.com/ashutosh1206/Crypton/tree/master/RSA-encryption/Attack-Common-Prime" target="_blank" rel="noopener"
>å…±æ¨¡æ”»å‡»&lt;/a>)æœ‰&lt;/p>
&lt;p>$$
m^{17} = \sum_{i=1}^{17} c_{i}N_{i}N_{i}^{-1} mod N
$$&lt;/p>
&lt;p>å…¶ä¸­ï¼Œ&lt;/p>
&lt;p>$
N = n_1\times n_2\times \cdots \times n_{17} = \prod\limits_{i=1}^{17} n_{i}
$ï¼›&lt;/p>
&lt;p>$
N_{i} = N / n_{i}
$ï¼›&lt;/p>
&lt;p>$
N_{i}^{-1} \cdot N_{i} \equiv 1 \bmod n_{i}
$&lt;/p>
&lt;p>å› ä¸º$m &amp;lt; n_{i} \quad \forall i \in {1,2,\ldots,17}$ï¼Œæ‰€ä»¥$ m^{17} &amp;lt; N = \prod\limits_{i=1}^{17} n_{i}$ ç›´æŽ¥å¼€æ–¹å³å¯ã€‚&lt;/p>
&lt;h4 id="hastad_unpaddedpy">hastad_unpadded.py
&lt;/h4>&lt;p>&lt;a class="link" href="https://github.com/ashutosh1206/Crypton/blob/master/RSA-encryption/Attack-Hastad-Broadcast/hastad_unpadded.py" target="_blank" rel="noopener"
>å‚è€ƒ&lt;/a>
åªéœ€å…³æ³¨ &lt;code>crt&lt;/code> å‡½æ•°å’Œ &lt;code>hastad_unpadded&lt;/code> å‡½æ•°å³å¯&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-py" data-lang="py">&lt;span class="line">&lt;span class="cl">&lt;span class="ch">#!/usr/bin/env python2.7&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">from&lt;/span> &lt;span class="nn">Crypto.Util.number&lt;/span> &lt;span class="kn">import&lt;/span> &lt;span class="n">GCD&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">bytes_to_long&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">long_to_bytes&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="kn">import&lt;/span> &lt;span class="nn">gmpy2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">crt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_a&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">list_m&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Reference: https://crypto.stanford.edu/pbc/notes/numbertheory/crt.html
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Returns the output after computing Chinese Remainder Theorem on
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> x = a_1 mod m_1
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> x = a_2 mod m_2
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> ...
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> x = a_n mod m_n
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> input parameter list_a = [a_1, a_2, ..., a_n]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> input parameter list_m = [m_1, m_2, ..., m_n]
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Returns -1 if the operation is unsuccessful due to some exceptions
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">assert&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_a&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_m&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;[+] Length of list_a should be equal to length of list_m&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_m&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">j&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_m&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">GCD&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">list_m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">])&lt;/span>&lt;span class="o">!=&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="ow">and&lt;/span> &lt;span class="n">i&lt;/span>&lt;span class="o">!=&lt;/span>&lt;span class="n">j&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;[+] Moduli should be pairwise co-prime&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">M&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">list_m&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">M&lt;/span> &lt;span class="o">*=&lt;/span> &lt;span class="n">i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">list_b&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="n">M&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">i&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="n">list_m&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">assert&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_b&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_m&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">list_b_inv&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="nb">int&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">gmpy2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">invert&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">list_m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]))&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_m&lt;/span>&lt;span class="p">))]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;[+] Encountered an unusual error while calculating inverse using gmpy2.invert()&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="mi">0&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_m&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">x&lt;/span> &lt;span class="o">+=&lt;/span> &lt;span class="n">list_a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">list_b&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="n">list_b_inv&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">x&lt;/span> &lt;span class="o">%&lt;/span> &lt;span class="n">M&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">test_crt&lt;/span>&lt;span class="p">():&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Checking the validity and consistency of CRT function
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">list_a&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">2&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">3&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">6&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">4&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">list_m&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">5&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">9&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">11&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">7&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">8&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">soln_list&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="mi">17&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">1731&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="mi">20&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">try&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">for&lt;/span> &lt;span class="n">i&lt;/span> &lt;span class="ow">in&lt;/span> &lt;span class="nb">range&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">len&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_a&lt;/span>&lt;span class="p">)):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">assert&lt;/span> &lt;span class="n">crt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">list_a&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">],&lt;/span> &lt;span class="n">list_m&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">])&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="n">soln_list&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="n">i&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">except&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;[+] CRT function broken. Check the function again!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="k">def&lt;/span> &lt;span class="nf">hastad_unpadded&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ct_list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mod_list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">):&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s2">&amp;#34;&amp;#34;&amp;#34;
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> Implementing Hastad&amp;#39;s Broadcast Attack
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s2"> &amp;#34;&amp;#34;&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">m_expo&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">crt&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">ct_list&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">mod_list&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">m_expo&lt;/span> &lt;span class="o">!=&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">eth_root&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="n">gmpy2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">iroot&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">m_expo&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="n">e&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span> &lt;span class="n">eth_root&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">False&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;[+] Cannot calculate e&amp;#39;th root!&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">elif&lt;/span> &lt;span class="n">eth_root&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="kc">True&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># æ³¨æ„ï¼Œeth_root ä¸ºå…ƒç»„(mpzå¯¹è±¡,å¸ƒå°”å€¼)ï¼Œéœ€ç”¨eth_root[0]æå–mpzå¯¹è±¡&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ä¹Ÿå¯ç”¨gmpy2.digits(eth_root[0])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># ä»¥å­—ç¬¦ä¸²å½¢å¼è¿”å›žæ­£ç¡®çš„ç»“æžœ&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="c1"># https://gmpy2.readthedocs.io/en/latest/mpz.html#mpz-functions&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="n">long_to_bytes&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">eth_root&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">0&lt;/span>&lt;span class="p">])&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">else&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="nb">print&lt;/span> &lt;span class="s2">&amp;#34;[+] Cannot calculate CRT&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="k">return&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="mi">1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">test_crt&lt;/span>&lt;span class="p">()&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>å¯¹äºŽæ­¤é¢˜ï¼Œæˆ‘ä»¬ä¼ å…¥ &lt;code>hastad_unpadded(ct_list, mod_list, e)&lt;/code> å‡½æ•°çš„ä¸‰ä¸ªå‚æ•°åˆ†åˆ«ä¸º&lt;/p>
&lt;ul>
&lt;li>&lt;code>ct_list = clist&lt;/code>&lt;/li>
&lt;li>&lt;code>mod_list = nlist&lt;/code>&lt;/li>
&lt;li>&lt;code>e = 17&lt;/code>&lt;/li>
&lt;/ul>
&lt;p>(&lt;code>clist&lt;/code> å’Œ &lt;code>nlist&lt;/code> é€šè¿‡å‰é¢å¤§ä½¬ç»™çš„WPä¸­çš„ä»£ç å³å¯å¾—åˆ°ï¼Œç”¨åˆ°äº† &lt;code>randcrack&lt;/code> åº“)&lt;/p>
&lt;p>é€šè¿‡ä¸Šè¿°ä»£ç æˆ‘ä»¬æˆåŠŸå¾—åˆ°äº† &lt;code>init_state&lt;/code> çš„å€¼&lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/lrlr/init_state.png"
width="922"
height="95"
srcset="https://cld4h.github.io/blog/p/lrlr/init_state_hu_ced054a798d65875.png 480w, https://cld4h.github.io/blog/p/lrlr/init_state_hu_7f7f95d0ded4bdc2.png 1024w"
loading="lazy"
alt="init_state"
class="gallery-image"
data-flex-grow="970"
data-flex-basis="2329px"
>&lt;/p>
&lt;p>ä¸Žå‰é¢å¤§ä½¬ç»™çš„ä¸€è‡´.&lt;/p>
&lt;h3 id="bbencode">bbencode
&lt;/h3>&lt;p>èŽ·å¾— &lt;code>init_state&lt;/code> åŽå°±ä¸Ž Jarvis OJ ä¸Šçš„é¢˜ç›®å®Œå…¨ä¸€è‡´äº†
ä¸»è¦å‚è€ƒ &lt;a class="link" href="https://196011564.github.io/2018/12/11/CTF-JarvisOJ-Crypto-[61dctf]bbencode/index.html" target="_blank" rel="noopener"
>Jarvis oj crypto&lt;/a>&lt;/p>
&lt;p>å¤§è‡´çš„æ„æ€æ˜¯å°† &lt;code>bbencode&lt;/code> çš„è¾“å‡ºå†ä¼ ç»™ &lt;code>bbencode&lt;/code> ï¼Œåå¤ä½œç”¨ï¼Œæ¯ä¸€æ¬¡éƒ½æŸ¥çœ‹ä¸€ä¸‹ç»“æžœä¸­å‰å››ä¸ªå­—èŠ‚æ˜¯ä¸æ˜¯â€œflagâ€ ï¼Œå¦‚ä¸‹ï¼š&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-py" data-lang="py">&lt;span class="line">&lt;span class="cl"> &lt;span class="k">if&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;666c6167&amp;#34;&lt;/span> &lt;span class="o">==&lt;/span> &lt;span class="nb">str&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nb">hex&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="n">result&lt;/span>&lt;span class="p">))[&lt;/span>&lt;span class="mi">2&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">10&lt;/span>&lt;span class="p">]):&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>&amp;ldquo;666c6167&amp;rdquo; æ­£å¥½æ˜¯ flag çš„asciiç &lt;/p>
&lt;p>&lt;img src="https://cld4h.github.io/blog/p/lrlr/flag.png"
width="862"
height="216"
srcset="https://cld4h.github.io/blog/p/lrlr/flag_hu_8b31587149b33f85.png 480w, https://cld4h.github.io/blog/p/lrlr/flag_hu_e875e448df6a3b1.png 1024w"
loading="lazy"
alt="flag"
class="gallery-image"
data-flex-grow="399"
data-flex-basis="957px"
>&lt;/p>
&lt;p>ç”±äºŽforå¾ªçŽ¯æ‰§è¡Œ10000æ¬¡ï¼Œæ¯2695æ¬¡è¿­ä»£ä¼šå¾—åˆ°ä¸€æ¬¡flagï¼Œæ‰€ä»¥ä¼šè¾“å‡ºä¸‰æ¬¡flag&lt;/p></description></item></channel></rss>