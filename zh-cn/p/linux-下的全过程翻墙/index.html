<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="本文展示了在Linux下使用clash和iptables搭建透明代理进行翻墙的步骤\n我们用到了\nclash 作为代理程序 online subconverter 和 crontab 来定期更新配置文件 ACL4SSR 来提供GFW屏蔽域名规则 你可以从 github gist 来下载本文中提到的文件。\n"><title>Linux 下的「全过程翻墙」</title>
<link rel=canonical href=https://cld4h.github.io/blog/zh-cn/p/linux-%E4%B8%8B%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E7%BF%BB%E5%A2%99/><link rel=stylesheet href=/blog/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css><meta property='og:title' content="Linux 下的「全过程翻墙」"><meta property='og:description' content="本文展示了在Linux下使用clash和iptables搭建透明代理进行翻墙的步骤\n我们用到了\nclash 作为代理程序 online subconverter 和 crontab 来定期更新配置文件 ACL4SSR 来提供GFW屏蔽域名规则 你可以从 github gist 来下载本文中提到的文件。\n"><meta property='og:url' content='https://cld4h.github.io/blog/zh-cn/p/linux-%E4%B8%8B%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E7%BF%BB%E5%A2%99/'><meta property='og:site_name' content='cld4h 的博客'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='clash'><meta property='article:tag' content='tproxy'><meta property='article:tag' content='linux'><meta property='article:tag' content='GFW'><meta property='article:tag' content='fake-ip'><meta property='article:tag' content='透明代理'><meta property='article:tag' content='翻墙'><meta property='article:published_time' content='2022-05-04T16:19:40+08:00'><meta property='article:modified_time' content='2022-05-04T16:19:40+08:00'><meta property='og:image' content='https://cld4h.github.io/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables.webp'><meta name=twitter:title content="Linux 下的「全过程翻墙」"><meta name=twitter:description content="本文展示了在Linux下使用clash和iptables搭建透明代理进行翻墙的步骤\n我们用到了\nclash 作为代理程序 online subconverter 和 crontab 来定期更新配置文件 ACL4SSR 来提供GFW屏蔽域名规则 你可以从 github gist 来下载本文中提到的文件。\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://cld4h.github.io/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables.webp'></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=切换菜单>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog/zh-cn/><img src=/blog/img/avataaars_hu_25972a44ed8b91a1.png width=300 height=318 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🏡</span></figure><div class=site-meta><h1 class=site-name><a href=/blog/zh-cn>cld4h 的博客</a></h1><h2 class=site-description>Self sufficient!</h2></div></header><ol class=menu-social><li><a href=mailto:cld4h@disroot.org target=_blank title=email rel=me><svg class="icon icon-tabler icon-tabler-email" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M4 5.5s16 0 16 0c1.19.0 2 .13 2 1.5V17.5C22 18.87 21.19 19 20 19H4C2.81 19 2 18.87 2 17.5V7c0-1.37.81-1.5 2-1.5z"/><path d="M2.5 6c2 2 4 4 5.58 5.25C9.67 12.5 10.83 13 12 13s2.33-.5 3.92-1.75C17.5 10 19.5 8 21.5 6"/><path d="M8.5 12c-2 1.67-4 3.33-6 5"/><path d="M15.5 12c2 1.67 4 3.33 6 5"/></svg></a></li><li><a href=https://github.com/cld4h target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/blog/about/#rss-links target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=/blog/about/#xmpp target=_blank title=xmpp:cld4h@disroot.org rel=me><svg class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/blog target=_blank><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/blog/zh-cn/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>归档</span></a></li><li><a href=/blog/zh-cn/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>搜索</span></a></li><li><a href=/blog/zh-cn/%E5%85%B3%E4%BA%8E/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>关于</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://cld4h.github.io/blog/>English</option><option value=https://cld4h.github.io/blog/zh-tw/>中文正體</option><option value=https://cld4h.github.io/blog/zh-cn/ selected>中文简体</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>暗色模式</span></li></ol></li></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/zh-cn/p/linux-%E4%B8%8B%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E7%BF%BB%E5%A2%99/><img src=/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables_hu_762e744d60e57017.webp srcset="/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables_hu_762e744d60e57017.webp 800w, /blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables_hu_435900ea4b83b75f.webp 1600w" width=800 height=348 loading=lazy alt="Featured image of post Linux 下的「全过程翻墙」"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/blog/zh-cn/p/linux-%E4%B8%8B%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E7%BF%BB%E5%A2%99/>Linux 下的「全过程翻墙」</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 04, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>阅读时长: 12 分钟</time></div></footer><footer class=article-translations><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://cld4h.github.io/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/ class=link>English</a></div></footer></div></header><section class=article-content><p>本文展示了在Linux下使用clash和iptables搭建透明代理进行翻墙的步骤</p><p>我们用到了</p><ul><li><a class=link href=https://github.com/Dreamacro/clash target=_blank rel=noopener>clash</a> 作为代理程序</li><li><a class=link href=https://github.com/tindy2013/subconverter target=_blank rel=noopener>online subconverter</a> 和 crontab 来定期更新配置文件</li><li><a class=link href=https://github.com/ACL4SSR/ACL4SSR/tree/master target=_blank rel=noopener>ACL4SSR</a> 来提供GFW屏蔽域名规则</li></ul><p>你可以从 <a class=link href=https://gist.github.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4 target=_blank rel=noopener>github gist</a> 来下载本文中提到的文件。</p><p>配置所需的全部文件：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>├── clash-base-config.yaml  ---🟢clash的基础配置以使其工作在tproxy和fake-ip模式
</span></span><span class=line><span class=cl>├── clash.service           ---🟢systemd 配置文件
</span></span><span class=line><span class=cl>├── clean.sh                ---🟢清理iptables的脚本
</span></span><span class=line><span class=cl>├── config.ini              ---🟢subconverter的配置文件
</span></span><span class=line><span class=cl>├── iptables.sh             ---🟢iptables配置文件
</span></span><span class=line><span class=cl>├── update-config.sh        ---🟡订阅更新脚本; 须将&#34;XXXXXXXX&#34;替换成你的订阅地址
</span></span><span class=line><span class=cl>├── config.yaml             ---⭕clash 配置文件, 须从update-config.sh生成
</span></span><span class=line><span class=cl>├── README.md
</span></span><span class=line><span class=cl>└── README.zh-cn.md
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>🟢: 无需修改
</span></span><span class=line><span class=cl>🟡: 需要修改
</span></span><span class=line><span class=cl>⭕: 需要生成
</span></span></code></pre></td></tr></table></div></div><h2 id=参考>参考</h2><p><a class=link href=https://www.sobyte.net/post/2022-02/clash-tproxy/ target=_blank rel=noopener>clash-tproxy</a></p><p><a class=link href=https://git.breakpoint.cc/cgit/fw/tcprdr.git target=_blank rel=noopener>Transparent proxy demo code</a></p><h2 id=准备条件>准备条件</h2><ul><li>安装好的 <code>clash</code> .(默认在 <code>/usr/bin/clash</code> 路径下)</li><li>iptables</li><li>systemd （你完全可以使用其他的启动程序，这不过在这里我只展示systemd的配置过程，因为大多数GNU/Linux发行版默认使用systemd）</li><li>crontab</li></ul><h2 id=步骤>步骤</h2><h3 id=创建一个名为clash的系统用户>创建一个名为clash的系统用户</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>useradd -r -M -s /usr/sbin/nologin clash
</span></span></code></pre></td></tr></table></div></div><p>由于我们要做全局的透明代理（代理网卡上的全部流量），所有我们需要避免代理软件发出的流量再次进入代理软件形成回路无限循环。</p><p>因此，我们创建一个独立的用户 <code>clash</code> (名字可以是任意的，但要一致) 来运行代理软件。
之后通过iptables的规则将 <code>clash</code> 用户的流量分离出来。</p><h3 id=创建iptables和路由规则>创建iptables和路由规则</h3><p>创建一个内容是iptables命令的shell脚本 <code>/etc/clash/iptables.sh</code>.</p><p>文件包含三个主要部分：</p><ol><li>iptables规则用于劫持DNS请求流量</li><li>PREROUTING 中 <code>clash</code> 链的配置</li><li>OUTPUT 中 <code>clash_local</code> 链的配置</li></ol><p>iptables 示意图:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>┌─────────┐                                                                                      ┌─────────┐
</span></span><span class=line><span class=cl>│         │             PREROUTING                                                INPUT          │         │
</span></span><span class=line><span class=cl>│         │                                                                                      │         │
</span></span><span class=line><span class=cl>│         │  ┌─────────────────────────────────────┐                      ┌────────────────────┐ │         │
</span></span><span class=line><span class=cl>│         │  │                                     │         /───\        │                    │ │         │
</span></span><span class=line><span class=cl>│         │  │ ┌───┐  ┌─────────┐  ┌──────┐  ┌───┐ │        /     \       │ ┌──────┐  ┌──────┐ │ │         │
</span></span><span class=line><span class=cl>│         ├──┤►│raw├─►│conntrack├─►│mangle├─►│nat├─┼──────►&lt;routing&gt;──────┤►│mangle├─►│filter├─┤►│         │
</span></span><span class=line><span class=cl>│         │  │ └───┘  └─────────┘  └──────┘  └───┘ │        \     /       │ └──────┘  └──────┘ │ │         │
</span></span><span class=line><span class=cl>│         │  │                                     │         \─┬─/        │                    │ │         │
</span></span><span class=line><span class=cl>│         │  └─────────────────────────────────────┘           │          └────────────────────┘ │         │
</span></span><span class=line><span class=cl>│         │                                                    │                                 │         │
</span></span><span class=line><span class=cl>│         │                               ┌──────────┐         │                                 │         │
</span></span><span class=line><span class=cl>│         │                               │          │         │                                 │         │
</span></span><span class=line><span class=cl>│         │                               │ ┌──────┐ │         │                                 │         │
</span></span><span class=line><span class=cl>│         │                               │ │mangle◄─┼─────────┘                                 │         │
</span></span><span class=line><span class=cl>│ Network │                               │ └──┬───┘ │                                           │  Local  │
</span></span><span class=line><span class=cl>│Interface│                               │    │     │ FORWARD                                   │ Process │
</span></span><span class=line><span class=cl>│         │                               │ ┌──▼───┐ │                                  /───\    │         │
</span></span><span class=line><span class=cl>│         │               ┌───────────────┼─┤filter│ │                                 /     \   │         │
</span></span><span class=line><span class=cl>│         │               │               │ └──────┘ │                                &lt;routing&gt;◄─┤         │
</span></span><span class=line><span class=cl>│         │               │               │          │                                 \     /   │         │
</span></span><span class=line><span class=cl>│         │               │               └──────────┘                                  \─┬─/    │         │
</span></span><span class=line><span class=cl>│         │               │                                                               │      │         │
</span></span><span class=line><span class=cl>│         │  ┌────────────┼────┐               ┌──────────────────────────────────────────┼────┐ │         │
</span></span><span class=line><span class=cl>│         │  │            │    │     ─────     │                                          │    │ │         │
</span></span><span class=line><span class=cl>│         │  │ ┌───┐  ┌───▼──┐ │    /     \    │ ┌──────┐  ┌───┐  ┌──────┐  ┌─────────┐  ┌▼──┐ │ │         │
</span></span><span class=line><span class=cl>│         │◄─┼─┤nat│◄─┤mangle│◄├───&lt;reroute&gt;───┼─┤filter│◄─┤nat│◄─┤mangle│◄─┤conntrack│◄─┤raw│ │ │         │
</span></span><span class=line><span class=cl>│         │  │ └───┘  └──────┘ │    \check/    │ └──────┘  └───┘  └──────┘  └─────────┘  └───┘ │ │         │
</span></span><span class=line><span class=cl>│         │  │                 │     ─────     │                                               │ │         │
</span></span><span class=line><span class=cl>│         │  └─────────────────┘               └───────────────────────────────────────────────┘ │         │
</span></span><span class=line><span class=cl>│         │     POSTROUTING                                        OUTPUT                        │         │
</span></span><span class=line><span class=cl>│         │                                                                                      │         │
</span></span><span class=line><span class=cl>└─────────┘                                                                                      └─────────┘
</span></span></code></pre></td></tr></table></div></div><p><code>/etc/clash/iptables.sh</code> 内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/usr/bin/env bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># set -ex 选项说明:</span>
</span></span><span class=line><span class=cl><span class=c1># -e 当有命令以非0值退出时立刻结束执行</span>
</span></span><span class=line><span class=cl><span class=c1># -x 当命令执行时打印命令及其参数</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -ex
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ENABLE ipv4 forward</span>
</span></span><span class=line><span class=cl>sysctl -w net.ipv4.ip_forward<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ROUTE RULES</span>
</span></span><span class=line><span class=cl>ip rule add fwmark <span class=m>666</span> table <span class=m>666</span>
</span></span><span class=line><span class=cl>ip route add <span class=nb>local</span> 0.0.0.0/0 table <span class=m>666</span> dev lo
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##################################</span>
</span></span><span class=line><span class=cl><span class=c1>## hijack the dns query traffic ##</span>
</span></span><span class=line><span class=cl><span class=c1>##################################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 转发从局域网收到的所有 DNS 查询流量到 1053 端口</span>
</span></span><span class=line><span class=cl><span class=c1># 此操作会导致所有 DNS 请求全部返回虚假 IP(fake ip 198.18.0.1/16)</span>
</span></span><span class=line><span class=cl>iptables -t nat -I PREROUTING -p udp --dport <span class=m>53</span> -j REDIRECT --to <span class=m>1053</span>
</span></span><span class=line><span class=cl><span class=c1># ipv6 同样配置</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -I PREROUTING -p udp --dport <span class=m>53</span> -j REDIRECT --to <span class=m>1053</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 转发从所有本机进程（除去uid为clash的进程）收到的所有 DNS 查询流量到 1053 端口</span>
</span></span><span class=line><span class=cl><span class=c1># 此操作会导致所有 DNS 请求全部返回虚假 IP(fake ip 198.18.0.1/16)</span>
</span></span><span class=line><span class=cl>iptables -t nat -N clash_dns
</span></span><span class=line><span class=cl>iptables -t nat -A OUTPUT -p udp --dport <span class=m>53</span> -j clash_dns
</span></span><span class=line><span class=cl>iptables -t nat -A clash_dns -m owner --uid-owner clash -j RETURN
</span></span><span class=line><span class=cl>iptables -t nat -A clash_dns -p udp -j REDIRECT --to-ports <span class=m>1053</span>
</span></span><span class=line><span class=cl><span class=c1># ipv6 同样配置</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -N clash_dns
</span></span><span class=line><span class=cl>ip6tables -t nat -A OUTPUT -p udp --dport <span class=m>53</span> -j clash_dns
</span></span><span class=line><span class=cl>ip6tables -t nat -A clash_dns -m owner --uid-owner clash -j RETURN
</span></span><span class=line><span class=cl>ip6tables -t nat -A clash_dns -p udp -j REDIRECT --to-ports <span class=m>1053</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##############################</span>
</span></span><span class=line><span class=cl><span class=c1>## config for `clash` chain ##</span>
</span></span><span class=line><span class=cl><span class=c1>##############################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># `clash` 链负责利用tproxy将流量转发到clash的7893端口</span>
</span></span><span class=line><span class=cl>iptables -t mangle -N clash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 目标地址为局域网或保留地址的流量跳过处理</span>
</span></span><span class=line><span class=cl><span class=c1># 保留地址参考:</span>
</span></span><span class=line><span class=cl><span class=c1># https://zh.wikipedia.org/wiki/%E5%B7%B2%E5%88%86%E9%85%8D%E7%9A%84/8_IPv4%E5%9C%B0%E5%9D%80%E5%9D%97%E5%88%97%E8%A1%A8</span>
</span></span><span class=line><span class=cl><span class=c1># https://zh.wikipedia.org/wiki/%E4%B8%93%E7%94%A8%E7%BD%91%E7%BB%9C</span>
</span></span><span class=line><span class=cl><span class=c1># IANA - Local Identification</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 0.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl><span class=c1># IANA - Loopback</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 127.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl><span class=c1># IANA - Private Use</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 10.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 172.16.0.0/12 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 192.168.0.0/16 -j RETURN
</span></span><span class=line><span class=cl><span class=c1># IPv4 Link-Local Addresses</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 169.254.0.0/16 -j RETURN
</span></span><span class=line><span class=cl><span class=c1># Multicast</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 224.0.0.0/4 -j RETURN
</span></span><span class=line><span class=cl><span class=c1># Future Use</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 240.0.0.0/4 -j RETURN
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 其他所有流量转向到 7893 端口，并打上 mark</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -p tcp -j TPROXY --on-port <span class=m>7893</span> --tproxy-mark <span class=m>666</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -p udp -j TPROXY --on-port <span class=m>7893</span> --tproxy-mark <span class=m>666</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将 `clash` 链加在PREROUTING链后面使其生效</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A PREROUTING -j clash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>####################################</span>
</span></span><span class=line><span class=cl><span class=c1>## config for `clash_local` chain ##</span>
</span></span><span class=line><span class=cl><span class=c1>####################################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># `clash_local` 链负责处理本机的本地进程发出的流量：给发往公网的流量打上666标记</span>
</span></span><span class=line><span class=cl><span class=c1># (之后会reroute给lo设备，然后会在PREROUTING中的clash链上转发到tproxy 7893端口)</span>
</span></span><span class=line><span class=cl>iptables -t mangle -N clash_local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># nerdctl 容器流量重新路由</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t mangle -A clash_local -i nerdctl2 -p udp -j MARK --set-mark 666</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t mangle -A clash_local -i nerdctl2 -p tcp -j MARK --set-mark 666</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 跳过内网流量</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 0.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 127.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 10.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 172.16.0.0/12 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 192.168.0.0/16 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 169.254.0.0/16 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 224.0.0.0/4 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 240.0.0.0/4 -j RETURN
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 为本机发出的流量打 mark</span>
</span></span><span class=line><span class=cl><span class=c1># clash_local 链会为本机流量打 mark, 打过 mark 的流量会重新回到device lo，再从PREROUTING开始走流程.</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -p tcp -j MARK --set-mark <span class=m>666</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -p udp -j MARK --set-mark <span class=m>666</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 跳过来自服务端口的流量</span>
</span></span><span class=line><span class=cl><span class=c1># https web server</span>
</span></span><span class=line><span class=cl><span class=c1># iptables -t mangle -I OUTPUT -p tcp --sport 443 -j RETURN</span>
</span></span><span class=line><span class=cl><span class=c1># transmission</span>
</span></span><span class=line><span class=cl><span class=c1># iptables -t mangle -I OUTPUT -p tcp --sport 51413 -j RETURN</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 跳过 clash 程序本身发出的流量, 防止死循环(clash 程序需要使用 &#34;clash&#34; 用户启动)</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A OUTPUT -p tcp -m owner --uid-owner clash -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A OUTPUT -p udp -m owner --uid-owner clash -j RETURN
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 将 `clash_local` 链加在 OUTPUT 链后面使其生效</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A OUTPUT -j clash_local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#######################</span>
</span></span><span class=line><span class=cl><span class=c1>## unimportant staff ##</span>
</span></span><span class=line><span class=cl><span class=c1>#######################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># 修复 ICMP(ping)</span>
</span></span><span class=line><span class=cl><span class=c1># 这并不能保证 ping 结果有效(clash 等不支持转发 ICMP), 只是让它有返回结果而已</span>
</span></span><span class=line><span class=cl><span class=c1># --to-destination 设置为一个可达的地址即可</span>
</span></span><span class=line><span class=cl><span class=c1>#sysctl -w net.ipv4.conf.all.route_localnet=1</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t nat -A PREROUTING -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t nat -A OUTPUT -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1</span>
</span></span></code></pre></td></tr></table></div></div><p>当执行完上述脚本后，iptables的状态如下图所示：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>┌─────────┐                                                                                      ┌─────────┐
</span></span><span class=line><span class=cl>│         │             PREROUTING           rule1*                               INPUT          │         │
</span></span><span class=line><span class=cl>│         │                                    │                                                 │         │
</span></span><span class=line><span class=cl>│         │  ┌─────────────────────────────────┼───┐                      ┌────────────────────┐ │         │
</span></span><span class=line><span class=cl>│         │  │                                 │   │         /───\        │                    │ │         │
</span></span><span class=line><span class=cl>│         │  │ ┌───┐  ┌─────────┐  ┌──────┐  ┌─┴─┐ │        /     \       │ ┌──────┐  ┌──────┐ │ │         │
</span></span><span class=line><span class=cl>│         ├──┤►│raw├─►│conntrack├─►│mangle├─►│nat├─┼──────►&lt;routing&gt;──────┤►│mangle├─►│filter├─┤►│         │
</span></span><span class=line><span class=cl>│         │  │ └───┘  └─────────┘  └┬─────┘  └───┘ │        \     /       │ └──────┘  └──────┘ │ │         │
</span></span><span class=line><span class=cl>│         │  │                      │              │         \─┬─/        │                    │ │         │
</span></span><span class=line><span class=cl>│         │  └──────────────────────┼──────────────┘           │          └────────────────────┘ │         │
</span></span><span class=line><span class=cl>│         │                         │                          │                                 │         │
</span></span><span class=line><span class=cl>│         │                      ┌──┴──┐  ┌──────────┐         │                                 │         │
</span></span><span class=line><span class=cl>│         │                      │clash│  │          │         │                                 │         │
</span></span><span class=line><span class=cl>│         │                      └─────┘  │ ┌──────┐ │         │                                 │         │
</span></span><span class=line><span class=cl>│         │                               │ │mangle◄─┼─────────┘                                 │         │
</span></span><span class=line><span class=cl>│ Network │                               │ └──┬───┘ │              ┌───────────┐                │  Local  │
</span></span><span class=line><span class=cl>│Interface│                               │    │     │ FORWARD      │clash_local│                │ Process │
</span></span><span class=line><span class=cl>│         │                               │ ┌──▼───┐ │              └─┬─────────┘       /───\    │         │
</span></span><span class=line><span class=cl>│         │               ┌───────────────┼─┤filter│ │                │                /     \   │         │
</span></span><span class=line><span class=cl>│         │               │               │ └──────┘ │                ├───rule3*      &lt;routing&gt;◄─┤         │
</span></span><span class=line><span class=cl>│         │               │               │          │                │                \     /   │         │
</span></span><span class=line><span class=cl>│         │               │               └──────────┘                ├───rule2*        \─┬─/    │         │
</span></span><span class=line><span class=cl>│         │               │                                           │                   │      │         │
</span></span><span class=line><span class=cl>│         │  ┌────────────┼────┐               ┌──────────────────────┼───────────────────┼────┐ │         │
</span></span><span class=line><span class=cl>│         │  │            │    │     ─────     │                      │                   │    │ │         │
</span></span><span class=line><span class=cl>│         │  │ ┌───┐  ┌───▼──┐ │    /     \    │ ┌──────┐  ┌───┐  ┌───┴──┐  ┌─────────┐  ┌▼──┐ │ │         │
</span></span><span class=line><span class=cl>│         │◄─┼─┤nat│◄─┤mangle│◄├───&lt;reroute&gt;───┼─┤filter│◄─┤nat│◄─┤mangle│◄─┤conntrack│◄─┤raw│ │ │         │
</span></span><span class=line><span class=cl>│         │  │ └───┘  └──────┘ │    \check/    │ └──────┘  └┬──┘  └──────┘  └─────────┘  └───┘ │ │         │
</span></span><span class=line><span class=cl>│         │  │                 │     ─────     │            │                                  │ │         │
</span></span><span class=line><span class=cl>│         │  └─────────────────┘               └────────────┼──────────────────────────────────┘ │         │
</span></span><span class=line><span class=cl>│         │     POSTROUTING                                 │      OUTPUT                        │         │
</span></span><span class=line><span class=cl>│         │                                          ┌──────┴──┐                                 │         │
</span></span><span class=line><span class=cl>└─────────┘                                          │clash_dns│                                 └─────────┘
</span></span><span class=line><span class=cl>                                                     └─────────┘
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> *rule1: iptables -t nat -I PREROUTING -p udp --dport 53 -j REDIRECT --to 1053
</span></span><span class=line><span class=cl> *rule2: iptables -t mangle -A OUTPUT -p tcp -m owner --uid-owner clash -j RETURN
</span></span><span class=line><span class=cl> *rule3: iptables -t mangle -A OUTPUT -p udp -m owner --uid-owner clash -j RETURN
</span></span></code></pre></td></tr></table></div></div><p>研究一下 <code>iptables.sh</code> 中的路由规则:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ip rule add fwmark <span class=m>666</span> table <span class=m>666</span>
</span></span><span class=line><span class=cl>ip route add <span class=nb>local</span> 0.0.0.0/0 table <span class=m>666</span> dev lo
</span></span></code></pre></td></tr></table></div></div><p><code>ip rule</code> 用于控制策略路由数据库，管理策略路由的路由选择算法</p><p>这里 <code>ip rule</code> 命令让内核对标记有666的数据包查找666号路由表</p><p><a class=link href=http://linux-ip.net/html/tools-ip-rule.html target=_blank rel=noopener>ip rule 参考文档</a></p><p><code>ip route</code> 命令在666号路由表中添加了一条到lo设备的默认路由</p><p>我们可以通过 <code>ip route show table 666</code> 来查看 <code>ip route add local 0.0.0.0/0 table 666 dev lo</code> 添加的路由项</p><p>查看路由表编号和名称的映射：
<code>cat /etc/iproute2/rt_tables</code></p><h3 id=创建规则清理脚本>创建规则清理脚本</h3><p>在退出clash后需清除设定的规则</p><p><code>-D</code> 或 <code>--delete</code>:</p><p>从所选链中删掉一条或多条规则。
可以指定要删除的规则号；或指定规则内容（将 <code>-A</code>、<code>-I</code> 替换成 <code>-D</code> 即可）</p><p><code>-F</code> or <code>--flush</code>:</p><p>刷新所选链，相当于逐条清除链上的所有规则</p><p><code>-X</code> or <code>--delete-chain</code>:</p><p>删除用户定义的链</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/env bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -ex
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip rule del fwmark <span class=m>666</span> table <span class=m>666</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip route del <span class=nb>local</span> 0.0.0.0/0 table <span class=m>666</span> dev lo <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>iptables -t nat -D PREROUTING -p udp --dport <span class=m>53</span> -j REDIRECT --to <span class=m>1053</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -D PREROUTING -p udp --dport <span class=m>53</span> -j REDIRECT --to <span class=m>1053</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t nat -D OUTPUT -p udp --dport <span class=m>53</span> -j clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -D OUTPUT -p udp --dport <span class=m>53</span> -j clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t nat -F clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t nat -X clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -F clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -X clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t nat -D PREROUTING -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t nat -D OUTPUT -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>iptables -t mangle -D PREROUTING -j clash <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -F clash <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -X clash <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>iptables -t mangle -D OUTPUT -p tcp -m owner --uid-owner clash -j RETURN <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -D OUTPUT -p udp -m owner --uid-owner clash -j RETURN <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -D OUTPUT -j clash_local <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -F clash_local <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -X clash_local <span class=o>||</span> <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=修正ping>修正ping</h3><p>fake-ip 模式的一个主要缺点是无法ping</p><p>前面 <code>iptables.sh</code> 中将所有ping请求重定向到127.0.0.1 的操作是掩耳盗铃的，它不提供任何信息。</p><p>但是，可以通过clash用户的身份进行ping</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>ping</span><span class=o>=</span><span class=s2>&#34;sudo -u clash ping&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=提供systemd-unit-file-以一键启动clash及相关iptables等配置>提供systemd unit file 以一键启动clash及相关iptables等配置</h3><p>此步骤是可选的，但我觉得能够一键启动/关闭clash很方便。</p><p>同时也可以设置clash开机启动。</p><p>Systemd 配置文件命名为<code>clash.service</code> ，放在 <code>/usr/lib/systemd/system</code> 目录下，执行 <code>sudo systemctl start clash</code> 来启动运行clash</p><p>开机启动： <code>sudo systemctl enable clash</code>.</p><h3 id=配置clash>配置clash</h3><p>下面看一看对clash本身的配置</p><p>clash 使用 <code>-d</code> 选项得到配置文件目录； <code>-f</code> 选项得到配置文件</p><p>当 <code>-f</code> 被忽略时，默认的配置文件名是 <code>config.yaml</code></p><p>我们想要通过 <code>crontab</code> 从clash的订阅链接中定时更新clash的配置文件</p><h4 id=构造订阅连接>构造订阅连接</h4><p>TL;DR. 将下面URL中<code>XXXXXXXX</code> 替换成<a class=link href=https://www.urlencoder.io/ target=_blank rel=noopener>URL Encode后的</a>节点订阅URL即可</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>https://sub.xeton.dev/sub?target=clash&amp;new_name=true&amp;filename=config.yaml&amp;url=XXXXXXXX&amp;config=https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini
</span></span></code></pre></td></tr></table></div></div><p>我们通过<a class=link href=https://github.com/tindy2013/subconverter target=_blank rel=noopener>subconverter</a>来生成clash的配置文件。</p><p>你需要修改订阅链接中的一些参数以使得生成的clash正确配置成 <strong>监听tproxy</strong> 以及 <strong>fake-ip</strong> 模式</p><p>具体的：</p><ol><li><code>url</code> 参数要是正确的节点信息并且经过<a class=link href=https://www.urlencoder.io/ target=_blank rel=noopener>URL Encode</a>.</li><li>多个节点订阅URL要用 <code>|</code> 分割, 此符号<a class=link href=https://www.urlencoder.io/ target=_blank rel=noopener>URL Encode</a> 之后是 <code>%7C</code> .</li><li><code>config</code> 参数是用于告诉subconverter如何进行订阅转换的关键，应当<a class=link href=https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/config.ini target=_blank rel=noopener>配置正确</a>. ⚠️</li></ol><p>⚠️ 注意: 这里subconverter 的配置文件非常重要</p><p><a class=link href=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini target=_blank rel=noopener>ACL4SSR 项目提供了一个默认的subconverter配置文件</a>，这个文件没问题，但默认的选项不足以让clash开启fake-ip模式并监听tproxy</p><p>要想使其工作，需指定 <code>clash_rule_base</code>： 在<a class=link href=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini target=_blank rel=noopener>其</a>中插入下面这一行</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>clash_rule_base=https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/clash-base-config.yaml
</span></span></code></pre></td></tr></table></div></div><p>这一行的作用是告诉subconverter使用<a class=link href=https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/clash-base-config.yaml target=_blank rel=noopener>URL中的文件</a>作为clash的基础配置</p><p>或者你可以直接使用<a class=link href=https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/config.ini target=_blank rel=noopener>我的config.ini</a></p><p>示例URL:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>https://sub.xeton.dev/sub?        --- 后端地址
</span></span><span class=line><span class=cl>target=clash                      --- 客户端类型
</span></span><span class=line><span class=cl>&amp;new_name=true                    --- 重命名
</span></span><span class=line><span class=cl>&amp;filename=config.yaml             --- 文件名
</span></span><span class=line><span class=cl>&amp;url=                             --- 节点信息
</span></span><span class=line><span class=cl>ss%3A%2F%2FYmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg%23example-server
</span></span><span class=line><span class=cl>%7C                               --- 分隔符 |
</span></span><span class=line><span class=cl>ss%3A%2F%2FYmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg%23example-server-2
</span></span><span class=line><span class=cl>&amp;config=                          --- subconverter的配置文件; .ini 格式
</span></span><span class=line><span class=cl>https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini
</span></span><span class=line><span class=cl>                                  --- 下面这些配置是多余的，没啥用
</span></span><span class=line><span class=cl>&amp;list=false                       --- 用于输出 Surge Node List 或者 Clash Proxy Provider 或者 Quantumult (X) 的节点订阅 或者 解码后的 SIP002
</span></span><span class=line><span class=cl>&amp;tfo=false                        --- 用于开启该订阅链接的 TCP Fast Open，默认为 false
</span></span><span class=line><span class=cl>&amp;scv=false                        --- 用于关闭 TLS 节点的证书检查，默认为 false
</span></span><span class=line><span class=cl>&amp;fdn=false                        --- 用于过滤目标类型不支持的节点，默认为 true
</span></span><span class=line><span class=cl>&amp;sort=false                       --- 用于对输出的节点或策略组按节点名进行再次排序，默认为 false
</span></span></code></pre></td></tr></table></div></div><h4 id=设置定时更新订阅任务>设置定时更新订阅任务</h4><p>创建订阅更新脚本 <code>/etc/clash/update-config.sh</code> ，内容如下：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/env bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>set</span> -ex
</span></span><span class=line><span class=cl>/usr/bin/curl <span class=s2>&#34;https://sub.xeton.dev/sub?target=clash&amp;new_name=true&amp;filename=config.yaml&amp;url=XXXXXXXX&amp;config=https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini&#34;</span> -o /etc/clash/config.yaml
</span></span></code></pre></td></tr></table></div></div><p>⚠️ 上面的URL要替换一下</p><p>手动执行一下上述脚本确认配置文件能够正常生成。</p><p>确保你的clash<code>config.yaml</code>配置文件中有如下内容：</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tproxy-port</span><span class=p>:</span><span class=w> </span><span class=m>7893</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>listen</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>1053</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enhanced-mode</span><span class=p>:</span><span class=w> </span><span class=l>fake-ip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fake-ip-range</span><span class=p>:</span><span class=w> </span><span class=m>198.18.0.1</span><span class=l>/16</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>添加<a class=link href=https://crontab.guru target=_blank rel=noopener>定时任务</a>： 执行 <code>sudo crontab -e</code> 并加入下面这一行以在每天早上10:00执行订阅更新脚本。</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>0</span> <span class=m>10</span> * * * /usr/bin/bash /etc/clash/update-config.sh
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/blog/zh-cn/tags/clash/>Clash</a>
<a href=/blog/zh-cn/tags/tproxy/>Tproxy</a>
<a href=/blog/zh-cn/tags/linux/>Linux</a>
<a href=/blog/zh-cn/tags/gfw/>GFW</a>
<a href=/blog/zh-cn/tags/fake-ip/>Fake-Ip</a>
<a href=/blog/zh-cn/tags/%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86/>透明代理</a>
<a href=/blog/zh-cn/tags/%E7%BF%BB%E5%A2%99/>翻墙</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><footer class=site-footer><section class=copyright>&copy;
2019 -
2025 cld4h 的博客</section><section class=powerby>使用 <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> 构建<br>主题 <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> 由 <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> 设计</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>