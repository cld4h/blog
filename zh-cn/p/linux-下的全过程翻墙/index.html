<!doctype html><html lang=zh-cn dir=ltr><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content="æœ¬æ–‡å±•ç¤ºäº†åœ¨Linuxä¸‹ä½¿ç”¨clashå’Œiptablesæ­å»ºé€æ˜ä»£ç†è¿›è¡Œç¿»å¢™çš„æ­¥éª¤\næˆ‘ä»¬ç”¨åˆ°äº†\nclash ä½œä¸ºä»£ç†ç¨‹åº online subconverter å’Œ crontab æ¥å®šæœŸæ›´æ–°é…ç½®æ–‡ä»¶ ACL4SSR æ¥æä¾›GFWå±è”½åŸŸåè§„åˆ™ ä½ å¯ä»¥ä» github gist æ¥ä¸‹è½½æœ¬æ–‡ä¸­æåˆ°çš„æ–‡ä»¶ã€‚\n"><title>Linux ä¸‹çš„ã€Œå…¨è¿‡ç¨‹ç¿»å¢™ã€</title>
<link rel=canonical href=https://cld4h.github.io/blog/zh-cn/p/linux-%E4%B8%8B%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E7%BF%BB%E5%A2%99/><link rel=stylesheet href=/blog/scss/style.min.0304c6baf04e01a8fe70693791cb744d56a3578a3120a8796cefc66825aa39c7.css><meta property='og:title' content="Linux ä¸‹çš„ã€Œå…¨è¿‡ç¨‹ç¿»å¢™ã€"><meta property='og:description' content="æœ¬æ–‡å±•ç¤ºäº†åœ¨Linuxä¸‹ä½¿ç”¨clashå’Œiptablesæ­å»ºé€æ˜ä»£ç†è¿›è¡Œç¿»å¢™çš„æ­¥éª¤\næˆ‘ä»¬ç”¨åˆ°äº†\nclash ä½œä¸ºä»£ç†ç¨‹åº online subconverter å’Œ crontab æ¥å®šæœŸæ›´æ–°é…ç½®æ–‡ä»¶ ACL4SSR æ¥æä¾›GFWå±è”½åŸŸåè§„åˆ™ ä½ å¯ä»¥ä» github gist æ¥ä¸‹è½½æœ¬æ–‡ä¸­æåˆ°çš„æ–‡ä»¶ã€‚\n"><meta property='og:url' content='https://cld4h.github.io/blog/zh-cn/p/linux-%E4%B8%8B%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E7%BF%BB%E5%A2%99/'><meta property='og:site_name' content='cld4h çš„åšå®¢'><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='clash'><meta property='article:tag' content='tproxy'><meta property='article:tag' content='linux'><meta property='article:tag' content='GFW'><meta property='article:tag' content='fake-ip'><meta property='article:tag' content='é€æ˜ä»£ç†'><meta property='article:tag' content='ç¿»å¢™'><meta property='article:published_time' content='2022-05-04T16:19:40+08:00'><meta property='article:modified_time' content='2022-05-04T16:19:40+08:00'><meta property='og:image' content='https://cld4h.github.io/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables.webp'><meta name=twitter:title content="Linux ä¸‹çš„ã€Œå…¨è¿‡ç¨‹ç¿»å¢™ã€"><meta name=twitter:description content="æœ¬æ–‡å±•ç¤ºäº†åœ¨Linuxä¸‹ä½¿ç”¨clashå’Œiptablesæ­å»ºé€æ˜ä»£ç†è¿›è¡Œç¿»å¢™çš„æ­¥éª¤\næˆ‘ä»¬ç”¨åˆ°äº†\nclash ä½œä¸ºä»£ç†ç¨‹åº online subconverter å’Œ crontab æ¥å®šæœŸæ›´æ–°é…ç½®æ–‡ä»¶ ACL4SSR æ¥æä¾›GFWå±è”½åŸŸåè§„åˆ™ ä½ å¯ä»¥ä» github gist æ¥ä¸‹è½½æœ¬æ–‡ä¸­æåˆ°çš„æ–‡ä»¶ã€‚\n"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content='https://cld4h.github.io/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables.webp'></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label=åˆ‡æ¢èœå•>
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/blog/zh-cn/><img src=/blog/img/avataaars_hu_25972a44ed8b91a1.png width=300 height=318 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¡</span></figure><div class=site-meta><h1 class=site-name><a href=/blog/zh-cn>cld4h çš„åšå®¢</a></h1><h2 class=site-description>Self sufficient!</h2></div></header><ol class=menu-social><li><a href=mailto:cld4h@disroot.org target=_blank title=email rel=me><svg class="icon icon-tabler icon-tabler-email" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M4 5.5s16 0 16 0c1.19.0 2 .13 2 1.5V17.5C22 18.87 21.19 19 20 19H4C2.81 19 2 18.87 2 17.5V7c0-1.37.81-1.5 2-1.5z"/><path d="M2.5 6c2 2 4 4 5.58 5.25C9.67 12.5 10.83 13 12 13s2.33-.5 3.92-1.75C17.5 10 19.5 8 21.5 6"/><path d="M8.5 12c-2 1.67-4 3.33-6 5"/><path d="M15.5 12c2 1.67 4 3.33 6 5"/></svg></a></li><li><a href=https://github.com/cld4h target=_blank title=GitHub rel=me><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=/blog/about/#rss-links target=_blank title=RSS rel=me><svg class="icon icon-tabler icon-tabler-rss" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="5" cy="19" r="1"/><path d="M4 4a16 16 0 0116 16"/><path d="M4 11a9 9 0 019 9"/></svg></a></li><li><a href=/blog/about/#xmpp target=_blank title=xmpp:cld4h@disroot.org rel=me><svg class="icon icon-tabler icon-tabler-messages" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M21 14l-3-3h-7a1 1 0 01-1-1V4a1 1 0 011-1h9a1 1 0 011 1v10"/><path d="M14 15v2a1 1 0 01-1 1H6l-3 3V11a1 1 0 011-1h2"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/blog/blog target=_blank><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/blog/zh-cn/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>å½’æ¡£</span></a></li><li><a href=/blog/zh-cn/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>æœç´¢</span></a></li><li><a href=/blog/zh-cn/%E5%85%B3%E4%BA%8E/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>å…³äº</span></a></li><li class=menu-bottom-section><ol class=menu><li id=i18n-switch><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg>
<select name=language title=language onchange="window.location.href=this.selectedOptions[0].value"><option value=https://cld4h.github.io/blog/>English</option><option value=https://cld4h.github.io/blog/zh-tw/>ä¸­æ–‡æ­£é«”</option><option value=https://cld4h.github.io/blog/zh-cn/ selected>ä¸­æ–‡ç®€ä½“</option></select></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>æš—è‰²æ¨¡å¼</span></li></ol></li></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/blog/zh-cn/p/linux-%E4%B8%8B%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E7%BF%BB%E5%A2%99/><img src=/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables_hu_762e744d60e57017.webp srcset="/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables_hu_762e744d60e57017.webp 800w, /blog/p/the-ultimate-way-to-bypass-gfw-on-linux/iptables_hu_435900ea4b83b75f.webp 1600w" width=800 height=348 loading=lazy alt="Featured image of post Linux ä¸‹çš„ã€Œå…¨è¿‡ç¨‹ç¿»å¢™ã€"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/blog/zh-cn/p/linux-%E4%B8%8B%E7%9A%84%E5%85%A8%E8%BF%87%E7%A8%8B%E7%BF%BB%E5%A2%99/>Linux ä¸‹çš„ã€Œå…¨è¿‡ç¨‹ç¿»å¢™ã€</a></h2></div><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>May 04, 2022</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-time--reading>é˜…è¯»æ—¶é•¿: 12 åˆ†é’Ÿ</time></div></footer><footer class=article-translations><svg class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 5h7"/><path d="M9 3v2c0 4.418-2.239 8-5 8"/><path d="M5 9c-.003 2.144 2.952 3.908 6.7 4"/><path d="M12 20l4-9 4 9"/><path d="M19.1 18h-6.2"/></svg><div><a href=https://cld4h.github.io/blog/p/the-ultimate-way-to-bypass-gfw-on-linux/ class=link>English</a></div></footer></div></header><section class=article-content><p>æœ¬æ–‡å±•ç¤ºäº†åœ¨Linuxä¸‹ä½¿ç”¨clashå’Œiptablesæ­å»ºé€æ˜ä»£ç†è¿›è¡Œç¿»å¢™çš„æ­¥éª¤</p><p>æˆ‘ä»¬ç”¨åˆ°äº†</p><ul><li><a class=link href=https://github.com/Dreamacro/clash target=_blank rel=noopener>clash</a> ä½œä¸ºä»£ç†ç¨‹åº</li><li><a class=link href=https://github.com/tindy2013/subconverter target=_blank rel=noopener>online subconverter</a> å’Œ crontab æ¥å®šæœŸæ›´æ–°é…ç½®æ–‡ä»¶</li><li><a class=link href=https://github.com/ACL4SSR/ACL4SSR/tree/master target=_blank rel=noopener>ACL4SSR</a> æ¥æä¾›GFWå±è”½åŸŸåè§„åˆ™</li></ul><p>ä½ å¯ä»¥ä» <a class=link href=https://gist.github.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4 target=_blank rel=noopener>github gist</a> æ¥ä¸‹è½½æœ¬æ–‡ä¸­æåˆ°çš„æ–‡ä»¶ã€‚</p><p>é…ç½®æ‰€éœ€çš„å…¨éƒ¨æ–‡ä»¶ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>.
</span></span><span class=line><span class=cl>â”œâ”€â”€ clash-base-config.yaml  ---ğŸŸ¢clashçš„åŸºç¡€é…ç½®ä»¥ä½¿å…¶å·¥ä½œåœ¨tproxyå’Œfake-ipæ¨¡å¼
</span></span><span class=line><span class=cl>â”œâ”€â”€ clash.service           ---ğŸŸ¢systemd é…ç½®æ–‡ä»¶
</span></span><span class=line><span class=cl>â”œâ”€â”€ clean.sh                ---ğŸŸ¢æ¸…ç†iptablesçš„è„šæœ¬
</span></span><span class=line><span class=cl>â”œâ”€â”€ config.ini              ---ğŸŸ¢subconverterçš„é…ç½®æ–‡ä»¶
</span></span><span class=line><span class=cl>â”œâ”€â”€ iptables.sh             ---ğŸŸ¢iptablesé…ç½®æ–‡ä»¶
</span></span><span class=line><span class=cl>â”œâ”€â”€ update-config.sh        ---ğŸŸ¡è®¢é˜…æ›´æ–°è„šæœ¬; é¡»å°†&#34;XXXXXXXX&#34;æ›¿æ¢æˆä½ çš„è®¢é˜…åœ°å€
</span></span><span class=line><span class=cl>â”œâ”€â”€ config.yaml             ---â­•clash é…ç½®æ–‡ä»¶, é¡»ä»update-config.shç”Ÿæˆ
</span></span><span class=line><span class=cl>â”œâ”€â”€ README.md
</span></span><span class=line><span class=cl>â””â”€â”€ README.zh-cn.md
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ğŸŸ¢: æ— éœ€ä¿®æ”¹
</span></span><span class=line><span class=cl>ğŸŸ¡: éœ€è¦ä¿®æ”¹
</span></span><span class=line><span class=cl>â­•: éœ€è¦ç”Ÿæˆ
</span></span></code></pre></td></tr></table></div></div><h2 id=å‚è€ƒ>å‚è€ƒ</h2><p><a class=link href=https://www.sobyte.net/post/2022-02/clash-tproxy/ target=_blank rel=noopener>clash-tproxy</a></p><p><a class=link href=https://git.breakpoint.cc/cgit/fw/tcprdr.git target=_blank rel=noopener>Transparent proxy demo code</a></p><h2 id=å‡†å¤‡æ¡ä»¶>å‡†å¤‡æ¡ä»¶</h2><ul><li>å®‰è£…å¥½çš„ <code>clash</code> .(é»˜è®¤åœ¨ <code>/usr/bin/clash</code> è·¯å¾„ä¸‹)</li><li>iptables</li><li>systemd ï¼ˆä½ å®Œå…¨å¯ä»¥ä½¿ç”¨å…¶ä»–çš„å¯åŠ¨ç¨‹åºï¼Œè¿™ä¸è¿‡åœ¨è¿™é‡Œæˆ‘åªå±•ç¤ºsystemdçš„é…ç½®è¿‡ç¨‹ï¼Œå› ä¸ºå¤§å¤šæ•°GNU/Linuxå‘è¡Œç‰ˆé»˜è®¤ä½¿ç”¨systemdï¼‰</li><li>crontab</li></ul><h2 id=æ­¥éª¤>æ­¥éª¤</h2><h3 id=åˆ›å»ºä¸€ä¸ªåä¸ºclashçš„ç³»ç»Ÿç”¨æˆ·>åˆ›å»ºä¸€ä¸ªåä¸ºclashçš„ç³»ç»Ÿç”¨æˆ·</h3><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>useradd -r -M -s /usr/sbin/nologin clash
</span></span></code></pre></td></tr></table></div></div><p>ç”±äºæˆ‘ä»¬è¦åšå…¨å±€çš„é€æ˜ä»£ç†ï¼ˆä»£ç†ç½‘å¡ä¸Šçš„å…¨éƒ¨æµé‡ï¼‰ï¼Œæ‰€æœ‰æˆ‘ä»¬éœ€è¦é¿å…ä»£ç†è½¯ä»¶å‘å‡ºçš„æµé‡å†æ¬¡è¿›å…¥ä»£ç†è½¯ä»¶å½¢æˆå›è·¯æ— é™å¾ªç¯ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„ç”¨æˆ· <code>clash</code> (åå­—å¯ä»¥æ˜¯ä»»æ„çš„ï¼Œä½†è¦ä¸€è‡´) æ¥è¿è¡Œä»£ç†è½¯ä»¶ã€‚
ä¹‹åé€šè¿‡iptablesçš„è§„åˆ™å°† <code>clash</code> ç”¨æˆ·çš„æµé‡åˆ†ç¦»å‡ºæ¥ã€‚</p><h3 id=åˆ›å»ºiptableså’Œè·¯ç”±è§„åˆ™>åˆ›å»ºiptableså’Œè·¯ç”±è§„åˆ™</h3><p>åˆ›å»ºä¸€ä¸ªå†…å®¹æ˜¯iptableså‘½ä»¤çš„shellè„šæœ¬ <code>/etc/clash/iptables.sh</code>.</p><p>æ–‡ä»¶åŒ…å«ä¸‰ä¸ªä¸»è¦éƒ¨åˆ†ï¼š</p><ol><li>iptablesè§„åˆ™ç”¨äºåŠ«æŒDNSè¯·æ±‚æµé‡</li><li>PREROUTING ä¸­ <code>clash</code> é“¾çš„é…ç½®</li><li>OUTPUT ä¸­ <code>clash_local</code> é“¾çš„é…ç½®</li></ol><p>iptables ç¤ºæ„å›¾:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚         â”‚             PREROUTING                                                INPUT          â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                                                                                      â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚                                     â”‚         /â”€â”€â”€\        â”‚                    â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚ â”Œâ”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â” â”‚        /     \       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”œâ”€â”€â”¤â–ºâ”‚rawâ”œâ”€â–ºâ”‚conntrackâ”œâ”€â–ºâ”‚mangleâ”œâ”€â–ºâ”‚natâ”œâ”€â”¼â”€â”€â”€â”€â”€â”€â–º&lt;routing&gt;â”€â”€â”€â”€â”€â”€â”¤â–ºâ”‚mangleâ”œâ”€â–ºâ”‚filterâ”œâ”€â”¤â–ºâ”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚ â””â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”˜ â”‚        \     /       â”‚ â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚                                     â”‚         \â”€â”¬â”€/        â”‚                    â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                                                    â”‚                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                               â”‚          â”‚         â”‚                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                               â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚         â”‚                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                               â”‚ â”‚mangleâ—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚ Network â”‚                               â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚                                           â”‚  Local  â”‚
</span></span><span class=line><span class=cl>â”‚Interfaceâ”‚                               â”‚    â”‚     â”‚ FORWARD                                   â”‚ Process â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                               â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â” â”‚                                  /â”€â”€â”€\    â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¤filterâ”‚ â”‚                                 /     \   â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚               â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚                                &lt;routing&gt;â—„â”€â”¤         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚               â”‚               â”‚          â”‚                                 \     /   â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚               â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  \â”€â”¬â”€/    â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚               â”‚                                                               â”‚      â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â” â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚            â”‚    â”‚     â”€â”€â”€â”€â”€     â”‚                                          â”‚    â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚ â”Œâ”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â” â”‚    /     \    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ–¼â”€â”€â” â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚â—„â”€â”¼â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”œâ”€â”€â”€&lt;reroute&gt;â”€â”€â”€â”¼â”€â”¤filterâ”‚â—„â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”€â”¤conntrackâ”‚â—„â”€â”¤rawâ”‚ â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚ â””â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜ â”‚    \check/    â”‚ â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”˜ â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚                 â”‚     â”€â”€â”€â”€â”€     â”‚                                               â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚     POSTROUTING                                        OUTPUT                        â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                                                                                      â”‚         â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span></code></pre></td></tr></table></div></div><p><code>/etc/clash/iptables.sh</code> å†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>  1
</span><span class=lnt>  2
</span><span class=lnt>  3
</span><span class=lnt>  4
</span><span class=lnt>  5
</span><span class=lnt>  6
</span><span class=lnt>  7
</span><span class=lnt>  8
</span><span class=lnt>  9
</span><span class=lnt> 10
</span><span class=lnt> 11
</span><span class=lnt> 12
</span><span class=lnt> 13
</span><span class=lnt> 14
</span><span class=lnt> 15
</span><span class=lnt> 16
</span><span class=lnt> 17
</span><span class=lnt> 18
</span><span class=lnt> 19
</span><span class=lnt> 20
</span><span class=lnt> 21
</span><span class=lnt> 22
</span><span class=lnt> 23
</span><span class=lnt> 24
</span><span class=lnt> 25
</span><span class=lnt> 26
</span><span class=lnt> 27
</span><span class=lnt> 28
</span><span class=lnt> 29
</span><span class=lnt> 30
</span><span class=lnt> 31
</span><span class=lnt> 32
</span><span class=lnt> 33
</span><span class=lnt> 34
</span><span class=lnt> 35
</span><span class=lnt> 36
</span><span class=lnt> 37
</span><span class=lnt> 38
</span><span class=lnt> 39
</span><span class=lnt> 40
</span><span class=lnt> 41
</span><span class=lnt> 42
</span><span class=lnt> 43
</span><span class=lnt> 44
</span><span class=lnt> 45
</span><span class=lnt> 46
</span><span class=lnt> 47
</span><span class=lnt> 48
</span><span class=lnt> 49
</span><span class=lnt> 50
</span><span class=lnt> 51
</span><span class=lnt> 52
</span><span class=lnt> 53
</span><span class=lnt> 54
</span><span class=lnt> 55
</span><span class=lnt> 56
</span><span class=lnt> 57
</span><span class=lnt> 58
</span><span class=lnt> 59
</span><span class=lnt> 60
</span><span class=lnt> 61
</span><span class=lnt> 62
</span><span class=lnt> 63
</span><span class=lnt> 64
</span><span class=lnt> 65
</span><span class=lnt> 66
</span><span class=lnt> 67
</span><span class=lnt> 68
</span><span class=lnt> 69
</span><span class=lnt> 70
</span><span class=lnt> 71
</span><span class=lnt> 72
</span><span class=lnt> 73
</span><span class=lnt> 74
</span><span class=lnt> 75
</span><span class=lnt> 76
</span><span class=lnt> 77
</span><span class=lnt> 78
</span><span class=lnt> 79
</span><span class=lnt> 80
</span><span class=lnt> 81
</span><span class=lnt> 82
</span><span class=lnt> 83
</span><span class=lnt> 84
</span><span class=lnt> 85
</span><span class=lnt> 86
</span><span class=lnt> 87
</span><span class=lnt> 88
</span><span class=lnt> 89
</span><span class=lnt> 90
</span><span class=lnt> 91
</span><span class=lnt> 92
</span><span class=lnt> 93
</span><span class=lnt> 94
</span><span class=lnt> 95
</span><span class=lnt> 96
</span><span class=lnt> 97
</span><span class=lnt> 98
</span><span class=lnt> 99
</span><span class=lnt>100
</span><span class=lnt>101
</span><span class=lnt>102
</span><span class=lnt>103
</span><span class=lnt>104
</span><span class=lnt>105
</span><span class=lnt>106
</span><span class=lnt>107
</span><span class=lnt>108
</span><span class=lnt>109
</span><span class=lnt>110
</span><span class=lnt>111
</span><span class=lnt>112
</span><span class=lnt>113
</span><span class=lnt>114
</span><span class=lnt>115
</span><span class=lnt>116
</span><span class=lnt>117
</span><span class=lnt>118
</span><span class=lnt>119
</span><span class=lnt>120
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/usr/bin/env bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1># set -ex é€‰é¡¹è¯´æ˜:</span>
</span></span><span class=line><span class=cl><span class=c1># -e å½“æœ‰å‘½ä»¤ä»¥é0å€¼é€€å‡ºæ—¶ç«‹åˆ»ç»“æŸæ‰§è¡Œ</span>
</span></span><span class=line><span class=cl><span class=c1># -x å½“å‘½ä»¤æ‰§è¡Œæ—¶æ‰“å°å‘½ä»¤åŠå…¶å‚æ•°</span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -ex
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ENABLE ipv4 forward</span>
</span></span><span class=line><span class=cl>sysctl -w net.ipv4.ip_forward<span class=o>=</span><span class=m>1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ROUTE RULES</span>
</span></span><span class=line><span class=cl>ip rule add fwmark <span class=m>666</span> table <span class=m>666</span>
</span></span><span class=line><span class=cl>ip route add <span class=nb>local</span> 0.0.0.0/0 table <span class=m>666</span> dev lo
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##################################</span>
</span></span><span class=line><span class=cl><span class=c1>## hijack the dns query traffic ##</span>
</span></span><span class=line><span class=cl><span class=c1>##################################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è½¬å‘ä»å±€åŸŸç½‘æ”¶åˆ°çš„æ‰€æœ‰ DNS æŸ¥è¯¢æµé‡åˆ° 1053 ç«¯å£</span>
</span></span><span class=line><span class=cl><span class=c1># æ­¤æ“ä½œä¼šå¯¼è‡´æ‰€æœ‰ DNS è¯·æ±‚å…¨éƒ¨è¿”å›è™šå‡ IP(fake ip 198.18.0.1/16)</span>
</span></span><span class=line><span class=cl>iptables -t nat -I PREROUTING -p udp --dport <span class=m>53</span> -j REDIRECT --to <span class=m>1053</span>
</span></span><span class=line><span class=cl><span class=c1># ipv6 åŒæ ·é…ç½®</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -I PREROUTING -p udp --dport <span class=m>53</span> -j REDIRECT --to <span class=m>1053</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è½¬å‘ä»æ‰€æœ‰æœ¬æœºè¿›ç¨‹ï¼ˆé™¤å»uidä¸ºclashçš„è¿›ç¨‹ï¼‰æ”¶åˆ°çš„æ‰€æœ‰ DNS æŸ¥è¯¢æµé‡åˆ° 1053 ç«¯å£</span>
</span></span><span class=line><span class=cl><span class=c1># æ­¤æ“ä½œä¼šå¯¼è‡´æ‰€æœ‰ DNS è¯·æ±‚å…¨éƒ¨è¿”å›è™šå‡ IP(fake ip 198.18.0.1/16)</span>
</span></span><span class=line><span class=cl>iptables -t nat -N clash_dns
</span></span><span class=line><span class=cl>iptables -t nat -A OUTPUT -p udp --dport <span class=m>53</span> -j clash_dns
</span></span><span class=line><span class=cl>iptables -t nat -A clash_dns -m owner --uid-owner clash -j RETURN
</span></span><span class=line><span class=cl>iptables -t nat -A clash_dns -p udp -j REDIRECT --to-ports <span class=m>1053</span>
</span></span><span class=line><span class=cl><span class=c1># ipv6 åŒæ ·é…ç½®</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -N clash_dns
</span></span><span class=line><span class=cl>ip6tables -t nat -A OUTPUT -p udp --dport <span class=m>53</span> -j clash_dns
</span></span><span class=line><span class=cl>ip6tables -t nat -A clash_dns -m owner --uid-owner clash -j RETURN
</span></span><span class=line><span class=cl>ip6tables -t nat -A clash_dns -p udp -j REDIRECT --to-ports <span class=m>1053</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>##############################</span>
</span></span><span class=line><span class=cl><span class=c1>## config for `clash` chain ##</span>
</span></span><span class=line><span class=cl><span class=c1>##############################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># `clash` é“¾è´Ÿè´£åˆ©ç”¨tproxyå°†æµé‡è½¬å‘åˆ°clashçš„7893ç«¯å£</span>
</span></span><span class=line><span class=cl>iptables -t mangle -N clash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ç›®æ ‡åœ°å€ä¸ºå±€åŸŸç½‘æˆ–ä¿ç•™åœ°å€çš„æµé‡è·³è¿‡å¤„ç†</span>
</span></span><span class=line><span class=cl><span class=c1># ä¿ç•™åœ°å€å‚è€ƒ:</span>
</span></span><span class=line><span class=cl><span class=c1># https://zh.wikipedia.org/wiki/%E5%B7%B2%E5%88%86%E9%85%8D%E7%9A%84/8_IPv4%E5%9C%B0%E5%9D%80%E5%9D%97%E5%88%97%E8%A1%A8</span>
</span></span><span class=line><span class=cl><span class=c1># https://zh.wikipedia.org/wiki/%E4%B8%93%E7%94%A8%E7%BD%91%E7%BB%9C</span>
</span></span><span class=line><span class=cl><span class=c1># IANA - Local Identification</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 0.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl><span class=c1># IANA - Loopback</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 127.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl><span class=c1># IANA - Private Use</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 10.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 172.16.0.0/12 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 192.168.0.0/16 -j RETURN
</span></span><span class=line><span class=cl><span class=c1># IPv4 Link-Local Addresses</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 169.254.0.0/16 -j RETURN
</span></span><span class=line><span class=cl><span class=c1># Multicast</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 224.0.0.0/4 -j RETURN
</span></span><span class=line><span class=cl><span class=c1># Future Use</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -d 240.0.0.0/4 -j RETURN
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å…¶ä»–æ‰€æœ‰æµé‡è½¬å‘åˆ° 7893 ç«¯å£ï¼Œå¹¶æ‰“ä¸Š mark</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -p tcp -j TPROXY --on-port <span class=m>7893</span> --tproxy-mark <span class=m>666</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash -p udp -j TPROXY --on-port <span class=m>7893</span> --tproxy-mark <span class=m>666</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å°† `clash` é“¾åŠ åœ¨PREROUTINGé“¾åé¢ä½¿å…¶ç”Ÿæ•ˆ</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A PREROUTING -j clash
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>####################################</span>
</span></span><span class=line><span class=cl><span class=c1>## config for `clash_local` chain ##</span>
</span></span><span class=line><span class=cl><span class=c1>####################################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># `clash_local` é“¾è´Ÿè´£å¤„ç†æœ¬æœºçš„æœ¬åœ°è¿›ç¨‹å‘å‡ºçš„æµé‡ï¼šç»™å‘å¾€å…¬ç½‘çš„æµé‡æ‰“ä¸Š666æ ‡è®°</span>
</span></span><span class=line><span class=cl><span class=c1># (ä¹‹åä¼šrerouteç»™loè®¾å¤‡ï¼Œç„¶åä¼šåœ¨PREROUTINGä¸­çš„clashé“¾ä¸Šè½¬å‘åˆ°tproxy 7893ç«¯å£)</span>
</span></span><span class=line><span class=cl>iptables -t mangle -N clash_local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># nerdctl å®¹å™¨æµé‡é‡æ–°è·¯ç”±</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t mangle -A clash_local -i nerdctl2 -p udp -j MARK --set-mark 666</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t mangle -A clash_local -i nerdctl2 -p tcp -j MARK --set-mark 666</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è·³è¿‡å†…ç½‘æµé‡</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 0.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 127.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 10.0.0.0/8 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 172.16.0.0/12 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 192.168.0.0/16 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 169.254.0.0/16 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 224.0.0.0/4 -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -d 240.0.0.0/4 -j RETURN
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä¸ºæœ¬æœºå‘å‡ºçš„æµé‡æ‰“ mark</span>
</span></span><span class=line><span class=cl><span class=c1># clash_local é“¾ä¼šä¸ºæœ¬æœºæµé‡æ‰“ mark, æ‰“è¿‡ mark çš„æµé‡ä¼šé‡æ–°å›åˆ°device loï¼Œå†ä»PREROUTINGå¼€å§‹èµ°æµç¨‹.</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -p tcp -j MARK --set-mark <span class=m>666</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A clash_local -p udp -j MARK --set-mark <span class=m>666</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è·³è¿‡æ¥è‡ªæœåŠ¡ç«¯å£çš„æµé‡</span>
</span></span><span class=line><span class=cl><span class=c1># https web server</span>
</span></span><span class=line><span class=cl><span class=c1># iptables -t mangle -I OUTPUT -p tcp --sport 443 -j RETURN</span>
</span></span><span class=line><span class=cl><span class=c1># transmission</span>
</span></span><span class=line><span class=cl><span class=c1># iptables -t mangle -I OUTPUT -p tcp --sport 51413 -j RETURN</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># è·³è¿‡ clash ç¨‹åºæœ¬èº«å‘å‡ºçš„æµé‡, é˜²æ­¢æ­»å¾ªç¯(clash ç¨‹åºéœ€è¦ä½¿ç”¨ &#34;clash&#34; ç”¨æˆ·å¯åŠ¨)</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A OUTPUT -p tcp -m owner --uid-owner clash -j RETURN
</span></span><span class=line><span class=cl>iptables -t mangle -A OUTPUT -p udp -m owner --uid-owner clash -j RETURN
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># å°† `clash_local` é“¾åŠ åœ¨ OUTPUT é“¾åé¢ä½¿å…¶ç”Ÿæ•ˆ</span>
</span></span><span class=line><span class=cl>iptables -t mangle -A OUTPUT -j clash_local
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#######################</span>
</span></span><span class=line><span class=cl><span class=c1>## unimportant staff ##</span>
</span></span><span class=line><span class=cl><span class=c1>#######################</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># ä¿®å¤ ICMP(ping)</span>
</span></span><span class=line><span class=cl><span class=c1># è¿™å¹¶ä¸èƒ½ä¿è¯ ping ç»“æœæœ‰æ•ˆ(clash ç­‰ä¸æ”¯æŒè½¬å‘ ICMP), åªæ˜¯è®©å®ƒæœ‰è¿”å›ç»“æœè€Œå·²</span>
</span></span><span class=line><span class=cl><span class=c1># --to-destination è®¾ç½®ä¸ºä¸€ä¸ªå¯è¾¾çš„åœ°å€å³å¯</span>
</span></span><span class=line><span class=cl><span class=c1>#sysctl -w net.ipv4.conf.all.route_localnet=1</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t nat -A PREROUTING -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t nat -A OUTPUT -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1</span>
</span></span></code></pre></td></tr></table></div></div><p>å½“æ‰§è¡Œå®Œä¸Šè¿°è„šæœ¬åï¼Œiptablesçš„çŠ¶æ€å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span><span class=lnt>29
</span><span class=lnt>30
</span><span class=lnt>31
</span><span class=lnt>32
</span><span class=lnt>33
</span><span class=lnt>34
</span><span class=lnt>35
</span><span class=lnt>36
</span><span class=lnt>37
</span><span class=lnt>38
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
</span></span><span class=line><span class=cl>â”‚         â”‚             PREROUTING           rule1*                               INPUT          â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                                    â”‚                                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚                                 â”‚   â”‚         /â”€â”€â”€\        â”‚                    â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚ â”Œâ”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”´â”€â” â”‚        /     \       â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â” â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”œâ”€â”€â”¤â–ºâ”‚rawâ”œâ”€â–ºâ”‚conntrackâ”œâ”€â–ºâ”‚mangleâ”œâ”€â–ºâ”‚natâ”œâ”€â”¼â”€â”€â”€â”€â”€â”€â–º&lt;routing&gt;â”€â”€â”€â”€â”€â”€â”¤â–ºâ”‚mangleâ”œâ”€â–ºâ”‚filterâ”œâ”€â”¤â–ºâ”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚ â””â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”˜ â”‚        \     /       â”‚ â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚                      â”‚              â”‚         \â”€â”¬â”€/        â”‚                    â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                         â”‚                          â”‚                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                      â”Œâ”€â”€â”´â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                      â”‚clashâ”‚  â”‚          â”‚         â”‚                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                      â””â”€â”€â”€â”€â”€â”˜  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â” â”‚         â”‚                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                               â”‚ â”‚mangleâ—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚ Network â”‚                               â”‚ â””â”€â”€â”¬â”€â”€â”€â”˜ â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚  Local  â”‚
</span></span><span class=line><span class=cl>â”‚Interfaceâ”‚                               â”‚    â”‚     â”‚ FORWARD      â”‚clash_localâ”‚                â”‚ Process â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                               â”‚ â”Œâ”€â”€â–¼â”€â”€â”€â” â”‚              â””â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       /â”€â”€â”€\    â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”¤filterâ”‚ â”‚                â”‚                /     \   â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚               â”‚               â”‚ â””â”€â”€â”€â”€â”€â”€â”˜ â”‚                â”œâ”€â”€â”€rule3*      &lt;routing&gt;â—„â”€â”¤         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚               â”‚               â”‚          â”‚                â”‚                \     /   â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚               â”‚               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”œâ”€â”€â”€rule2*        \â”€â”¬â”€/    â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚               â”‚                                           â”‚                   â”‚      â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â” â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚            â”‚    â”‚     â”€â”€â”€â”€â”€     â”‚                      â”‚                   â”‚    â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚ â”Œâ”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â” â”‚    /     \    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”  â”Œâ”€â”€â”€â”´â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ–¼â”€â”€â” â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚â—„â”€â”¼â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”œâ”€â”€â”€&lt;reroute&gt;â”€â”€â”€â”¼â”€â”¤filterâ”‚â—„â”€â”¤natâ”‚â—„â”€â”¤mangleâ”‚â—„â”€â”¤conntrackâ”‚â—„â”€â”¤rawâ”‚ â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚ â””â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜ â”‚    \check/    â”‚ â””â”€â”€â”€â”€â”€â”€â”˜  â””â”¬â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”˜ â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â”‚                 â”‚     â”€â”€â”€â”€â”€     â”‚            â”‚                                  â”‚ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚     POSTROUTING                                 â”‚      OUTPUT                        â”‚         â”‚
</span></span><span class=line><span class=cl>â”‚         â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”                                 â”‚         â”‚
</span></span><span class=line><span class=cl>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                          â”‚clash_dnsâ”‚                                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class=line><span class=cl>                                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl> *rule1: iptables -t nat -I PREROUTING -p udp --dport 53 -j REDIRECT --to 1053
</span></span><span class=line><span class=cl> *rule2: iptables -t mangle -A OUTPUT -p tcp -m owner --uid-owner clash -j RETURN
</span></span><span class=line><span class=cl> *rule3: iptables -t mangle -A OUTPUT -p udp -m owner --uid-owner clash -j RETURN
</span></span></code></pre></td></tr></table></div></div><p>ç ”ç©¶ä¸€ä¸‹ <code>iptables.sh</code> ä¸­çš„è·¯ç”±è§„åˆ™:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>ip rule add fwmark <span class=m>666</span> table <span class=m>666</span>
</span></span><span class=line><span class=cl>ip route add <span class=nb>local</span> 0.0.0.0/0 table <span class=m>666</span> dev lo
</span></span></code></pre></td></tr></table></div></div><p><code>ip rule</code> ç”¨äºæ§åˆ¶ç­–ç•¥è·¯ç”±æ•°æ®åº“ï¼Œç®¡ç†ç­–ç•¥è·¯ç”±çš„è·¯ç”±é€‰æ‹©ç®—æ³•</p><p>è¿™é‡Œ <code>ip rule</code> å‘½ä»¤è®©å†…æ ¸å¯¹æ ‡è®°æœ‰666çš„æ•°æ®åŒ…æŸ¥æ‰¾666å·è·¯ç”±è¡¨</p><p><a class=link href=http://linux-ip.net/html/tools-ip-rule.html target=_blank rel=noopener>ip rule å‚è€ƒæ–‡æ¡£</a></p><p><code>ip route</code> å‘½ä»¤åœ¨666å·è·¯ç”±è¡¨ä¸­æ·»åŠ äº†ä¸€æ¡åˆ°loè®¾å¤‡çš„é»˜è®¤è·¯ç”±</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ <code>ip route show table 666</code> æ¥æŸ¥çœ‹ <code>ip route add local 0.0.0.0/0 table 666 dev lo</code> æ·»åŠ çš„è·¯ç”±é¡¹</p><p>æŸ¥çœ‹è·¯ç”±è¡¨ç¼–å·å’Œåç§°çš„æ˜ å°„ï¼š
<code>cat /etc/iproute2/rt_tables</code></p><h3 id=åˆ›å»ºè§„åˆ™æ¸…ç†è„šæœ¬>åˆ›å»ºè§„åˆ™æ¸…ç†è„šæœ¬</h3><p>åœ¨é€€å‡ºclashåéœ€æ¸…é™¤è®¾å®šçš„è§„åˆ™</p><p><code>-D</code> æˆ– <code>--delete</code>:</p><p>ä»æ‰€é€‰é“¾ä¸­åˆ æ‰ä¸€æ¡æˆ–å¤šæ¡è§„åˆ™ã€‚
å¯ä»¥æŒ‡å®šè¦åˆ é™¤çš„è§„åˆ™å·ï¼›æˆ–æŒ‡å®šè§„åˆ™å†…å®¹ï¼ˆå°† <code>-A</code>ã€<code>-I</code> æ›¿æ¢æˆ <code>-D</code> å³å¯ï¼‰</p><p><code>-F</code> or <code>--flush</code>:</p><p>åˆ·æ–°æ‰€é€‰é“¾ï¼Œç›¸å½“äºé€æ¡æ¸…é™¤é“¾ä¸Šçš„æ‰€æœ‰è§„åˆ™</p><p><code>-X</code> or <code>--delete-chain</code>:</p><p>åˆ é™¤ç”¨æˆ·å®šä¹‰çš„é“¾</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/env bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=nb>set</span> -ex
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>ip rule del fwmark <span class=m>666</span> table <span class=m>666</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip route del <span class=nb>local</span> 0.0.0.0/0 table <span class=m>666</span> dev lo <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>iptables -t nat -D PREROUTING -p udp --dport <span class=m>53</span> -j REDIRECT --to <span class=m>1053</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -D PREROUTING -p udp --dport <span class=m>53</span> -j REDIRECT --to <span class=m>1053</span> <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t nat -D OUTPUT -p udp --dport <span class=m>53</span> -j clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -D OUTPUT -p udp --dport <span class=m>53</span> -j clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t nat -F clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t nat -X clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -F clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>ip6tables -t nat -X clash_dns <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t nat -D PREROUTING -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1</span>
</span></span><span class=line><span class=cl><span class=c1>#iptables -t nat -D OUTPUT -p icmp -d 198.18.0.0/16 -j DNAT --to-destination 127.0.0.1</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>iptables -t mangle -D PREROUTING -j clash <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -F clash <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -X clash <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>iptables -t mangle -D OUTPUT -p tcp -m owner --uid-owner clash -j RETURN <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -D OUTPUT -p udp -m owner --uid-owner clash -j RETURN <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -D OUTPUT -j clash_local <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -F clash_local <span class=o>||</span> <span class=nb>true</span>
</span></span><span class=line><span class=cl>iptables -t mangle -X clash_local <span class=o>||</span> <span class=nb>true</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=ä¿®æ­£ping>ä¿®æ­£ping</h3><p>fake-ip æ¨¡å¼çš„ä¸€ä¸ªä¸»è¦ç¼ºç‚¹æ˜¯æ— æ³•ping</p><p>å‰é¢ <code>iptables.sh</code> ä¸­å°†æ‰€æœ‰pingè¯·æ±‚é‡å®šå‘åˆ°127.0.0.1 çš„æ“ä½œæ˜¯æ©è€³ç›—é“ƒçš„ï¼Œå®ƒä¸æä¾›ä»»ä½•ä¿¡æ¯ã€‚</p><p>ä½†æ˜¯ï¼Œå¯ä»¥é€šè¿‡clashç”¨æˆ·çš„èº«ä»½è¿›è¡Œping</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=nb>alias</span> <span class=nv>ping</span><span class=o>=</span><span class=s2>&#34;sudo -u clash ping&#34;</span>
</span></span></code></pre></td></tr></table></div></div><h3 id=æä¾›systemd-unit-file-ä»¥ä¸€é”®å¯åŠ¨clashåŠç›¸å…³iptablesç­‰é…ç½®>æä¾›systemd unit file ä»¥ä¸€é”®å¯åŠ¨clashåŠç›¸å…³iptablesç­‰é…ç½®</h3><p>æ­¤æ­¥éª¤æ˜¯å¯é€‰çš„ï¼Œä½†æˆ‘è§‰å¾—èƒ½å¤Ÿä¸€é”®å¯åŠ¨/å…³é—­clashå¾ˆæ–¹ä¾¿ã€‚</p><p>åŒæ—¶ä¹Ÿå¯ä»¥è®¾ç½®clashå¼€æœºå¯åŠ¨ã€‚</p><p>Systemd é…ç½®æ–‡ä»¶å‘½åä¸º<code>clash.service</code> ï¼Œæ”¾åœ¨ <code>/usr/lib/systemd/system</code> ç›®å½•ä¸‹ï¼Œæ‰§è¡Œ <code>sudo systemctl start clash</code> æ¥å¯åŠ¨è¿è¡Œclash</p><p>å¼€æœºå¯åŠ¨ï¼š <code>sudo systemctl enable clash</code>.</p><h3 id=é…ç½®clash>é…ç½®clash</h3><p>ä¸‹é¢çœ‹ä¸€çœ‹å¯¹clashæœ¬èº«çš„é…ç½®</p><p>clash ä½¿ç”¨ <code>-d</code> é€‰é¡¹å¾—åˆ°é…ç½®æ–‡ä»¶ç›®å½•ï¼› <code>-f</code> é€‰é¡¹å¾—åˆ°é…ç½®æ–‡ä»¶</p><p>å½“ <code>-f</code> è¢«å¿½ç•¥æ—¶ï¼Œé»˜è®¤çš„é…ç½®æ–‡ä»¶åæ˜¯ <code>config.yaml</code></p><p>æˆ‘ä»¬æƒ³è¦é€šè¿‡ <code>crontab</code> ä»clashçš„è®¢é˜…é“¾æ¥ä¸­å®šæ—¶æ›´æ–°clashçš„é…ç½®æ–‡ä»¶</p><h4 id=æ„é€ è®¢é˜…è¿æ¥>æ„é€ è®¢é˜…è¿æ¥</h4><p>TL;DR. å°†ä¸‹é¢URLä¸­<code>XXXXXXXX</code> æ›¿æ¢æˆ<a class=link href=https://www.urlencoder.io/ target=_blank rel=noopener>URL Encodeåçš„</a>èŠ‚ç‚¹è®¢é˜…URLå³å¯</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>https://sub.xeton.dev/sub?target=clash&amp;new_name=true&amp;filename=config.yaml&amp;url=XXXXXXXX&amp;config=https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini
</span></span></code></pre></td></tr></table></div></div><p>æˆ‘ä»¬é€šè¿‡<a class=link href=https://github.com/tindy2013/subconverter target=_blank rel=noopener>subconverter</a>æ¥ç”Ÿæˆclashçš„é…ç½®æ–‡ä»¶ã€‚</p><p>ä½ éœ€è¦ä¿®æ”¹è®¢é˜…é“¾æ¥ä¸­çš„ä¸€äº›å‚æ•°ä»¥ä½¿å¾—ç”Ÿæˆçš„clashæ­£ç¡®é…ç½®æˆ <strong>ç›‘å¬tproxy</strong> ä»¥åŠ <strong>fake-ip</strong> æ¨¡å¼</p><p>å…·ä½“çš„ï¼š</p><ol><li><code>url</code> å‚æ•°è¦æ˜¯æ­£ç¡®çš„èŠ‚ç‚¹ä¿¡æ¯å¹¶ä¸”ç»è¿‡<a class=link href=https://www.urlencoder.io/ target=_blank rel=noopener>URL Encode</a>.</li><li>å¤šä¸ªèŠ‚ç‚¹è®¢é˜…URLè¦ç”¨ <code>|</code> åˆ†å‰², æ­¤ç¬¦å·<a class=link href=https://www.urlencoder.io/ target=_blank rel=noopener>URL Encode</a> ä¹‹åæ˜¯ <code>%7C</code> .</li><li><code>config</code> å‚æ•°æ˜¯ç”¨äºå‘Šè¯‰subconverterå¦‚ä½•è¿›è¡Œè®¢é˜…è½¬æ¢çš„å…³é”®ï¼Œåº”å½“<a class=link href=https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/config.ini target=_blank rel=noopener>é…ç½®æ­£ç¡®</a>. âš ï¸</li></ol><p>âš ï¸ æ³¨æ„: è¿™é‡Œsubconverter çš„é…ç½®æ–‡ä»¶éå¸¸é‡è¦</p><p><a class=link href=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini target=_blank rel=noopener>ACL4SSR é¡¹ç›®æä¾›äº†ä¸€ä¸ªé»˜è®¤çš„subconverteré…ç½®æ–‡ä»¶</a>ï¼Œè¿™ä¸ªæ–‡ä»¶æ²¡é—®é¢˜ï¼Œä½†é»˜è®¤çš„é€‰é¡¹ä¸è¶³ä»¥è®©clashå¼€å¯fake-ipæ¨¡å¼å¹¶ç›‘å¬tproxy</p><p>è¦æƒ³ä½¿å…¶å·¥ä½œï¼Œéœ€æŒ‡å®š <code>clash_rule_base</code>ï¼š åœ¨<a class=link href=https://raw.githubusercontent.com/ACL4SSR/ACL4SSR/master/Clash/config/ACL4SSR_Online.ini target=_blank rel=noopener>å…¶</a>ä¸­æ’å…¥ä¸‹é¢è¿™ä¸€è¡Œ</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>clash_rule_base=https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/clash-base-config.yaml
</span></span></code></pre></td></tr></table></div></div><p>è¿™ä¸€è¡Œçš„ä½œç”¨æ˜¯å‘Šè¯‰subconverterä½¿ç”¨<a class=link href=https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/clash-base-config.yaml target=_blank rel=noopener>URLä¸­çš„æ–‡ä»¶</a>ä½œä¸ºclashçš„åŸºç¡€é…ç½®</p><p>æˆ–è€…ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨<a class=link href=https://gist.githubusercontent.com/cld4h/9a03ec2f826a25be5ab974fdbc540de4/raw/config.ini target=_blank rel=noopener>æˆ‘çš„config.ini</a></p><p>ç¤ºä¾‹URL:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-txt data-lang=txt><span class=line><span class=cl>https://sub.xeton.dev/sub?        --- åç«¯åœ°å€
</span></span><span class=line><span class=cl>target=clash                      --- å®¢æˆ·ç«¯ç±»å‹
</span></span><span class=line><span class=cl>&amp;new_name=true                    --- é‡å‘½å
</span></span><span class=line><span class=cl>&amp;filename=config.yaml             --- æ–‡ä»¶å
</span></span><span class=line><span class=cl>&amp;url=                             --- èŠ‚ç‚¹ä¿¡æ¯
</span></span><span class=line><span class=cl>ss%3A%2F%2FYmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg%23example-server
</span></span><span class=line><span class=cl>%7C                               --- åˆ†éš”ç¬¦ |
</span></span><span class=line><span class=cl>ss%3A%2F%2FYmYtY2ZiOnRlc3QvIUAjOkAxOTIuMTY4LjEwMC4xOjg4ODg%23example-server-2
</span></span><span class=line><span class=cl>&amp;config=                          --- subconverterçš„é…ç½®æ–‡ä»¶; .ini æ ¼å¼
</span></span><span class=line><span class=cl>https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini
</span></span><span class=line><span class=cl>                                  --- ä¸‹é¢è¿™äº›é…ç½®æ˜¯å¤šä½™çš„ï¼Œæ²¡å•¥ç”¨
</span></span><span class=line><span class=cl>&amp;list=false                       --- ç”¨äºè¾“å‡º Surge Node List æˆ–è€… Clash Proxy Provider æˆ–è€… Quantumult (X) çš„èŠ‚ç‚¹è®¢é˜… æˆ–è€… è§£ç åçš„ SIP002
</span></span><span class=line><span class=cl>&amp;tfo=false                        --- ç”¨äºå¼€å¯è¯¥è®¢é˜…é“¾æ¥çš„ TCP Fast Openï¼Œé»˜è®¤ä¸º false
</span></span><span class=line><span class=cl>&amp;scv=false                        --- ç”¨äºå…³é—­ TLS èŠ‚ç‚¹çš„è¯ä¹¦æ£€æŸ¥ï¼Œé»˜è®¤ä¸º false
</span></span><span class=line><span class=cl>&amp;fdn=false                        --- ç”¨äºè¿‡æ»¤ç›®æ ‡ç±»å‹ä¸æ”¯æŒçš„èŠ‚ç‚¹ï¼Œé»˜è®¤ä¸º true
</span></span><span class=line><span class=cl>&amp;sort=false                       --- ç”¨äºå¯¹è¾“å‡ºçš„èŠ‚ç‚¹æˆ–ç­–ç•¥ç»„æŒ‰èŠ‚ç‚¹åè¿›è¡Œå†æ¬¡æ’åºï¼Œé»˜è®¤ä¸º false
</span></span></code></pre></td></tr></table></div></div><h4 id=è®¾ç½®å®šæ—¶æ›´æ–°è®¢é˜…ä»»åŠ¡>è®¾ç½®å®šæ—¶æ›´æ–°è®¢é˜…ä»»åŠ¡</h4><p>åˆ›å»ºè®¢é˜…æ›´æ–°è„šæœ¬ <code>/etc/clash/update-config.sh</code> ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=cp>#!/usr/bin/env bash
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=nb>set</span> -ex
</span></span><span class=line><span class=cl>/usr/bin/curl <span class=s2>&#34;https://sub.xeton.dev/sub?target=clash&amp;new_name=true&amp;filename=config.yaml&amp;url=XXXXXXXX&amp;config=https%3A%2F%2Fgist.githubusercontent.com%2Fcld4h%2F9a03ec2f826a25be5ab974fdbc540de4%2Fraw%2Fconfig.ini&#34;</span> -o /etc/clash/config.yaml
</span></span></code></pre></td></tr></table></div></div><p>âš ï¸ ä¸Šé¢çš„URLè¦æ›¿æ¢ä¸€ä¸‹</p><p>æ‰‹åŠ¨æ‰§è¡Œä¸€ä¸‹ä¸Šè¿°è„šæœ¬ç¡®è®¤é…ç½®æ–‡ä»¶èƒ½å¤Ÿæ­£å¸¸ç”Ÿæˆã€‚</p><p>ç¡®ä¿ä½ çš„clash<code>config.yaml</code>é…ç½®æ–‡ä»¶ä¸­æœ‰å¦‚ä¸‹å†…å®¹ï¼š</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-yaml data-lang=yaml><span class=line><span class=cl><span class=nt>tproxy-port</span><span class=p>:</span><span class=w> </span><span class=m>7893</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nt>dns</span><span class=p>:</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enable</span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>listen</span><span class=p>:</span><span class=w> </span><span class=m>0.0.0.0</span><span class=p>:</span><span class=m>1053</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>enhanced-mode</span><span class=p>:</span><span class=w> </span><span class=l>fake-ip</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>  </span><span class=nt>fake-ip-range</span><span class=p>:</span><span class=w> </span><span class=m>198.18.0.1</span><span class=l>/16</span><span class=w>
</span></span></span></code></pre></td></tr></table></div></div><p>æ·»åŠ <a class=link href=https://crontab.guru target=_blank rel=noopener>å®šæ—¶ä»»åŠ¡</a>ï¼š æ‰§è¡Œ <code>sudo crontab -e</code> å¹¶åŠ å…¥ä¸‹é¢è¿™ä¸€è¡Œä»¥åœ¨æ¯å¤©æ—©ä¸Š10:00æ‰§è¡Œè®¢é˜…æ›´æ–°è„šæœ¬ã€‚</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl><span class=m>0</span> <span class=m>10</span> * * * /usr/bin/bash /etc/clash/update-config.sh
</span></span></code></pre></td></tr></table></div></div></section><footer class=article-footer><section class=article-tags><a href=/blog/zh-cn/tags/clash/>Clash</a>
<a href=/blog/zh-cn/tags/tproxy/>Tproxy</a>
<a href=/blog/zh-cn/tags/linux/>Linux</a>
<a href=/blog/zh-cn/tags/gfw/>GFW</a>
<a href=/blog/zh-cn/tags/fake-ip/>Fake-Ip</a>
<a href=/blog/zh-cn/tags/%E9%80%8F%E6%98%8E%E4%BB%A3%E7%90%86/>é€æ˜ä»£ç†</a>
<a href=/blog/zh-cn/tags/%E7%BF%BB%E5%A2%99/>ç¿»å¢™</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css integrity=sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI+WdtXRGWt2kTvGFasHpSy3SV crossorigin=anonymous><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js integrity=sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG+vnGctmUb0ZY0l8 crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js integrity=sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05 crossorigin=anonymous defer></script><script>window.addEventListener("DOMContentLoaded",()=>{renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1},{left:"\\[",right:"\\]",display:!0}],ignoredClasses:["gist"]})})</script></article><footer class=site-footer><section class=copyright>&copy;
2019 -
2025 cld4h çš„åšå®¢</section><section class=powerby>ä½¿ç”¨ <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> æ„å»º<br>ä¸»é¢˜ <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.26.0>Stack</a></b> ç”± <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a> è®¾è®¡</section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/blog/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>